<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HR SaaS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:#f3f4f6}
header{background:#0f172a;color:#fff;padding:16px 24px;display:flex;justify-content:space-between}
.badge{background:#1e293b;padding:6px 12px;border-radius:999px;font-size:12px}
.container{max-width:1400px;margin:20px auto;padding:0 20px;display:none}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:20px}
table{width:100%;border-collapse:collapse;margin-top:15px}
th{background:#0f172a;color:#fff;padding:8px;font-size:13px}
td{padding:8px;border-bottom:1px solid #eee;text-align:center}
td:first-child{text-align:left}
.clickable{cursor:pointer;color:#2563eb;font-weight:bold}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;padding:20px;border-radius:16px;width:700px;max-height:80vh;overflow:auto}
.loginModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
.loginBox{background:#fff;padding:20px;border-radius:16px;width:300px}
.loginBox input{width:100%;padding:8px;margin-bottom:10px}
button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
</style>
</head>

<body>

<header>
  <div>HR SaaS</div>
  <div>
    <span id="roleBadge" class="badge">Not logged in</span>
    <button id="logoutBtn" style="display:none">Logout</button>
  </div>
</header>

<div class="container" id="mainApp">

  <div class="card">
    <h3>团队统计图</h3>
    <canvas id="teamChart"></canvas>
  </div>

  <div class="card">
    <h3>团队统计表（点击数字查看员工）</h3>
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>

<!-- LOGIN -->
<div id="loginModal" class="loginModal">
  <div class="loginBox">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button class="btn-primary" style="width:100%" onclick="login()">Login</button>
    <div id="loginMsg" style="color:red;margin-top:8px"></div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal">
  <div class="modal-box">
    <h3 id="detailTitle"></h3>
    <div id="detailContent"></div>
    <br>
    <button onclick="closeDetail()">Close</button>
  </div>
</div>

<script>

const SUPABASE_URL="https://mxeqccecqkyllwvbylej.supabase.co";
const SUPABASE_KEY="sb_publishable_UWUWJaWHxVxZPnkm62sypQ_QU2pw2CR";

const supa=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const sheetAPI="https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/团队填表";

let sheetData=[];
let chart;

/* ================= AUTH ================= */

async function checkSession(){
  const {data:{session}}=await supa.auth.getSession();
  if(session){
    showApp();
  }else{
    showLogin();
  }
}

async function login(){
  const {error}=await supa.auth.signInWithPassword({
    email:email.value,
    password:password.value
  });

  if(error){
    loginMsg.innerText="Invalid login credentials";
    return;
  }

  showApp();
}

async function logout(){
  await supa.auth.signOut();
  location.reload();
}

function showApp(){
  loginModal.style.display="none";
  mainApp.style.display="block";
  roleBadge.innerText="Logged in";
  logoutBtn.style.display="inline-block";
  loadSheet();
}

function showLogin(){
  loginModal.style.display="flex";
  mainApp.style.display="none";
}

logoutBtn.onclick=logout;

/* ================= LOAD SHEET ================= */

async function loadSheet(){
  const res=await fetch(sheetAPI);
  sheetData=await res.json();

  renderTable();
  renderChart();
}

/* ================= TABLE ================= */

function renderTable(){

  if(sheetData.length===0) return;

  const headers=Object.keys(sheetData[0]);

  tableHead.innerHTML="<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";

  tableBody.innerHTML=sheetData.map(row=>{
    return "<tr>"+headers.map(h=>{
      const value=row[h]||0;
      if(h!=="团队统计" && h!=="现场培训" && h!=="线上培训"){
        return `<td class="clickable" onclick="showDetail('${row["团队统计"]}','${h}')">${value}</td>`;
      }
      return `<td>${value}</td>`;
    }).join("")+"</tr>";
  }).join("");
}

/* ================= CHART ================= */

function renderChart(){

  const labels=sheetData.map(r=>r["团队统计"]);
  const totals=sheetData.map(r=>Number(r["总人数"]||0));

  if(chart) chart.destroy();

  chart=new Chart(teamChart,{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        label:"总人数",
        data:totals
      }]
    },
    options:{
      onClick:(e, elements)=>{
        if(elements.length>0){
          const index=elements[0].index;
          const team=labels[index];
          showDetail(team,"总人数");
        }
      }
    }
  });
}

/* ================= DETAIL ================= */

function showDetail(team, field){
  detailTitle.innerText=team+" - "+field;
  detailContent.innerHTML="<p>这里可以接员工明细表数据</p>";
  detailModal.style.display="flex";
}

function closeDetail(){
  detailModal.style.display="none";
}

checkSession();

</script>

</body>
</html>
