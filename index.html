<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>HR Dashboard (Public)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg1:#eef2ff;
  --bg2:#f0f9ff;
  --bg3:#f8fafc;
  --ink:#0f172a;
  --muted:#64748b;
  --card:#ffffff;
  --line:#e2e8f0;
  --brand:#2563eb;
  --dark:#0b1220;
  --pill:#f1f5f9;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{
  margin:0;color:var(--ink);
  background: radial-gradient(900px 500px at 10% 10%, var(--bg1), transparent 70%),
              radial-gradient(900px 500px at 90% 20%, var(--bg2), transparent 70%),
              linear-gradient(180deg, #fbfdff 0%, var(--bg3) 100%);
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(11,18,32,.92);backdrop-filter: blur(10px);
  color:#fff;padding:14px 22px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.08)
}
header .left{display:flex;gap:10px;align-items:center}
.badge{
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.16);
  padding:6px 12px;border-radius:999px;
  font-size:12px;color:#e2e8f0
}
.container{max-width:1250px;margin:20px auto;padding:0 18px}
.tabs{display:flex;gap:10px;margin-bottom:14px}
.tab{
  padding:8px 16px;border-radius:999px;cursor:pointer;
  background:rgba(15,23,42,.06);font-weight:800;color:#0f172a;
  border:1px solid rgba(15,23,42,.06)
}
.tab.active{background:var(--dark);color:#fff;border-color:rgba(255,255,255,.06)}
.card{
  background:rgba(255,255,255,.9);
  border:1px solid rgba(15,23,42,.06);
  border-radius:20px;padding:18px;
  box-shadow:0 10px 26px rgba(15,23,42,.06);
}
.h2{margin:0 0 6px 0;font-size:22px;font-weight:900}
.muted{color:var(--muted);font-weight:600}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:16px 0}
.kpiBox{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.06);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 26px rgba(15,23,42,.06);
}
.kpiBox .label{color:var(--muted);font-weight:800}
.kpiBox .value{font-size:28px;font-weight:950;margin-top:6px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.sectionTitle{font-size:16px;font-weight:950;margin:0 0 10px 0}
.flexWrap{display:flex;flex-wrap:wrap;gap:12px}
.miniCard{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.06);
  border-radius:18px;padding:14px;min-width:170px;
  box-shadow:0 10px 26px rgba(15,23,42,.06);
  cursor:pointer;transition:.15s;
}
.miniCard:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(15,23,42,.10)}
.miniCard .t{font-weight:950}
.miniCard .n{font-size:22px;font-weight:950;margin-top:6px}
.miniCard .sub{margin-top:6px;color:var(--muted);font-size:12px;font-weight:700}

.hr{height:1px;background:var(--line);margin:14px 0}

.teamBlock{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.06);
  border-radius:18px;padding:14px;
  box-shadow:0 10px 26px rgba(15,23,42,.06);
}
.teamHead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
.teamName{font-weight:950}
.teamName .link{color:var(--brand);text-decoration:none}
.teamName .link:hover{text-decoration:underline}
.pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{
  background:var(--pill);
  border:1px solid rgba(15,23,42,.06);
  border-radius:12px;padding:7px 10px;
  font-weight:900;font-size:12px;
  cursor:pointer;
}
.pill:hover{background:#e8eef7}

.hidden{display:none!important}

/* tables */
table{width:100%;border-collapse:collapse;margin-top:12px}
th{
  background:rgba(11,18,32,.96);color:#fff;
  padding:10px;font-size:13px;text-align:left
}
td{padding:10px;border-bottom:1px solid #edf2f7;font-size:13px}
tr:hover td{background:rgba(37,99,235,.04)}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.toolbar input,.toolbar select{
  padding:10px;border-radius:14px;border:1px solid #cbd5e1;
  background:rgba(255,255,255,.96);outline:none
}
.toolbar input:focus,.toolbar select:focus{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(37,99,235,.16)
}
.btn{
  padding:10px 12px;border-radius:14px;border:0;cursor:pointer;
  font-weight:900;background:var(--dark);color:#fff
}

/* popup modal */
.pop{
  position:fixed;inset:0;z-index:50;
  background:rgba(2,6,23,.62);
  display:none;align-items:center;justify-content:center;
}
.pop.show{display:flex}
.pop-box{
  width:min(1200px,96vw);max-height:86vh;overflow:auto;
  background:rgba(255,255,255,.96);
  border:1px solid rgba(255,255,255,.25);
  border-radius:20px;padding:16px;
  box-shadow:0 26px 70px rgba(0,0,0,.35);
}
.pop-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
.pop-title{font-size:18px;font-weight:950}
.pop-sub{color:var(--muted);font-weight:700;font-size:13px;margin-top:4px}
.small{color:var(--muted);font-weight:700;font-size:12px}
</style>
</head>

<body>
<header>
  <div class="left">
    <strong>HR System</strong>
    <span class="badge">Public View · Google Sheet</span>
  </div>
  <div class="badge" id="status">Loading...</div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="dash">Dashboard</div>
    <div class="tab" data-tab="employees">Employees</div>
  </div>

  <!-- DASH -->
  <div id="dashView">
    <div class="card">
      <div class="h2">统计总览</div>
      <div class="muted">点击岗位 / 团队 / 图表即可弹出员工名单（不需要登录）</div>
    </div>

    <div class="kpi">
      <div class="kpiBox"><div class="label">总人数（unique ID）</div><div class="value" id="kTotal">-</div></div>
      <div class="kpiBox"><div class="label">出款人数</div><div class="value" id="kWD">-</div></div>
      <div class="kpiBox"><div class="label">客服人数</div><div class="value" id="kCS">-</div></div>
      <div class="kpiBox"><div class="label">查单人数</div><div class="value" id="kDP">-</div></div>
    </div>

    <!-- charts top -->
    <div class="grid2">
      <div class="card">
        <div class="sectionTitle">岗位分布（cột K / 点击扇区弹出名单）</div>
        <canvas id="chartPosition" height="160"></canvas>
      </div>
      <div class="card">
        <div class="sectionTitle">团队人数（cột F / 点击柱子弹出名单）</div>
        <canvas id="chartTeam" height="160"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="sectionTitle">岗位统计（每个岗位一个卡片）</div>
      <div id="posCards" class="flexWrap"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="sectionTitle">团队统计（cột F）（点击团队或岗位数字弹出员工）</div>
      <div id="teamBlocks" style="display:grid;gap:12px"></div>
      <div class="hr"></div>
      <div class="small">
        规则：团队=cột F，岗位=cột K，ID=cột G（为空不统计，且按ID去重）
      </div>
    </div>
  </div>

  <!-- EMPLOYEES -->
  <div id="empView" class="hidden">
    <div class="card">
      <div class="sectionTitle">员工名单（可搜索/筛选）</div>
      <div class="toolbar">
        <input id="empSearch" placeholder="Search 姓名/ID/团队/岗位/国家/盘口..." style="flex:1;min-width:260px">
        <select id="empTeamFilter"><option value="">全部团队（cột F）</option></select>
        <select id="empPosFilter"><option value="">全部岗位（cột K）</option></select>
        <button class="btn" id="empExport">Export CSV</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>负责人</th>
            <th>现场培训</th>
            <th>线上组长</th>
            <th>线上培训</th>
            <th>组别</th>
            <th>团队(cột F)</th>
            <th>姓名</th>
            <th>ID(cột G)</th>
            <th>国家</th>
            <th>岗位(cột K)</th>
            <th>盘口</th>
          </tr>
        </thead>
        <tbody id="empBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- POPUP -->
<div id="pop" class="pop">
  <div class="pop-box">
    <div class="pop-head">
      <div>
        <div class="pop-title" id="popTitle">-</div>
        <div class="pop-sub" id="popSub">-</div>
      </div>
      <div class="toolbar" style="margin:0">
        <input id="popSearch" placeholder="Search..." />
        <select id="popCountry"><option value="">All countries</option></select>
        <button class="btn" id="popClose">Close</button>
      </div>
    </div>

    <table style="margin-top:12px">
      <thead>
        <tr>
          <th>负责人</th>
          <th>现场培训</th>
          <th>线上组长</th>
          <th>线上培训</th>
          <th>组别</th>
          <th>团队</th>
          <th>姓名</th>
          <th>ID</th>
          <th>国家</th>
          <th>岗位</th>
          <th>盘口</th>
        </tr>
      </thead>
      <tbody id="popBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
// ✅ Replace only if you change sheet
const sheetAPI = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/团队填表";

/* ================= STATE ================= */
let RAW_ROWS = [];
let EMPLOYEES = []; // normalized + unique by ID (G)
let chartPos = null;
let chartTeam = null;
let popData = [];

/* ================= UTILS ================= */
const $ = (id)=>document.getElementById(id);
const norm = (v)=> (v ?? "").toString().trim();

function escapeHtml(s){
  s = (s ?? "").toString();
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function csvCell(v){
  v = (v ?? "").toString().replaceAll('"','""');
  if(v.includes(",") || v.includes("\n") || v.includes('"')) return `"${v}"`;
  return v;
}

function downloadFile(name, content){
  const blob = new Blob([content], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function countBy(list, keyFn){
  const m = new Map();
  for(const item of list){
    const k = norm(keyFn(item)) || "未分类";
    m.set(k, (m.get(k)||0) + 1);
  }
  return m;
}
function sortMapDesc(m){ return [...m.entries()].sort((a,b)=>b[1]-a[1]); }

/* ================= NORMALIZE (A-M) =================
   You want show: 负责人 现场培训 线上组长 线上培训 组别 姓名 ID 国家 岗位 盘口
   And team must be column F (团队), ID is column G, position is column K
*/
function pick(row, keys){
  for(const k of keys){
    if(Object.prototype.hasOwnProperty.call(row, k)){
      const v = norm(row[k]);
      if(v !== "") return v;
    }
  }
  return "";
}

function normalizeRow(r){
  // We support header names; OpenSheet uses headers, not A/B/C letters.
  // If your sheet header is exactly these Chinese titles, it will work.
  const 负责人   = pick(r, ["负责人","負責人"]);
  const 现场培训 = pick(r, ["现场培训","現場培訓"]);
  const 线上组长 = pick(r, ["线上组长","線上組長"]);
  const 线上培训 = pick(r, ["线上培训","線上培訓"]);
  const 组别     = pick(r, ["组别","組別"]);
  const 团队     = pick(r, ["团队","團隊"]);         // ✅ cột F
  const 姓名     = pick(r, ["姓名","名字","Name"]);
  const ID       = pick(r, ["ID","Id","员工ID","员工编号"]); // ✅ cột G
  const 国家     = pick(r, ["国家","國家","Country"]);
  const 岗位     = pick(r, ["岗位","崗位","Position"]);      // ✅ cột K
  const 盘口     = pick(r, ["盘口","盤口","品牌","盘口/品牌"]);

  return { 负责人, 现场培训, 线上组长, 线上培训, 组别, 团队, 姓名, ID, 国家, 岗位, 盘口 };
}

function uniqueById(rows){
  const map = new Map();
  for(const r of rows){
    const id = norm(r.ID);
    if(!id) continue; // ✅ ID empty ignore
    if(!map.has(id)) map.set(id, r);
  }
  return [...map.values()];
}

/* ================= LOAD SHEET ================= */
async function loadSheet(){
  $("status").innerText = "Loading sheet...";
  try{
    const res = await fetch(sheetAPI, { cache:"no-store" });
    const json = await res.json();
    RAW_ROWS = Array.isArray(json) ? json : [];
  }catch(e){
    RAW_ROWS = [];
  }

  const normalized = RAW_ROWS.map(normalizeRow);
  EMPLOYEES = uniqueById(normalized);

  $("status").innerText = `Loaded: ${EMPLOYEES.length.toLocaleString()} employees`;
  renderAll();
}

/* ================= RENDER ================= */
function renderAll(){
  renderKPIs();
  renderCharts();
  renderPositionCards();
  renderTeamBlocks();
  renderEmployeesTab();
}

function renderKPIs(){
  const total = EMPLOYEES.length;
  const wd = EMPLOYEES.filter(x=>x.岗位==="出款").length;
  const cs = EMPLOYEES.filter(x=>x.岗位==="客服").length;
  const dp = EMPLOYEES.filter(x=>x.岗位==="查单").length;
  $("kTotal").innerText = total.toLocaleString();
  $("kWD").innerText = wd.toLocaleString();
  $("kCS").innerText = cs.toLocaleString();
  $("kDP").innerText = dp.toLocaleString();
}

function renderCharts(){
  // Position chart (K)
  const posPairs = sortMapDesc(countBy(EMPLOYEES, x=>x.岗位));
  const posLabels = posPairs.map(x=>x[0]);
  const posValues = posPairs.map(x=>x[1]);

  if(chartPos) chartPos.destroy();
  chartPos = new Chart($("chartPosition"),{
    type:"doughnut",
    data:{ labels:posLabels, datasets:[{ data:posValues }] },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"top" } },
      onClick:(evt, els)=>{
        if(!els?.length) return;
        const pos = posLabels[els[0].index];
        openPopup({type:"position", key:pos});
      }
    }
  });

  // Team chart (F)
  const teamPairs = sortMapDesc(countBy(EMPLOYEES, x=>x.团队)).slice(0, 60);
  const teamLabels = teamPairs.map(x=>x[0]);
  const teamValues = teamPairs.map(x=>x[1]);

  if(chartTeam) chartTeam.destroy();
  chartTeam = new Chart($("chartTeam"),{
    type:"bar",
    data:{ labels:teamLabels, datasets:[{ label:"人数", data:teamValues }] },
    options:{
      responsive:true,
      plugins:{ legend:{ display:true } },
      scales:{ x:{ ticks:{ maxRotation:60, minRotation:60 } } },
      onClick:(evt, els)=>{
        if(!els?.length) return;
        const team = teamLabels[els[0].index];
        openPopup({type:"team", key:team});
      }
    }
  });
}

function renderPositionCards(){
  const wrap = $("posCards");
  wrap.innerHTML = "";
  const posPairs = sortMapDesc(countBy(EMPLOYEES, x=>x.岗位));
  posPairs.forEach(([pos,n])=>{
    const div = document.createElement("div");
    div.className = "miniCard";
    div.innerHTML = `<div class="t">${escapeHtml(pos)}</div><div class="n">${n}</div><div class="sub">点击查看员工</div>`;
    div.onclick = ()=>openPopup({type:"position", key:pos});
    wrap.appendChild(div);
  });
}

function renderTeamBlocks(){
  const box = $("teamBlocks");
  box.innerHTML = "";

  const allPositions = sortMapDesc(countBy(EMPLOYEES, x=>x.岗位)).map(x=>x[0]);
  const teamPairs = sortMapDesc(countBy(EMPLOYEES, x=>x.团队));

  teamPairs.forEach(([team,total])=>{
    const teamEmps = EMPLOYEES.filter(x=>x.团队===team);

    // count each position within team
    const posCount = new Map();
    for(const p of allPositions) posCount.set(p, 0);
    for(const e of teamEmps){
      const p = norm(e.岗位) || "未分类";
      posCount.set(p, (posCount.get(p)||0)+1);
    }

    const wrap = document.createElement("div");
    wrap.className = "teamBlock";

    const head = document.createElement("div");
    head.className = "teamHead";
    head.innerHTML = `
      <div>
        <div class="teamName">
          <a class="link" href="javascript:void(0)">${escapeHtml(team)}</a>
        </div>
        <div class="muted">总人数：${total}</div>
      </div>
      <div class="small">点击团队名或任意岗位数字弹出员工名单</div>
    `;
    head.querySelector("a.link").onclick = ()=>openPopup({type:"team", key:team});
    wrap.appendChild(head);

    const pills = document.createElement("div");
    pills.className = "pills";

    const totalPill = document.createElement("div");
    totalPill.className = "pill";
    totalPill.textContent = `总人数 ${total}`;
    totalPill.onclick = ()=>openPopup({type:"team", key:team});
    pills.appendChild(totalPill);

    [...posCount.entries()].sort((a,b)=>b[1]-a[1]).forEach(([pos,cnt])=>{
      if(cnt<=0) return;
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = `${pos} ${cnt}`;
      pill.onclick = ()=>openPopup({type:"team+position", key:team, pos});
      pills.appendChild(pill);
    });

    wrap.appendChild(pills);
    box.appendChild(wrap);
  });
}

function fillEmpFilters(){
  const teams = sortMapDesc(countBy(EMPLOYEES, x=>x.团队)).map(x=>x[0]);
  const poss  = sortMapDesc(countBy(EMPLOYEES, x=>x.岗位)).map(x=>x[0]);

  $("empTeamFilter").innerHTML = `<option value="">全部团队（cột F）</option>` +
    teams.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

  $("empPosFilter").innerHTML = `<option value="">全部岗位（cột K）</option>` +
    poss.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
}

function renderEmployeesTab(){
  fillEmpFilters();

  const render = ()=>{
    const kw = norm($("empSearch").value).toLowerCase();
    const t = norm($("empTeamFilter").value);
    const p = norm($("empPosFilter").value);

    let arr = EMPLOYEES.slice();
    if(t) arr = arr.filter(x=>x.团队===t);
    if(p) arr = arr.filter(x=>x.岗位===p);
    if(kw){
      arr = arr.filter(x=>{
        const s = `${x.负责人} ${x.现场培训} ${x.线上组长} ${x.线上培训} ${x.组别} ${x.团队} ${x.姓名} ${x.ID} ${x.国家} ${x.岗位} ${x.盘口}`.toLowerCase();
        return s.includes(kw);
      });
    }

    $("empBody").innerHTML = arr.slice(0, 1200).map(e=>`
      <tr>
        <td>${escapeHtml(e.负责人)}</td>
        <td>${escapeHtml(e.现场培训)}</td>
        <td>${escapeHtml(e.线上组长)}</td>
        <td>${escapeHtml(e.线上培训)}</td>
        <td>${escapeHtml(e.组别)}</td>
        <td>${escapeHtml(e.团队)}</td>
        <td>${escapeHtml(e.姓名)}</td>
        <td>${escapeHtml(e.ID)}</td>
        <td>${escapeHtml(e.国家)}</td>
        <td>${escapeHtml(e.岗位)}</td>
        <td>${escapeHtml(e.盘口)}</td>
      </tr>
    `).join("");
  };

  $("empSearch").oninput = render;
  $("empTeamFilter").onchange = render;
  $("empPosFilter").onchange = render;

  $("empExport").onclick = ()=>{
    const cols = ["负责人","现场培训","线上组长","线上培训","组别","团队","姓名","ID","国家","岗位","盘口"];
    const csv = [cols.join(",")].concat(
      EMPLOYEES.map(r=>cols.map(c=>csvCell(r[c])).join(","))
    ).join("\n");
    downloadFile("employees.csv", csv);
  };

  render();
}

/* ================= POPUP ================= */
$("popClose").onclick = closePopup;
$("pop").onclick = (e)=>{ if(e.target===$("pop")) closePopup(); };
$("popSearch").oninput = renderPopupTable;
$("popCountry").onchange = renderPopupTable;

function openPopup({type, key, pos}){
  let arr = [];
  let title = "";

  if(type==="position"){
    title = `${key} 员工名单`;
    arr = EMPLOYEES.filter(x=>x.岗位===key);
  }else if(type==="team"){
    title = `${key} 员工名单`;
    arr = EMPLOYEES.filter(x=>x.团队===key);
  }else if(type==="team+position"){
    title = `${key} - ${pos} 员工名单`;
    arr = EMPLOYEES.filter(x=>x.团队===key && x.岗位===pos);
  }

  popData = arr;
  $("popTitle").innerText = title;
  $("popSub").innerText = `共 ${arr.length} 人（可搜索/按国家过滤）`;

  const countries = sortMapDesc(countBy(arr, x=>x.国家)).map(x=>x[0]);
  $("popCountry").innerHTML = `<option value="">All countries</option>` +
    countries.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  $("popSearch").value = "";
  $("popCountry").value = "";

  $("pop").classList.add("show");
  renderPopupTable();
}

function renderPopupTable(){
  const kw = norm($("popSearch").value).toLowerCase();
  const c  = norm($("popCountry").value);

  let arr = popData.slice();
  if(c) arr = arr.filter(x=>x.国家===c);
  if(kw){
    arr = arr.filter(x=>{
      const s = `${x.负责人} ${x.现场培训} ${x.线上组长} ${x.线上培训} ${x.组别} ${x.团队} ${x.姓名} ${x.ID} ${x.国家} ${x.岗位} ${x.盘口}`.toLowerCase();
      return s.includes(kw);
    });
  }

  $("popBody").innerHTML = arr.slice(0, 1200).map(e=>`
    <tr>
      <td>${escapeHtml(e.负责人)}</td>
      <td>${escapeHtml(e.现场培训)}</td>
      <td>${escapeHtml(e.线上组长)}</td>
      <td>${escapeHtml(e.线上培训)}</td>
      <td>${escapeHtml(e.组别)}</td>
      <td>${escapeHtml(e.团队)}</td>
      <td>${escapeHtml(e.姓名)}</td>
      <td>${escapeHtml(e.ID)}</td>
      <td>${escapeHtml(e.国家)}</td>
      <td>${escapeHtml(e.岗位)}</td>
      <td>${escapeHtml(e.盘口)}</td>
    </tr>
  `).join("");
}

function closePopup(){
  $("pop").classList.remove("show");
  popData = [];
}

/* ================= TABS ================= */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    $("dashView").classList.toggle("hidden", tab!=="dash");
    $("empView").classList.toggle("hidden", tab!=="employees");
  };
});

/* ================= START ================= */
loadSheet();
</script>

</body>
</html>
