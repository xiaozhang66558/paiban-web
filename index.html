<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HR System - SaaS Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --nav:#0b1220;
      --nav2:#0f172a;
      --chip:#f1f5f9;
      --primary:#2563eb;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --shadow2:0 2px 10px rgba(2,6,23,.06);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,.14), transparent 45%),
                      radial-gradient(900px 600px at 90% 0%, rgba(16,185,129,.10), transparent 45%),
                      var(--bg);
         color:var(--text);}

    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.92));
      backdrop-filter: blur(10px);
      color:#fff;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .head-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;}
    .dot{width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)}
    .right-badges{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.8);font-size:12px;}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)}
    .container{max-width:1240px;margin:18px auto;padding:0 16px 40px;}

    /* top tabs */
    .topbar{
      display:flex;align-items:center;gap:10px;
      margin:14px 0 16px;
    }
    .tabs{
      display:flex;gap:8px;align-items:center;
      padding:8px;background:rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.55);
      border-radius:999px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .tab{
      user-select:none;
      padding:8px 14px;
      border-radius:999px;
      background:transparent;
      border:1px solid transparent;
      color:#0f172a;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
    }
    .tab.active{
      background:linear-gradient(180deg, #0f172a, #0b1220);
      color:#fff;
      box-shadow:0 10px 26px rgba(2,6,23,.25);
    }

    /* filters */
    .filters{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      margin-left:auto;
    }
    .input, .select{
      height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      padding:0 12px;
      outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.02);
      color:var(--text);
    }
    .input{min-width:240px}
    .select{min-width:160px}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.65);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .title{
      font-size:22px;font-weight:900;margin:0 0 6px;
      letter-spacing:.2px;
    }
    .sub{color:var(--muted);font-size:13px}

    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    .grid-2-top{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .kpi{
      padding:14px;border-radius:16px;background:rgba(255,255,255,.94);
      border:1px solid rgba(255,255,255,.65);
      box-shadow:var(--shadow2);
    }
    .kpi .label{color:var(--muted);font-size:12px;font-weight:700}
    .kpi .value{font-size:24px;font-weight:900;margin-top:6px}

    /* position cards */
    .pos-wrap{margin-top:14px}
    .pos-grid{
      display:grid;
      grid-template-columns:repeat(8, 1fr);
      gap:10px;
    }
    @media (max-width:1200px){ .pos-grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:720px){ .pos-grid{grid-template-columns:repeat(2,1fr)} }
    .pos-card{
      cursor:pointer;
      padding:12px;border-radius:16px;background:rgba(255,255,255,.95);
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
      transition:transform .12s ease, box-shadow .12s ease;
      min-height:64px;
    }
    .pos-card:hover{transform:translateY(-2px);box-shadow:0 14px 35px rgba(2,6,23,.10)}
    .pos-name{font-weight:900;font-size:13px;line-height:1.15}
    .pos-count{margin-top:8px;color:#0f172a;font-weight:900}

    /* team cards area */
    .team-section{margin-top:14px}
    .team-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:var(--chip);
      border:1px solid rgba(2,6,23,.06);
      color:#0f172a;font-weight:800;font-size:12px;
    }
    .team-list{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width:1100px){ .team-list{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:720px){ .team-list{grid-template-columns:1fr} }
    .team-card{
      padding:14px;border-radius:18px;background:rgba(255,255,255,.95);
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
    }
    .team-name{font-weight:1000;font-size:14px;margin:0 0 10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:7px 10px;border-radius:12px;background:var(--chip);
      border:1px solid rgba(2,6,23,.06);
      font-size:12px;font-weight:800;color:#0f172a;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color:rgba(37,99,235,.35)}
    .chip.primary{
      background:rgba(37,99,235,.12);
      border-color:rgba(37,99,235,.25);
      color:#1d4ed8;
    }

    /* table */
    .table-wrap{margin-top:12px}
    .table-top{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .toggle{
      display:flex;align-items:center;gap:8px;
      padding:6px;background:rgba(255,255,255,.9);
      border:1px solid rgba(2,6,23,.08);
      border-radius:999px;
      box-shadow:var(--shadow2);
    }
    .tbtn{
      cursor:pointer;
      padding:7px 12px;border-radius:999px;
      border:1px solid transparent;
      font-weight:900;font-size:12px;
      color:var(--text);
      background:transparent;
    }
    .tbtn.active{
      background:rgba(37,99,235,.14);
      border-color:rgba(37,99,235,.28);
      color:#1d4ed8;
    }
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;
      background:linear-gradient(180deg, #0f172a, #0b1220);
      color:#fff;
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      padding:12px 12px;
      border-top-left-radius:14px;
      border-top-right-radius:14px;
      white-space:nowrap;
    }
    thead th + th{border-radius:0}
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(2,6,23,.06);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover{background:rgba(2,6,23,.03)}
    .td-link{color:#2563eb;font-weight:900;cursor:pointer}
    .td-link:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-weight:800}

    /* table no horizontal scroll solution = card view */
    .scroll{
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
      background:#fff;
      max-height:520px;
    }
    .cards{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
    }
    @media (max-width:1100px){ .cards{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:720px){ .cards{grid-template-columns:1fr} }
    .rowcard{
      background:#fff;border:1px solid rgba(2,6,23,.06);border-radius:18px;
      padding:12px;box-shadow:var(--shadow2);
    }
    .rowcard .h{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      margin-bottom:10px;
    }
    .rowcard .name{font-weight:1000}
    .rowcard .kv{display:grid;grid-template-columns:92px 1fr;gap:6px 10px;font-size:12px}
    .rowcard .k{color:var(--muted);font-weight:900}
    .rowcard .v{color:#0f172a;font-weight:800;word-break:break-word}

    /* modal */
    .modal{
      position:fixed;inset:0;z-index:1000;
      display:none;
      background:rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      align-items:center;justify-content:center;
      padding:18px;
    }
    .modal.show{display:flex}
    .modal-box{
      width:min(1100px, 96vw);
      max-height:min(86vh, 860px);
      background:rgba(255,255,255,.96);
      border:1px solid rgba(255,255,255,.65);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(2,6,23,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
    }
    .modal-title{font-weight:1000}
    .xbtn{
      cursor:pointer;border:0;
      width:40px;height:40px;border-radius:12px;
      background:rgba(2,6,23,.06);
      font-weight:1000;
    }
    .modal-body{padding:14px 16px}
    .mini{font-size:12px;color:var(--muted);font-weight:800}
    .modal-filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .modal-filters .input{min-width:260px}
    .modal-scroll{margin-top:12px;max-height:62vh;overflow:auto;border-radius:16px;border:1px solid rgba(2,6,23,.08);background:#fff}
    .modal-scroll table thead th{top:0}

    /* hide sections */
    .hidden{display:none !important}
  </style>
</head>

<body>
<header>
  <div class="head-row">
    <div class="brand">
      <span class="dot"></span>
      <span>HR System</span>
      <span class="badge">Public view</span>
    </div>
    <div class="right-badges">
      <span class="badge" id="dataStatus">Loading…</span>
      <span class="badge" id="lastUpdated">—</span>
    </div>
  </div>
</header>

<div class="container">

  <div class="topbar">
    <div class="tabs">
      <div class="tab active" data-page="dashboard">Dashboard</div>
      <div class="tab" data-page="employees">Employees</div>
      <div class="tab" data-page="schedule">排班表</div>
    </div>

    <div class="filters" id="globalFilters">
      <input id="qSearch" class="input" placeholder="Search name / ID / team / group / position / country / shift…"/>
      <select id="fShift" class="select"></select>
      <select id="fTeam" class="select"></select>
      <select id="fGroup" class="select"></select>
      <select id="fPos" class="select"></select>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="page-dashboard">
    <div class="card">
      <div class="title">统计总览</div>
      <div class="sub">按岗位 & 团队统计（点击岗位卡片 / 团队统计会弹窗员工名单）</div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">总人数（去重）</div>
          <div class="value" id="kTotal">—</div>
        </div>
        <div class="kpi">
          <div class="label">出款人数</div>
          <div class="value" id="kWD">—</div>
        </div>
        <div class="kpi">
          <div class="label">客服人数</div>
          <div class="value" id="kCS">—</div>
        </div>
        <div class="kpi">
          <div class="label">查单人数</div>
          <div class="value" id="kDP">—</div>
        </div>
      </div>

      <!-- position cards -->
      <div class="pos-wrap">
        <div class="sub" style="margin:4px 0 10px;font-weight:900;">岗位（每个岗位一个卡片，点击查看员工）</div>
        <div class="pos-grid" id="posGrid"></div>
      </div>
    </div>

    <!-- charts on top (requested) -->
    <div class="grid-2-top">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <div style="font-weight:1000">岗位分布（点击扇区弹员工）</div>
            <div class="mini">来源：岗位 = Google Sheet「岗位」列</div>
          </div>
        </div>
        <div style="height:340px;margin-top:10px">
          <canvas id="chartPos"></canvas>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <div style="font-weight:1000">团队人数（cột F，点击柱子弹员工）</div>
            <div class="mini">来源：团队 = Google Sheet「团队」列（不是「组别」）</div>
          </div>
          <span class="pill" id="teamCountPill">团队数量：—</span>
        </div>
        <div style="height:340px;margin-top:10px">
          <canvas id="chartTeam"></canvas>
        </div>
      </div>
    </div>

    <!-- team cards -->
    <div class="card team-section">
      <div class="team-head">
        <div>
          <div style="font-weight:1000">团队统计（cột F）</div>
          <div class="mini">每个团队：总人数 + 各岗位人数（点击任意数字弹窗员工名单）</div>
        </div>
        <span class="pill" id="teamCountPill2">团队数量：—</span>
      </div>
      <div class="team-list" id="teamCards"></div>
    </div>
  </section>

  <!-- EMPLOYEES -->
  <section id="page-employees" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
        <div>
          <div class="title" style="margin-bottom:2px">Employees</div>
          <div class="sub">支持 Table / Cards 两种视图（Cards 不需要横向拖动）</div>
        </div>

        <div class="toggle">
          <button class="tbtn active" id="btnTable">Table</button>
          <button class="tbtn" id="btnCards">Cards</button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="mini" id="empCount">—</div>

        <div id="empTableWrap" class="scroll" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:110px">班次</th>
                <th style="min-width:120px">团队 (cột F)</th>
                <th style="min-width:120px">组别</th>
                <th style="min-width:160px">姓名</th>
                <th style="min-width:120px">ID</th>
                <th style="min-width:120px">岗位</th>
                <th style="min-width:120px">国家</th>
                <th style="min-width:220px">盘口</th>
                <th style="min-width:120px">负责人</th>
                <th style="min-width:160px">现场培训</th>
                <th style="min-width:160px">线上组长</th>
                <th style="min-width:220px">线上培训</th>
              </tr>
            </thead>
            <tbody id="empTbody"></tbody>
          </table>
        </div>

        <div id="empCardsWrap" class="hidden" style="margin-top:10px">
          <div class="cards" id="empCards"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="page-schedule" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
        <div>
          <div class="title" style="margin-bottom:2px">排班表</div>
          <div class="sub">按岗位分组 → 再按班次（Day / Night / 中班…）。点击数字弹窗员工名单。</div>
        </div>
        <div class="toggle">
          <button class="tbtn active" id="btnSchCards">Cards</button>
          <button class="tbtn" id="btnSchTable">Table</button>
        </div>
      </div>

      <div class="mini" id="schTip" style="margin-top:10px">
        班次来源：Google Sheet「班次」列（你刚加在 cột i）。团队来源：Google Sheet「团队」列（cột F）。
      </div>

      <div id="scheduleCards" style="margin-top:14px"></div>

      <div id="scheduleTable" class="hidden" style="margin-top:14px">
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th style="min-width:140px">岗位</th>
                <th style="min-width:120px">班次</th>
                <th style="min-width:140px">团队 (cột F)</th>
                <th style="min-width:120px">组别</th>
                <th style="min-width:180px">姓名</th>
                <th style="min-width:130px">ID</th>
                <th style="min-width:120px">国家</th>
                <th style="min-width:260px">盘口</th>
              </tr>
            </thead>
            <tbody id="schTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="modalTitle">—</div>
        <div class="mini" id="modalSub">—</div>
      </div>
      <button class="xbtn" id="modalClose">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-filters">
        <input id="modalSearch" class="input" placeholder="Search inside list…"/>
        <select id="modalShift" class="select"></select>
        <select id="modalTeam" class="select"></select>
        <select id="modalGroup" class="select"></select>
        <select id="modalPos" class="select"></select>
      </div>

      <div class="modal-scroll">
        <table>
          <thead>
            <tr>
              <th style="min-width:110px">班次</th>
              <th style="min-width:120px">团队 (cột F)</th>
              <th style="min-width:120px">组别</th>
              <th style="min-width:160px">姓名</th>
              <th style="min-width:120px">ID</th>
              <th style="min-width:120px">岗位</th>
              <th style="min-width:120px">国家</th>
              <th style="min-width:220px">盘口</th>
              <th style="min-width:120px">负责人</th>
              <th style="min-width:160px">现场培训</th>
              <th style="min-width:160px">线上组长</th>
              <th style="min-width:220px">线上培训</th>
            </tr>
          </thead>
          <tbody id="modalTbody"></tbody>
        </table>
      </div>

      <div class="mini" id="modalCount" style="margin-top:10px">—</div>
    </div>
  </div>
</div>

<script>
/** ===========================
 *  1) DATA SOURCE (OpenSheet)
 *  =========================== */
const SHEET_API = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/团队填表";
// 如果你换表/换sheet，只改上面这一行

/** ===========================
 *  2) COLUMN HEADERS (by name)
 *  =========================== */
const COL = {
  owner: "负责人",
  onsite: "现场培训",
  leader: "线上组长",
  online: "线上培训",
  group: "组别",       // 组 (cột E)
  team:  "团队",       // 团队 (cột F)  ✅你要求必须用这个
  name:  "姓名",
  id:    "ID",         // ID (cột G)
  shift: "班次",       // 班次 (你说新增在 cột i，但我们按 header 读)
  country:"国家",
  pos:   "岗位",
  desk:  "盘口"
};

/** ===========================
 *  3) STATE
 *  =========================== */
let RAW = [];
let ROWS = [];     // normalized
let viewEmp = "table";
let viewSch = "cards";

let chartPos, chartTeam;

/** ===========================
 *  4) HELPERS
 *  =========================== */
const $ = (id)=>document.getElementById(id);

function norm(v){
  if(v === null || v === undefined) return "";
  return String(v).trim();
}
function safeGet(row, key){
  return norm(row?.[key]);
}
function uniqKey(row){
  // 总人数 = 去重逻辑：
  // 1) 优先 ID（不为空）
  // 2) 如果 ID 为空，用 “现场培训 + 线上组长 + 姓名” 做 fallback，尽量避免重复
  const id = safeGet(row, COL.id);
  if(id) return "ID:" + id;

  const c = safeGet(row, COL.onsite);  // 你之前说 cột C
  const d = safeGet(row, COL.leader);  // 你之前说 cột D
  const name = safeGet(row, COL.name);
  const team = safeGet(row, COL.team);
  const pos = safeGet(row, COL.pos);
  const country = safeGet(row, COL.country);

  return "FB:" + [c,d,name,team,pos,country].join("|");
}

function isValidPerson(row){
  // “ID 为空则跳过统计？” 你之前要求：总人数统计 cột G 不为空 + unique…
  // 但你也 muốn “không ai bị trùng” -> thực tế sheet có thể có dòng không ID.
  // => Ở đây: nếu ID rỗng nhưng có 姓名 thì vẫn tính theo fallback (để không mất người).
  // Nếu bạn muốn "ID rỗng bỏ qua", đổi dòng dưới thành: return !!safeGet(row, COL.id);
  const hasName = !!safeGet(row, COL.name);
  const hasId = !!safeGet(row, COL.id);
  return hasId || hasName;
}

function sortCN(a,b){
  return a.localeCompare(b, "zh-Hans-CN", {numeric:true, sensitivity:"base"});
}

function uniqueByKey(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, x);
  }
  return [...m.values()];
}

function buildOptions(selectEl, values, placeholder){
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);

  values.forEach(v=>{
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    selectEl.appendChild(op);
  });
}

function applyGlobalFilters(rows){
  const q = norm($("qSearch").value).toLowerCase();
  const fShift = $("fShift").value;
  const fTeam  = $("fTeam").value;
  const fGroup = $("fGroup").value;
  const fPos   = $("fPos").value;

  return rows.filter(r=>{
    if(fShift && safeGet(r, COL.shift) !== fShift) return false;
    if(fTeam  && safeGet(r, COL.team)  !== fTeam) return false;
    if(fGroup && safeGet(r, COL.group) !== fGroup) return false;
    if(fPos   && safeGet(r, COL.pos)   !== fPos) return false;

    if(!q) return true;

    const hay = [
      safeGet(r, COL.name),
      safeGet(r, COL.id),
      safeGet(r, COL.team),
      safeGet(r, COL.group),
      safeGet(r, COL.pos),
      safeGet(r, COL.country),
      safeGet(r, COL.shift),
      safeGet(r, COL.desk),
      safeGet(r, COL.owner),
      safeGet(r, COL.onsite),
      safeGet(r, COL.leader),
      safeGet(r, COL.online)
    ].join(" ").toLowerCase();

    return hay.includes(q);
  });
}

function buildEmployeeRowHTML(r){
  const shift = safeGet(r, COL.shift) || "—";
  const team  = safeGet(r, COL.team)  || "—";
  const group = safeGet(r, COL.group) || "—";
  const name  = safeGet(r, COL.name)  || "—";
  const id    = safeGet(r, COL.id)    || "—";
  const pos   = safeGet(r, COL.pos)   || "—";
  const ctry  = safeGet(r, COL.country) || "—";
  const desk  = safeGet(r, COL.desk) || "—";
  const owner = safeGet(r, COL.owner) || "—";
  const onsite= safeGet(r, COL.onsite)|| "—";
  const lead  = safeGet(r, COL.leader)|| "—";
  const online= safeGet(r, COL.online)|| "—";

  return `
    <tr>
      <td>${shift}</td>
      <td><span class="td-link" data-open="team" data-value="${escapeHtml(team)}">${escapeHtml(team)}</span></td>
      <td><span class="td-link" data-open="group" data-value="${escapeHtml(group)}">${escapeHtml(group)}</span></td>
      <td><span class="td-link" data-open="name" data-value="${escapeHtml(name)}">${escapeHtml(name)}</span></td>
      <td class="mono">${escapeHtml(id)}</td>
      <td><span class="td-link" data-open="pos" data-value="${escapeHtml(pos)}">${escapeHtml(pos)}</span></td>
      <td>${escapeHtml(ctry)}</td>
      <td>${escapeHtml(desk)}</td>
      <td>${escapeHtml(owner)}</td>
      <td>${escapeHtml(onsite)}</td>
      <td>${escapeHtml(lead)}</td>
      <td>${escapeHtml(online)}</td>
    </tr>
  `;
}

function buildEmployeeCardHTML(r){
  const data = {
    "班次": safeGet(r, COL.shift) || "—",
    "团队": safeGet(r, COL.team) || "—",
    "组别": safeGet(r, COL.group) || "—",
    "姓名": safeGet(r, COL.name) || "—",
    "ID": safeGet(r, COL.id) || "—",
    "岗位": safeGet(r, COL.pos) || "—",
    "国家": safeGet(r, COL.country) || "—",
    "盘口": safeGet(r, COL.desk) || "—",
    "负责人": safeGet(r, COL.owner) || "—",
    "现场培训": safeGet(r, COL.onsite) || "—",
    "线上组长": safeGet(r, COL.leader) || "—",
    "线上培训": safeGet(r, COL.online) || "—",
  };
  const name = data["姓名"];
  const id = data["ID"];

  return `
    <div class="rowcard">
      <div class="h">
        <div>
          <div class="name">${escapeHtml(name)}</div>
          <div class="mini mono">${escapeHtml(id)}</div>
        </div>
        <div class="pill">${escapeHtml(data["岗位"])}</div>
      </div>
      <div class="kv">
        ${Object.entries(data).map(([k,v])=>`
          <div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div>
        `).join("")}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ===========================
 *  5) LOAD & NORMALIZE
 *  =========================== */
async function loadData(){
  $("dataStatus").textContent = "Loading…";
  try{
    const res = await fetch(SHEET_API, {cache:"no-store"});
    if(!res.ok) throw new Error("Fetch failed: " + res.status);
    RAW = await res.json();

    // normalize: keep only rows that look like person records
    const tmp = RAW.map(r=>{
      const o = {};
      for(const k in r) o[norm(k)] = norm(r[k]);
      return o;
    });

    // filter blank rows
    ROWS = tmp.filter(r=>{
      const any = Object.values(COL).some(colName => !!safeGet(r, colName));
      return any && isValidPerson(r);
    });

    $("dataStatus").textContent = "Loaded";
    $("lastUpdated").textContent = "Updated: " + new Date().toLocaleString();

  }catch(err){
    console.error(err);
    $("dataStatus").textContent = "Load error";
    $("lastUpdated").textContent = String(err?.message || err);
  }
}

/** ===========================
 *  6) BUILD FILTERS
 *  =========================== */
function initFilters(){
  const shifts = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.shift)).filter(Boolean))).sort(sortCN);
  const teams  = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.team)).filter(Boolean))).sort(sortCN);
  const groups = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.group)).filter(Boolean))).sort(sortCN);
  const poss   = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.pos)).filter(Boolean))).sort(sortCN);

  buildOptions($("fShift"), shifts, "All shifts");
  buildOptions($("fTeam"), teams, "All teams (cột F)");
  buildOptions($("fGroup"), groups, "All groups (组别)");
  buildOptions($("fPos"), poss, "All positions");

  // modal filters (same)
  buildOptions($("modalShift"), shifts, "All shifts");
  buildOptions($("modalTeam"), teams, "All teams");
  buildOptions($("modalGroup"), groups, "All groups");
  buildOptions($("modalPos"), poss, "All positions");
}

/** ===========================
 *  7) DASHBOARD (KPIs + CARDS + CHARTS + TEAM STATS)
 *  =========================== */
function buildStats(rows){
  const uniquePeople = uniqueByKey(rows, uniqKey);
  const total = uniquePeople.length;

  const byPos = new Map();
  const byTeam = new Map(); // team (cột F)
  const byTeamPos = new Map(); // team -> pos -> count

  for(const r of uniquePeople){
    const pos = safeGet(r, COL.pos) || "未填写岗位";
    const team = safeGet(r, COL.team) || "未填写团队";
    byPos.set(pos, (byPos.get(pos)||0)+1);

    byTeam.set(team, (byTeam.get(team)||0)+1);

    const key = team + "||" + pos;
    byTeamPos.set(key, (byTeamPos.get(key)||0)+1);
  }

  return {uniquePeople, total, byPos, byTeam, byTeamPos};
}

function renderDashboard(){
  const filtered = applyGlobalFilters(ROWS);
  const {uniquePeople, total, byPos, byTeam, byTeamPos} = buildStats(filtered);

  $("kTotal").textContent = total;

  const cs = byPos.get("客服") || 0;
  const wd = byPos.get("出款") || 0;
  const dp = byPos.get("查单") || 0;
  $("kCS").textContent = cs;
  $("kWD").textContent = wd;
  $("kDP").textContent = dp;

  // Position cards (each pos one card) clickable -> modal
  const posArr = [...byPos.entries()].sort((a,b)=>b[1]-a[1]);
  $("posGrid").innerHTML = posArr.map(([pos,count])=>`
    <div class="pos-card" data-open="pos" data-value="${escapeHtml(pos)}">
      <div class="pos-name">${escapeHtml(pos)}</div>
      <div class="pos-count">${count} 人</div>
    </div>
  `).join("");

  // Charts
  const posLabels = posArr.map(x=>x[0]);
  const posData = posArr.map(x=>x[1]);

  if(chartPos) chartPos.destroy();
  chartPos = new Chart($("chartPos"),{
    type:"doughnut",
    data:{
      labels:posLabels,
      datasets:[{data:posData}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:"top"}
      },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const label = posLabels[idx];
        openModal({title:`${label} 员工名单`, preset:{pos:label}});
      }
    }
  });

  const teamArr = [...byTeam.entries()].sort((a,b)=>b[1]-a[1]);
  $("teamCountPill").textContent = "团队数量：" + teamArr.length;
  $("teamCountPill2").textContent = "团队数量：" + teamArr.length;

  const teamLabels = teamArr.map(x=>x[0]);
  const teamData = teamArr.map(x=>x[1]);

  if(chartTeam) chartTeam.destroy();
  chartTeam = new Chart($("chartTeam"),{
    type:"bar",
    data:{
      labels:teamLabels,
      datasets:[{label:"人数", data:teamData}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:true}},
      scales:{
        x:{ticks:{maxRotation:60,minRotation:60}}
      },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const team = teamLabels[idx];
        openModal({title:`${team} 员工名单`, preset:{team}});
      }
    }
  });

  // Team cards: each team shows chips for total + each position
  // Build list of positions for consistent chip order (top positions first)
  const posOrder = posArr.map(x=>x[0]);

  $("teamCards").innerHTML = teamArr.map(([team, teamTotal])=>{
    const chips = [];
    chips.push(`<span class="chip primary" data-open="team" data-value="${escapeHtml(team)}" data-pos="">总人数 ${teamTotal}</span>`);

    // position chips
    for(const pos of posOrder){
      const cnt = byTeamPos.get(team+"||"+pos) || 0;
      if(cnt<=0) continue;
      chips.push(`<span class="chip" data-open="teampos" data-value="${escapeHtml(team)}" data-pos="${escapeHtml(pos)}">${escapeHtml(pos)} ${cnt}</span>`);
    }

    return `
      <div class="team-card">
        <div class="team-name">${escapeHtml(team)}</div>
        <div class="chips">${chips.join("")}</div>
      </div>
    `;
  }).join("");
}

/** ===========================
 *  8) EMPLOYEES PAGE
 *  =========================== */
function renderEmployees(){
  const filtered = applyGlobalFilters(ROWS);
  const uniq = uniqueByKey(filtered, uniqKey);

  $("empCount").textContent = `共 ${uniq.length} 人（去重后）`;

  // table
  $("empTbody").innerHTML = uniq.map(buildEmployeeRowHTML).join("");

  // cards
  $("empCards").innerHTML = uniq.map(buildEmployeeCardHTML).join("");

  // attach click handlers inside table
  attachInlineOpenHandlers($("empTbody"));
}

/** ===========================
 *  9) SCHEDULE PAGE (排班表)
 *  =========================== */
function renderSchedule(){
  const filtered = applyGlobalFilters(ROWS);
  const uniq = uniqueByKey(filtered, uniqKey);

  // group by position -> shift
  const map = new Map(); // pos -> shift -> rows
  for(const r of uniq){
    const pos = safeGet(r, COL.pos) || "未填写岗位";
    const shift = safeGet(r, COL.shift) || "未填写班次";
    if(!map.has(pos)) map.set(pos, new Map());
    const m2 = map.get(pos);
    if(!m2.has(shift)) m2.set(shift, []);
    m2.get(shift).push(r);
  }

  const posList = [...map.keys()].sort(sortCN);

  // Cards view
  const cardHTML = posList.map(pos=>{
    const shiftMap = map.get(pos);
    const shiftList = [...shiftMap.keys()].sort(sortCN);
    const total = shiftList.reduce((s,sh)=>s+shiftMap.get(sh).length,0);

    const chips = shiftList.map(sh=>{
      const cnt = shiftMap.get(sh).length;
      return `<span class="chip" data-open="sch" data-pos="${escapeHtml(pos)}" data-shift="${escapeHtml(sh)}">${escapeHtml(sh)} ${cnt}</span>`;
    }).join("");

    return `
      <div class="team-card" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="team-name" style="margin:0">${escapeHtml(pos)}</div>
          <span class="pill">总人数：${total}</span>
        </div>
        <div class="chips" style="margin-top:10px">
          <span class="chip primary" data-open="pos" data-value="${escapeHtml(pos)}">全部 ${total}</span>
          ${chips}
        </div>
      </div>
    `;
  }).join("");

  $("scheduleCards").innerHTML = cardHTML;

  // Table view
  $("schTbody").innerHTML = uniq.map(r=>{
    const pos = safeGet(r, COL.pos) || "—";
    const sh  = safeGet(r, COL.shift) || "—";
    const team= safeGet(r, COL.team) || "—";
    const group=safeGet(r, COL.group) || "—";
    const name= safeGet(r, COL.name) || "—";
    const id  = safeGet(r, COL.id) || "—";
    const ctry= safeGet(r, COL.country) || "—";
    const desk= safeGet(r, COL.desk) || "—";
    return `
      <tr>
        <td><span class="td-link" data-open="pos" data-value="${escapeHtml(pos)}">${escapeHtml(pos)}</span></td>
        <td><span class="td-link" data-open="shift" data-value="${escapeHtml(sh)}">${escapeHtml(sh)}</span></td>
        <td><span class="td-link" data-open="team" data-value="${escapeHtml(team)}">${escapeHtml(team)}</span></td>
        <td><span class="td-link" data-open="group" data-value="${escapeHtml(group)}">${escapeHtml(group)}</span></td>
        <td>${escapeHtml(name)}</td>
        <td class="mono">${escapeHtml(id)}</td>
        <td>${escapeHtml(ctry)}</td>
        <td>${escapeHtml(desk)}</td>
      </tr>
    `;
  }).join("");

  attachInlineOpenHandlers($("schTbody"));

  // attach for cards
  $("scheduleCards").querySelectorAll("[data-open]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const type = el.getAttribute("data-open");
      if(type === "sch"){
        const pos = el.getAttribute("data-pos");
        const shift = el.getAttribute("data-shift");
        openModal({title:`${pos} - ${shift} 员工名单`, preset:{pos, shift}});
      }else if(type === "pos"){
        openModal({title:`${el.getAttribute("data-value")} 员工名单`, preset:{pos: el.getAttribute("data-value")}});
      }
    });
  });
}

/** ===========================
 *  10) MODAL (popup employee list)
 *  =========================== */
let modalBase = []; // rows after preset filter

function openModal({title, preset}){
  $("modalTitle").textContent = title || "员工名单";
  $("modalSub").textContent = "你可以在弹窗内继续筛选（不会影响主页面）";

  // set presets into modal filters
  $("modalSearch").value = "";

  $("modalShift").value = preset?.shift || "";
  $("modalTeam").value  = preset?.team  || "";
  $("modalGroup").value = preset?.group || "";
  $("modalPos").value   = preset?.pos   || "";

  // base rows: from globally filtered set (so respects top filters)
  const base = applyGlobalFilters(ROWS);
  modalBase = uniqueByKey(base, uniqKey);

  renderModalTable();
  $("modal").classList.add("show");
}

function renderModalTable(){
  const q = norm($("modalSearch").value).toLowerCase();
  const shift = $("modalShift").value;
  const team  = $("modalTeam").value;
  const group = $("modalGroup").value;
  const pos   = $("modalPos").value;

  const list = modalBase.filter(r=>{
    if(shift && safeGet(r, COL.shift) !== shift) return false;
    if(team  && safeGet(r, COL.team)  !== team) return false;
    if(group && safeGet(r, COL.group) !== group) return false;
    if(pos   && safeGet(r, COL.pos)   !== pos) return false;

    if(!q) return true;
    const hay = [
      safeGet(r, COL.name),
      safeGet(r, COL.id),
      safeGet(r, COL.team),
      safeGet(r, COL.group),
      safeGet(r, COL.pos),
      safeGet(r, COL.country),
      safeGet(r, COL.shift),
      safeGet(r, COL.desk),
      safeGet(r, COL.owner),
      safeGet(r, COL.onsite),
      safeGet(r, COL.leader),
      safeGet(r, COL.online),
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  $("modalTbody").innerHTML = list.map(buildEmployeeRowHTML).join("");
  $("modalCount").textContent = `显示 ${list.length} 人（去重后）`;

  attachInlineOpenHandlers($("modalTbody"), true);
}

function closeModal(){
  $("modal").classList.remove("show");
}

/** ===========================
 *  11) INLINE CLICK HANDLERS
 *  =========================== */
function attachInlineOpenHandlers(rootEl, isInModal=false){
  if(!rootEl) return;
  rootEl.querySelectorAll("[data-open]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const type = el.getAttribute("data-open");
      const val  = el.getAttribute("data-value");
      if(type === "team"){
        openModal({title:`${val} 员工名单`, preset:{team:val}});
      }else if(type === "group"){
        openModal({title:`${val}（组别）员工名单`, preset:{group:val}});
      }else if(type === "pos"){
        openModal({title:`${val} 员工名单`, preset:{pos:val}});
      }else if(type === "name"){
        openModal({title:`${val}（搜索）`, preset:{}});
        $("modalSearch").value = val;
        renderModalTable();
      }else if(type === "teampos"){
        // not used here (chips handle separately)
      }else if(type === "shift"){
        openModal({title:`${val}（班次）员工名单`, preset:{shift:val}});
      }
    });
  });
}

/** ===========================
 *  12) TEAM CHIP CLICK (team cards)
 *  =========================== */
function attachTeamChipHandlers(){
  $("teamCards").querySelectorAll(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      const open = ch.getAttribute("data-open");
      const team = ch.getAttribute("data-value");
      const pos = ch.getAttribute("data-pos") || "";

      if(open === "team"){
        openModal({title:`${team} 员工名单`, preset:{team}});
      }else if(open === "teampos"){
        openModal({title:`${team} - ${pos} 员工名单`, preset:{team, pos}});
      }
    });
  });

  // position cards click
  $("posGrid").querySelectorAll(".pos-card").forEach(card=>{
    card.addEventListener("click", ()=>{
      openModal({title:`${card.getAttribute("data-value")} 员工名单`, preset:{pos:card.getAttribute("data-value")}});
    });
  });
}

/** ===========================
 *  13) NAV / PAGE RENDER
 *  =========================== */
function setPage(page){
  $("page-dashboard").classList.toggle("hidden", page!=="dashboard");
  $("page-employees").classList.toggle("hidden", page!=="employees");
  $("page-schedule").classList.toggle("hidden", page!=="schedule");

  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.getAttribute("data-page")===page);
  });

  rerenderAll();
}

function rerenderAll(){
  // Important: re-render by current tab; dashboard also needs chip handlers after render
  renderDashboard();
  attachTeamChipHandlers();

  renderEmployees();
  renderSchedule();

  // apply view toggles
  applyEmpView();
  applySchView();
}

function applyEmpView(){
  $("btnTable").classList.toggle("active", viewEmp==="table");
  $("btnCards").classList.toggle("active", viewEmp==="cards");
  $("empTableWrap").classList.toggle("hidden", viewEmp!=="table");
  $("empCardsWrap").classList.toggle("hidden", viewEmp!=="cards");
}
function applySchView(){
  $("btnSchCards").classList.toggle("active", viewSch==="cards");
  $("btnSchTable").classList.toggle("active", viewSch==="table");
  $("scheduleCards").classList.toggle("hidden", viewSch!=="cards");
  $("scheduleTable").classList.toggle("hidden", viewSch!=="table");
}

/** ===========================
 *  14) EVENTS
 *  =========================== */
function bindEvents(){
  // tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>setPage(t.getAttribute("data-page")));
  });

  // global filters
  ["qSearch","fShift","fTeam","fGroup","fPos"].forEach(id=>{
    $(id).addEventListener("input", rerenderAll);
    $(id).addEventListener("change", rerenderAll);
  });

  // emp view toggle
  $("btnTable").addEventListener("click", ()=>{viewEmp="table"; applyEmpView();});
  $("btnCards").addEventListener("click", ()=>{viewEmp="cards"; applyEmpView();});

  // schedule view toggle
  $("btnSchCards").addEventListener("click", ()=>{viewSch="cards"; applySchView();});
  $("btnSchTable").addEventListener("click", ()=>{viewSch="table"; applySchView();});

  // modal
  $("modalClose").addEventListener("click", closeModal);
  $("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) closeModal(); });

  ["modalSearch","modalShift","modalTeam","modalGroup","modalPos"].forEach(id=>{
    $(id).addEventListener("input", renderModalTable);
    $(id).addEventListener("change", renderModalTable);
  });
}

/** ===========================
 *  15) INIT
 *  =========================== */
(async function init(){
  bindEvents();
  await loadData();
  initFilters();
  rerenderAll();
})();
</script>
</body>
</html>
