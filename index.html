<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HR System (Enterprise)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#f4f7fb;
      --bg1:#eef3fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e6edf7;
      --nav:#0b1220;
      --nav2:#0f172a;
      --accent:#2563eb;
      --accent2:#22c55e;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 6px 18px rgba(2,6,23,.08);
      --r12:12px;
      --r16:16px;
      --r20:20px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #eaf2ff 0%, transparent 55%),
                  radial-gradient(1200px 600px at 90% 10%, #edf7ff 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, var(--nav), var(--nav2));
      color:#fff;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    header .brand{
      font-weight:800;
      letter-spacing:.2px;
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      font-size:12px;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent2);display:inline-block;}

    .wrap{
      max-width: 1500px;
      margin: 0 auto;
      padding: 18px;
    }

    /* top nav tabs */
    .topTabs{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      margin: 8px 0 14px;
    }
    .tab{
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.08);
      font-weight:800;
      font-size:13px;
      color: var(--ink);
      transition:.15s;
    }
    .tab:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
    .tab.active{
      background: linear-gradient(180deg, #111827, #0b1220);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
    }

    /* filters bar */
    .filterBar{
      background: rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.08);
      box-shadow: var(--shadow2);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
    }
    .filterBar input, .filterBar select{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      outline:none;
      min-width: 180px;
    }
    .filterBar .meta{
      margin-left:auto;
      color: var(--muted);
      font-size:12px;
      font-weight:700;
    }

    /* cards */
    .card{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin-top: 14px;
      backdrop-filter: blur(12px);
    }
    .card h2{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      color: var(--muted);
      font-size:13px;
      font-weight:700;
      margin-top:6px;
    }

    /* kpi rows */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:12px;
      margin-top: 14px;
    }
    @media (max-width:1100px){
      .kpiRow{ grid-template-columns: repeat(2,1fr); }
    }
    .kpi{
      background: #fff;
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 8px 20px rgba(2,6,23,.06);
      cursor:pointer;
      transition:.15s;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(2,6,23,.09); }
    .kpi .t{ font-size:12px; color:var(--muted); font-weight:900; }
    .kpi .v{ font-size:28px; font-weight:1000; margin-top:6px; }
    .kpi .hint{ font-size:12px; color:#64748b; font-weight:800; margin-top:8px; }
    .kpi .spark{
      position:absolute; right:-30px; top:-30px;
      width:120px; height:120px;
      border-radius:999px;
      background: radial-gradient(circle at 40% 40%, rgba(37,99,235,.25), transparent 55%);
      filter: blur(0px);
    }

    /* role tiles */
    .tileGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width:1200px){ .tileGrid{ grid-template-columns: repeat(3,1fr);} }
    @media (max-width:700px){ .tileGrid{ grid-template-columns: repeat(2,1fr);} }

    .tile{
      background:#fff;
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      cursor:pointer;
      transition:.14s;
      min-height: 70px;
    }
    .tile:hover{ transform: translateY(-2px); box-shadow: 0 12px 24px rgba(2,6,23,.09); }
    .tile .name{ font-weight:950; font-size:13px; }
    .tile .count{ color:var(--muted); font-weight:900; margin-top:6px; }

    /* two charts row */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:1100px){ .grid2{ grid-template-columns: 1fr; } }

    .chartBox{ height: 360px; }
    .chartBox canvas{ width:100% !important; height:100% !important; }

    /* team table */
    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      position:sticky; top:0;
      background: linear-gradient(180deg, #0b1220, #111827);
      color:#fff;
      padding:10px 10px;
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    tbody td{
      padding:9px 10px;
      border-bottom:1px solid #edf2f7;
      vertical-align:top;
    }
    tbody tr:hover{ background: #f7fbff; }
    .link{
      color: var(--accent);
      font-weight:950;
      cursor:pointer;
    }

    /* compact table for less horizontal scroll */
    .compact table{ font-size:11px; }
    .compact tbody td{ padding:8px 8px; }

    /* cards view (no horizontal scroll) */
    .cardsView{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
    }
    @media(max-width:1100px){ .cardsView{ grid-template-columns: repeat(2,1fr); } }
    @media(max-width:700px){ .cardsView{ grid-template-columns: 1fr; } }

    .empCard{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
      padding:12px;
    }
    .empCard .row1{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start;
    }
    .empCard .nm{
      font-weight:1000;
      font-size:14px;
      line-height:1.2;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background:#f8fafc;
      color:#0f172a;
      white-space:nowrap;
    }
    .empCard .meta{
      margin-top:8px;
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 10px;
    }
    .empCard .meta div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      padding:9px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      font-weight:900;
      font-size:12px;
    }
    .btn.primary{
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }

    /* modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding: 18px;
    }
    .modal .box{
      width: min(1400px, 98vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      border-radius: 22px;
      padding: 16px;
      backdrop-filter: blur(14px);
    }
    .modal .head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      position:sticky; top:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      padding: 10px 6px 12px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      z-index:2;
    }
    .modal .head h3{
      margin:0;
      font-size:16px;
      font-weight:1000;
    }
    .x{
      cursor:pointer;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:1000;
    }

    /* sections visibility */
    .page{ display:none; }
    .page.active{ display:block; }

    /* small helper text */
    .note{
      margin-top:8px;
      color: var(--muted);
      font-weight:800;
      font-size:12px;
    }
    /* ===== FORCE CENTER ALL TEXT ===== */
body,
.card,
.kpi,
.tile,
.empCard,
.modal .box,
.note,
.sub,
.badge,
.pill,
.btn,
table,
thead th,
tbody td {
  text-align: center !important;
}

/* Center flex containers */
header,
.filterBar,
.topTabs,
.kpiRow,
.grid2,
.btnRow,
.empCard .row1 {
  justify-content: center !important;
}
    /* ===== GIá»® HEADER & FILTER NHÆ¯ CÅ¨ ===== */

header{
  justify-content: space-between !important;
  text-align: left !important;
}

.filterBar{
  justify-content: flex-start !important;
  text-align: left !important;
}

.filterBar input,
.filterBar select{
  text-align: left !important;
}

.filterBar .meta{
  margin-left: auto !important;
  text-align: right !important;
}
  </style>
</head>

<body>
<header>
  <div class="brand">
    HR System
    <span class="badge"><span class="dot"></span> Public view</span>
  </div>
  <div class="badge">Google Sheet â†’ opensheet</div>
</header>

<div class="wrap">
  <div class="topTabs">
    <div class="tab active" data-page="dashboard">æ€»æ±‡</div>
    <div class="tab" data-page="employees">åå•</div>
    <div class="tab" data-page="schedule">æ’ç­è¡¨</div>
    <div class="tab" data-page="pan">ç›˜å£äººæ•°</div>
  </div>

  <div class="filterBar" id="filterBar">
    <input id="q" placeholder="Search name / ID / team / group / position / manager" />
    <select id="shiftSel"></select>
    <select id="teamSel"></select>
    <select id="groupSel"></select>
    <select id="posSel"></select>
    <select id="panSel"></select>
    <div class="meta" id="meta">Loadingâ€¦</div>
  </div>

  <!-- Dashboard -->
  <div class="page active" id="page-dashboard"></div>

  <!-- Employees -->
  <div class="page" id="page-employees"></div>

  <!-- Schedule -->
  <div class="page" id="page-schedule"></div>
  <div class="page" id="page-pan"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <div class="head">
      <h3 id="modalTitle">Title</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="modalBack" style="display:none;">â† Back</button>
        <button class="x" id="modalClose">Close</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =========================================================
   CONFIG
   ========================================================= */
const SHEET_API = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/å°å¼ 1";

/*
  Column mapping (by header names from your sheet):
  - è´Ÿè´£äºº
  - ç°åœºåŸ¹è®­
  - çº¿ä¸Šç»„é•¿
  - çº¿ä¸ŠåŸ¹è®­
  - ç»„åˆ«
  - å›¢é˜Ÿ (col F)
  - å§“å (col G)  âœ… STRICT KEY
  - ID
  - å›½å®¶
  - å²—ä½
  - ç›˜å£
  - ç­æ¬¡ (col I)
*/

let RAW = [];
let FILTERED = [];

let charts = { pos:null, team:null, shift:null };

const els = {
  pageDashboard: document.getElementById("page-dashboard"),
  pageEmployees: document.getElementById("page-employees"),
  pageSchedule: document.getElementById("page-schedule"),
  pagePan: document.getElementById("page-pan"),

  tabs: document.querySelectorAll(".tab"),

  q: document.getElementById("q"),
  shiftSel: document.getElementById("shiftSel"),
  teamSel: document.getElementById("teamSel"),
  groupSel: document.getElementById("groupSel"),
  posSel: document.getElementById("posSel"),
  panSel: document.getElementById("panSel"),
  meta: document.getElementById("meta"),

  modal: document.getElementById("modal"),
  modalTitle: document.getElementById("modalTitle"),
  modalBody: document.getElementById("modalBody"),
  modalClose: document.getElementById("modalClose"),
  modalBack: document.getElementById("modalBack")
};

function s(v){ return (v ?? "").toString().trim(); }
function norm(v){ return s(v).replace(/\s+/g," ").trim(); }
function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
function esc(str){
  return (str??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================================================
   âœ… NEW: header-safe pick (chá»‘ng opensheet header lá»‡ch)
   ========================================================= */
function pick(r, keys){
  for(const k of keys){
    if(Object.prototype.hasOwnProperty.call(r, k)){
      const v = (r[k] ?? "").toString();
      if(v.trim() !== "") return v;
    }
  }
  // fallback: try loose match (trim keys of object)
  const objKeys = Object.keys(r || {});
  for(const want of keys){
    const w = (want ?? "").toString().trim();
    const found = objKeys.find(ok => ok.toString().trim() === w);
    if(found){
      const v = (r[found] ?? "").toString();
      if(v.trim() !== "") return v;
    }
  }
  return "";
}
function normPick(r, keys){ return norm(pick(r, keys)); }

function isValidName(name){
  const v = norm(name);
  if(!v) return false;
  const low = v.toLowerCase();
  if(low === "null" || low === "undefined") return false;
  if(v.replace(/\s/g,"") === "") return false;
  return true;
}

/* =========================================================
   NAV
   ========================================================= */
els.tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    els.tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const p = t.dataset.page;
    document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active"));
    document.getElementById("page-"+p).classList.add("active");
  });
});

/* =========================================================
   MODAL + STACK NAV INSIDE MODAL
   ========================================================= */
let modalStack = [];

function openModal(title, html){
  els.modalTitle.textContent = title;
  els.modalBody.innerHTML = html;
  els.modal.style.display="flex";
  els.modalBack.style.display = modalStack.length ? "inline-flex" : "none";
}
function pushModal(title, html){
  modalStack.push({ title: els.modalTitle.textContent, html: els.modalBody.innerHTML });
  els.modalBack.style.display = "inline-flex";
  openModal(title, html);
}
function closeModal(){
  els.modal.style.display="none";
  els.modalBody.innerHTML="";
  els.modalTitle.textContent="";
  modalStack = [];
  els.modalBack.style.display = "none";
}
els.modalClose.onclick = closeModal;
els.modal.onclick = (e)=>{ if(e.target === els.modal) closeModal(); };
els.modalBack.onclick = ()=>{
  const prev = modalStack.pop();
  if(!prev){ els.modalBack.style.display="none"; return; }
  openModal(prev.title, prev.html);
  els.modalBack.style.display = modalStack.length ? "inline-flex" : "none";
};

/* =========================================================
   FILTERS
   ========================================================= */
function buildSelectOptions(selectEl, items, labelAll){
  const opts = [`<option value="">${esc(labelAll)}</option>`]
    .concat(items.map(x=>`<option value="${esc(x)}">${esc(x)}</option>`));
  selectEl.innerHTML = opts.join("");
}

function applyFilters(){
  const q = norm(els.q.value).toLowerCase();
  const shift = els.shiftSel.value;
  const team  = els.teamSel.value;
  const group = els.groupSel.value;
  const pos   = els.posSel.value;
  const pan   = els.panSel.value;

  FILTERED = RAW.filter(r=>{
    const å§“å = norm(r["å§“å"]);
    const ID = norm(r["ID"]);
    const å›¢é˜Ÿ = norm(r["å›¢é˜Ÿ"]);
    const ç»„åˆ« = norm(r["ç»„åˆ«"]);
    const å²—ä½ = norm(r["å²—ä½"]);
    const ç­æ¬¡ = norm(r["ç­æ¬¡"]);
    const ç›˜å£ = norm(r["ç›˜å£"]);

    const è´Ÿè´£äºº = norm(r["è´Ÿè´£äºº"]);
    const ç°åœºåŸ¹è®­ = norm(r["ç°åœºåŸ¹è®­"]);
    const çº¿ä¸Šç»„é•¿ = norm(r["çº¿ä¸Šç»„é•¿"]);
    const çº¿ä¸ŠåŸ¹è®­ = norm(r["çº¿ä¸ŠåŸ¹è®­"]);

    if(shift && ç­æ¬¡ !== shift) return false;
    if(team && å›¢é˜Ÿ !== team) return false;
    if(group && ç»„åˆ« !== group) return false;
    if(pos && å²—ä½ !== pos) return false;
    if(pan && ç›˜å£ !== pan) return false;

    if(q){
      const hay = [
        å§“å, ID, å›¢é˜Ÿ, ç»„åˆ«, å²—ä½, ç­æ¬¡,
        è´Ÿè´£äºº, ç°åœºåŸ¹è®­, çº¿ä¸Šç»„é•¿, çº¿ä¸ŠåŸ¹è®­
      ].join(" ").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  els.meta.textContent = `Rows: ${RAW.length.toLocaleString()} â€¢ Filtered: ${FILTERED.length.toLocaleString()} â€¢ ${new Date().toLocaleString()}`;

  renderDashboard();
  renderEmployees();
  renderSchedule();
  renderPanPage();
}

["input","change"].forEach(evt=>{
  els.q.addEventListener(evt, applyFilters);
  els.shiftSel.addEventListener(evt, applyFilters);
  els.teamSel.addEventListener(evt, applyFilters);
  els.groupSel.addEventListener(evt, applyFilters);
  els.posSel.addEventListener(evt, applyFilters);
  els.panSel.addEventListener(evt, applyFilters);
});

/* =========================================================
   STATS HELPERS
   ========================================================= */
// Total unique people set = å§“å + çº¿ä¸Šç»„é•¿ + çº¿ä¸ŠåŸ¹è®­ (as you requested)
function getTotalPeopleSet(rows){
  const set = new Set();
  rows.forEach(r=>{
    const name = norm(r["å§“å"]);
    const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
    const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);

    if(!isValidName(name)) return;

    set.add(name);
    if(isValidName(leader)) set.add(leader);
    if(isValidName(trainer)) set.add(trainer);
  });
  return set;
}

function getUniqueSetByField(rows, field){
  const set = new Set();
  rows.forEach(r=>{
    const v = norm(r[field]);
    if(v) set.add(v);
  });
  return set;
}

function groupBy(rows, field, emptyLabel="æœªå¡«å†™"){
  const m = new Map();
  rows.forEach(r=>{
    const k = norm(r[field]) || emptyLabel;
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  });
  return m;
}

function countByUniqueName(rows){
  const set = new Set();
  rows.forEach(r=>{
    const name = norm(r["å§“å"]);
    if(isValidName(name)) set.add(name);
  });
  return set.size;
}

/* =========================================================
   MODAL TABLE RENDER
   ========================================================= */
function renderFullTable(rows, titleHint=""){
  const cols = ["è´Ÿè´£äºº","ç°åœºåŸ¹è®­","çº¿ä¸Šç»„é•¿","çº¿ä¸ŠåŸ¹è®­","ç»„åˆ«","å›¢é˜Ÿ","ç­æ¬¡","å²—ä½","å§“å","ID","å›½å®¶","ç›˜å£"];
  return `
    <div class="note">${esc(titleHint)}  Rows: <b>${rows.length.toLocaleString()}</b></div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              ${cols.map(c=>`<td>${esc(norm(r[c]))}</td>`).join("")}
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

/* =========================================================
   MANAGER â†’ SUBORDINATES
   ========================================================= */
function openManagerList(fieldLabel, rows){
  const set = getUniqueSetByField(rows, fieldLabel);
  const names = [...set].sort((a,b)=>a.localeCompare(b,"zh"));
  const html = `
    <div class="note">ç‚¹å‡»åå­— â†’ æŸ¥çœ‹è¯¥ ${esc(fieldLabel)} ç®¡ç†çš„å‘˜å·¥ï¼ˆä»è¡¨é‡ŒåŒ¹é…åŒåå­—æ®µï¼‰ã€‚</div>
    <div class="tileGrid">
      ${names.map(n=>{
        const subs = rows.filter(r=>norm(r[fieldLabel])===n);
        const c = countByUniqueName(subs);
        return `
          <div class="tile" onclick="openManagerSubs('${esc(fieldLabel)}','${esc(n)}')">
            <div class="name">${esc(n)}</div>
            <div class="count">ä¸‹å±: ${c}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;
  openModal(`${fieldLabel} åå•ï¼ˆ${names.length}ï¼‰`, html);
}

window.openManagerSubs = function(fieldLabel, managerName){
  const subs = FILTERED.filter(r=>norm(r[fieldLabel])===managerName);
  pushModal(`${fieldLabel}ï¼š${managerName}ï¼ˆä¸‹å± ${countByUniqueName(subs)}ï¼‰`, renderFullTable(subs, `${fieldLabel} = ${managerName}`));
};

/* =========================================================
   DASHBOARD
   ========================================================= */
function renderDashboard(){
  const rows = FILTERED;

  const totalPeopleSet = getTotalPeopleSet(rows);
  const totalPeople = totalPeopleSet.size;

  const ownerSet  = getUniqueSetByField(rows,"è´Ÿè´£äºº");
  const onsiteSet = getUniqueSetByField(rows,"ç°åœºåŸ¹è®­");
  const leaderSet = getUniqueSetByField(rows,"çº¿ä¸Šç»„é•¿");
  const trainSet  = getUniqueSetByField(rows,"çº¿ä¸ŠåŸ¹è®­");

  // Positions distribution (å²—ä½) by unique å§“å
  const posMap = groupBy(rows,"å²—ä½");
  const posLabels = [...posMap.keys()];
  const posCounts = posLabels.map(k=>countByUniqueName(posMap.get(k)));

  // Teams distribution (å›¢é˜Ÿ=col F) by unique å§“å
  const teamMap = groupBy(rows,"å›¢é˜Ÿ");
  const teamLabels = [...teamMap.keys()];
  const teamCounts = teamLabels.map(k=>countByUniqueName(teamMap.get(k)));

  // Team detail table: each team show total + each position count
  const allPositions = uniq(rows.map(r=>norm(r["å²—ä½"])||"æœªå¡«å†™")).sort((a,b)=>a.localeCompare(b,"zh"));

  const teamRows = [...teamMap.entries()]
    .map(([team, list])=>{
      const total = countByUniqueName(list);

      const byPosSet = new Map();
      allPositions.forEach(p=>byPosSet.set(p, new Set()));

      list.forEach(r=>{
        const p = norm(r["å²—ä½"])||"æœªå¡«å†™";
        const nm = norm(r["å§“å"]);
        if(isValidName(nm)) byPosSet.get(p).add(nm);
      });

      const byPosFinal = allPositions.map(p=>byPosSet.get(p).size);

      return { team, list, total, byPosFinal };
    })
    .sort((a,b)=>b.total-a.total);

  els.pageDashboard.innerHTML = `
    <div class="card">
      <h2>ç»Ÿè®¡æ€»è§ˆ</h2>
      <div class="sub">æŒ‰å²—ä½ & å›¢é˜Ÿç»Ÿè®¡ï¼ˆç‚¹å‡»å¡ç‰‡/å›¾è¡¨å¯å¼¹çª—æŸ¥çœ‹å‘˜å·¥åå•ï¼‰</div>

      <div class="kpiRow">
        <div class="kpi" onclick="openModal('æ€»äººæ•°åå•ï¼ˆå»é‡é€»è¾‘ï¼šå§“å+çº¿ä¸Šç»„é•¿+çº¿ä¸ŠåŸ¹è®­ï¼‰', renderFullTable(FILTERED,'å»é‡ç»Ÿè®¡ä¸å½±å“åå•å±•ç¤ºï¼šè¿™é‡Œå±•ç¤ºç­›é€‰åçš„æ‰€æœ‰åŸå§‹è¡Œ'))">
          <div class="spark"></div>
          <div class="t">æ€»äººæ•°ï¼ˆå»é‡ï¼‰</div>
          <div class="v">${totalPeople.toLocaleString()}</div>
          <div class="hint">å§“å + çº¿ä¸Šç»„é•¿ + çº¿ä¸ŠåŸ¹è®­ï¼ˆuniqueï¼‰</div>
        </div>

        <div class="kpi" onclick="openManagerList('è´Ÿè´£äºº', FILTERED)">
          <div class="spark"></div>
          <div class="t">è´Ÿè´£äºº</div>
          <div class="v">${ownerSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('ç°åœºåŸ¹è®­', FILTERED)">
          <div class="spark"></div>
          <div class="t">ç°åœºåŸ¹è®­</div>
          <div class="v">${onsiteSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('çº¿ä¸Šç»„é•¿', FILTERED)">
          <div class="spark"></div>
          <div class="t">çº¿ä¸Šç»„é•¿</div>
          <div class="v">${leaderSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('çº¿ä¸ŠåŸ¹è®­', FILTERED)">
          <div class="spark"></div>
          <div class="t">çº¿ä¸ŠåŸ¹è®­</div>
          <div class="v">${trainSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
<div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
  <div>
    <div style="font-weight:1000; font-size:16px;">å²—ä½åˆ†å¸ƒ</div>
    <div class="note">ç‚¹å‡»å›¾ä¾‹æˆ–å›¾å½¢ â†’ å¼¹å‡ºè¯¥å²—ä½å‘˜å·¥åå•</div>
  </div>
  <button class="btn" onclick="openModal('å²—ä½ç»Ÿè®¡ï¼ˆæŒ‰å§“åå»é‡ï¼‰', renderTeamOrPosSummary('å²—ä½','å²—ä½'))">
    æŸ¥çœ‹æ±‡æ€»
  </button>
</div>

</div>
        <div class="chartBox"><canvas id="chartPos"></canvas></div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:1000; font-size:16px;">å›¢é˜Ÿäººæ•°ï¼ˆcá»™t Fï¼šå›¢é˜Ÿï¼‰</div>
            <div class="note">ç‚¹å‡»æŸ±å­ â†’ å¼¹å‡ºè¯¥å›¢é˜Ÿå‘˜å·¥åå•</div>
          </div>
          <button class="btn" onclick="openModal('å›¢é˜Ÿç»Ÿè®¡ï¼ˆæŒ‰å§“åå»é‡ï¼‰', renderTeamOrPosSummary('å›¢é˜Ÿ','å›¢é˜Ÿ'))">æŸ¥çœ‹æ±‡æ€»</button>
        </div>
        <div class="chartBox"><canvas id="chartTeam"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <div style="font-weight:1000; font-size:16px;">å›¢é˜Ÿç»Ÿè®¡è¡¨ï¼ˆcá»™t Fï¼‰</div>
          <div class="note">ç‚¹å‡»ä»»æ„æ•°å­— â†’ å¼¹çª—æŸ¥çœ‹å¯¹åº”å‘˜å·¥åå•</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>å›¢é˜Ÿ</th>
              <th>æ€»äººæ•°</th>
              ${allPositions.map(p=>`<th>${esc(p)}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${teamRows.map(tr=>{
              const cells = tr.byPosFinal.map((n,idx)=>{
                const pos = allPositions[idx];
                return `<td class="link" onclick="openTeamPos('${esc(tr.team)}','${esc(pos)}')">${n}</td>`;
              }).join("");
              return `
                <tr>
                  <td class="link" onclick="openTeam('${esc(tr.team)}')">${esc(tr.team)}</td>
                  <td class="link" onclick="openTeam('${esc(tr.team)}')">${tr.total}</td>
                  ${cells}
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;

  buildPosChart(posLabels, posCounts);
  buildTeamChart(teamLabels, teamCounts);
}

function renderTeamOrPosSummary(fieldLabel, fieldName){
  const m = groupBy(FILTERED, fieldName);
  const rows = [...m.entries()]
    .map(([k,list])=>({k, c: countByUniqueName(list)}))
    .sort((a,b)=>b.c-a.c);

  return `
    <div class="tableWrap">
      <table>
        <thead><tr><th>${esc(fieldLabel)}</th><th>äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰</th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td class="link" onclick="${fieldName==='å›¢é˜Ÿ' ? `openTeam('${esc(r.k)}')` : `openPos('${esc(r.k)}')`}">${esc(r.k)}</td>
              <td>${r.c}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function buildPosChart(labels, values){
  const ctx = document.getElementById("chartPos");
  if(!ctx) return;
  if(charts.pos) charts.pos.destroy();

  charts.pos = new Chart(ctx, {
    type:"doughnut",
    data:{ labels, datasets:[{ data: values }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ position:"top", labels:{ boxWidth:18, font:{ size:11, weight:"700" } } }
      },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        openPos(labels[idx]);
      }
    }
  });
}

function buildTeamChart(labels, values){
  const ctx = document.getElementById("chartTeam");
  if(!ctx) return;
  if(charts.team) charts.team.destroy();

  charts.team = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰", data: values }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ font:{ size:10, weight:"700" }, maxRotation:60, minRotation:60 } },
        y:{ ticks:{ font:{ size:10, weight:"700" } } }
      },
      plugins:{ legend:{ display:false } },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        openTeam(labels[idx]);
      }
    }
  });
}

window.openPos = function(pos){
  const rows = FILTERED.filter(r=> (norm(r["å²—ä½"])||"æœªå¡«å†™") === pos );
  openModal(`${pos} å‘˜å·¥åå•ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å²—ä½ = ${pos}`));
};

window.openTeam = function(team){
  const rows = FILTERED.filter(r=> (norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™") === team );
  openModal(`${team} å‘˜å·¥åå•ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å›¢é˜Ÿ(cá»™t F) = ${team}`));
};

window.openTeamPos = function(team, pos){
  const rows = FILTERED.filter(r=> (norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")===team && (norm(r["å²—ä½"])||"æœªå¡«å†™")===pos );
  openModal(`${team} Â· ${pos}ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å›¢é˜Ÿ = ${team} ä¸” å²—ä½ = ${pos}`));
};

  window.openPan = function(pan){
  const rows = FILTERED.filter(r=> norm(r["ç›˜å£"]) === pan);
  openModal(`ç›˜å£ï¼š${pan}`, renderFullTable(rows, `ç›˜å£ = ${pan}`));
};

/* =========================================================
   EMPLOYEES PAGE
   ========================================================= */
let empViewMode = "cards"; // default to avoid horizontal scroll

function renderEmployees(){
  const rows = FILTERED;

  const header = `
    <div class="card">
      <h2>Employees</h2>
      <div class="sub">æ”¯æŒç­›é€‰/æœç´¢ã€‚é»˜è®¤ Cards è§†å›¾é¿å…æ¨ªå‘æ»šåŠ¨ã€‚</div>
      <div class="btnRow">
        <button class="btn ${empViewMode==='cards'?'primary':''}" onclick="setEmpView('cards')">Cards viewï¼ˆä¸æ¨ªæ»šï¼‰</button>
        <button class="btn ${empViewMode==='table'?'primary':''}" onclick="setEmpView('table')">Table viewï¼ˆå®Œæ•´åˆ—ï¼‰</button>
        <button class="btn" onclick="openModal('Employeesï¼ˆå®Œæ•´è¡¨ï¼‰', renderFullTable(FILTERED,'ç­›é€‰åçš„å®Œæ•´å‘˜å·¥è¡¨'))">å¼¹çª—å…¨å±æŸ¥çœ‹</button>
      </div>
    </div>
  `;

  let body = "";
  if(empViewMode==="cards"){
    body = `
      <div class="card">
        <div class="cardsView">
          ${rows.map(r=>{
            const nm = norm(r["å§“å"]);
            const pos = norm(r["å²—ä½"])||"æœªå¡«å†™";
            const team = norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™";
            const grp = norm(r["ç»„åˆ«"])||"æœªå¡«å†™";
            const shift = norm(r["ç­æ¬¡"])||"";
            const id = norm(r["ID"])||"";
            const country = norm(r["å›½å®¶"])||"";
            const pan = norm(r["ç›˜å£"])||"";
            const owner = norm(r["è´Ÿè´£äºº"])||"";
            const onsite = norm(r["ç°åœºåŸ¹è®­"])||"";
            const leader = norm(r["çº¿ä¸Šç»„é•¿"])||"";
            const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"])||"";
            return `
              <div class="empCard">
                <div class="row1">
                  <div>
                    <div class="nm">${esc(nm||"(æœªå¡«å†™å§“å)")}</div>
                    <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                      <span class="pill">${esc(pos)}</span>
                      <span class="pill">å›¢é˜Ÿ: ${esc(team)}</span>
                      <span class="pill">ç»„åˆ«: ${esc(grp)}</span>
                      ${shift ? `<span class="pill">ç­æ¬¡: ${esc(shift)}</span>` : ``}
                    </div>
                  </div>
                  <div style="text-align:right;">
                    <div class="pill">${esc(id||"No ID")}</div>
                    <div style="margin-top:8px; color:var(--muted); font-weight:900; font-size:12px;">${esc(country)}</div>
                  </div>
                </div>
                <div class="meta">
                  <div>è´Ÿè´£äºº: <span class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner||"-")}</span></div>
                  <div>ç°åœºåŸ¹è®­: <span class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite||"-")}</span></div>
                  <div>çº¿ä¸Šç»„é•¿: <span class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader||"-")}</span></div>
                  <div>çº¿ä¸ŠåŸ¹è®­: <span class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer||"-")}</span></div>
                  <div style="grid-column:1 / -1;">ç›˜å£: ${esc(pan||"-")}</div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }else{
    body = `
      <div class="card compact">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>å§“å</th><th>ID</th><th>å²—ä½</th><th>å›¢é˜Ÿ(cá»™t F)</th><th>ç»„åˆ«</th><th>ç­æ¬¡(cá»™t I)</th>
                <th>è´Ÿè´£äºº</th><th>ç°åœºåŸ¹è®­</th><th>çº¿ä¸Šç»„é•¿</th><th>çº¿ä¸ŠåŸ¹è®­</th><th>å›½å®¶</th><th>ç›˜å£</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>{
                const owner = norm(r["è´Ÿè´£äºº"]);
                const onsite = norm(r["ç°åœºåŸ¹è®­"]);
                const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
                const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);
                return `
                  <tr>
                    <td>${esc(norm(r["å§“å"]))}</td>
                    <td>${esc(norm(r["ID"]))}</td>
                    <td class="link" onclick="openPos('${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}')">${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}</td>
                    <td class="link" onclick="openTeam('${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}')">${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}</td>
                    <td>${esc(norm(r["ç»„åˆ«"]))}</td>
                    <td>${esc(norm(r["ç­æ¬¡"]))}</td>
                    <td class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner)}</td>
                    <td class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite)}</td>
                    <td class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader)}</td>
                    <td class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer)}</td>
                    <td>${esc(norm(r["å›½å®¶"]))}</td>
                    <td>${esc(norm(r["ç›˜å£"]))}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  els.pageEmployees.innerHTML = header + body;
}

window.setEmpView = function(mode){
  empViewMode = mode;
  renderEmployees();
};

/* =========================================================
   SCHEDULE PAGEï¼ˆæ’ç­è¡¨ï¼‰
   âœ… FIX: ä¸å†æŠŠç©ºç­æ¬¡å½’ç±»ä¸º â€œæœªå¡«å†™â€
   - ç»Ÿè®¡ï¼šåªç»Ÿè®¡æœ‰ç­æ¬¡çš„è¡Œ
   - å¦å¤–å•ç‹¬ç»™ä¸€ä¸ª KPIï¼šæœªå¡«å†™ç­æ¬¡ï¼ˆå¯ç‚¹å¼€çœ‹æ˜¯è°ï¼‰
   ========================================================= */
function renderSchedule(){

  // ğŸ”¥ CHá»ˆ Láº¤Y DÃ’NG CÃ“ TÃŠN (Cá»˜T G)
  const rows = RAW.filter(r => isValidName(r["å§“å"]));

  // ğŸ”¥ Chá»‰ sau khi cháº¯c cháº¯n cÃ³ å§“å má»›i xÃ©t ç­æ¬¡
  const rowsWithShift = rows.filter(r => norm(r["ç­æ¬¡"]) !== "");
  const rowsNoShift   = rows.filter(r => norm(r["ç­æ¬¡"]) === "");

  // group only by REAL shift values (no empty label)
  const shiftMap = groupBy(rowsWithShift, "ç­æ¬¡", ""); // emptyLabel won't be used because we filtered
  const shiftLabels = [...shiftMap.keys()].filter(k=>k!=="");
  const shiftCounts = shiftLabels.map(k=>countByUniqueName(shiftMap.get(k)));

  const shiftCards = shiftLabels
    .map((k,idx)=>({k, c: shiftCounts[idx]}))
    .sort((a,b)=>b.c-a.c)
    .map(x=>`
      <div class="kpi" style="min-height:86px" onclick="openShift('${esc(x.k)}')">
        <div class="spark"></div>
        <div class="t">ç­æ¬¡</div>
        <div class="v" style="font-size:24px">${esc(x.k)}</div>
        <div class="hint">${x.c} äººï¼ˆæŒ‰å§“åå»é‡ï¼‰</div>
      </div>
    `).join("");

  const noShiftUnique = countByUniqueName(rowsNoShift);

  els.pageSchedule.innerHTML = `
    <div class="card">
      <h2>æ’ç­è¡¨</h2>
      <div class="sub">æŒ‰ç­æ¬¡ç»Ÿè®¡ï¼ˆç­æ¬¡æ¥è‡ª Google Sheet cá»™t Iï¼‰ã€‚âœ… å·²ä¿®å¤ï¼šç©ºç­æ¬¡ä¸å†æ˜¾ç¤ºä¸ºâ€œç­æ¬¡: æœªå¡«å†™â€ã€‚</div>
    </div>

    <div class="card">
      <div style="font-weight:1000; font-size:16px;">ç­æ¬¡ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡æœ‰ç­æ¬¡çš„è¡Œï¼‰</div>
      <div class="note">ä½ è¯´ â€œä¸­ç­ä¼šæœ‰å¤šä¸ªæ—¶é—´æ®µâ€ï¼Œæ‰€ä»¥å¿…é¡»ä» cá»™t Iï¼ˆç­æ¬¡ï¼‰å– uniqueï¼›è¿™é‡Œå·²æŒ‰ä½ è¦æ±‚ã€‚</div>

      <div class="kpiRow" style="grid-template-columns:repeat(3,1fr)">
        ${shiftCards || `<div class="note">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç­æ¬¡æ•°æ®ï¼ˆå…¨éƒ¨ä¸ºç©ºæˆ–è¢«ç­›é€‰æ‰ï¼‰</div>`}
        <div class="kpi" style="min-height:86px" onclick="openNoShift()">
          <div class="spark"></div>
          <div class="t">æœªå¡«å†™ç­æ¬¡</div>
          <div class="v" style="font-size:24px">${noShiftUnique.toLocaleString()}</div>
          <div class="hint">æŒ‰å§“åå»é‡ï¼ˆç‚¹å‡»æŸ¥çœ‹åå•ï¼‰</div>
        </div>
      </div>

      <div class="chartBox" style="margin-top:14px"><canvas id="chartShift"></canvas></div>
    </div>

    <div class="card compact">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:1000; font-size:16px;">æ’ç­æ˜ç»†ï¼ˆå…¨éƒ¨äººå‘˜ï¼Œä¸é™åˆ¶ 18ï¼‰</div>
          <div class="note">å¦‚æœä½ ä¸æƒ³æ¨ªå‘æ»šåŠ¨ï¼šå»ºè®®ç”¨ Employees çš„ Cards viewï¼›è¿™é‡Œæä¾› compact table çœ‹æ›´å¤šè¡Œã€‚</div>
        </div>
        <button class="btn" onclick="openModal('æ’ç­æ˜ç»†ï¼ˆå¼¹çª—å…¨å±ï¼‰', renderFullTable(FILTERED,'æ’ç­æ˜ç»†ï¼šç­›é€‰åçš„æ‰€æœ‰è¡Œ'))">å¼¹çª—å…¨å±æŸ¥çœ‹</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>è´Ÿè´£äºº</th><th>ç°åœºåŸ¹è®­</th><th>çº¿ä¸Šç»„é•¿</th><th>çº¿ä¸ŠåŸ¹è®­</th>
              <th>å›¢é˜Ÿ(cá»™t F)</th><th>ç»„åˆ«</th><th>ç­æ¬¡(cá»™t I)</th><th>å²—ä½</th><th>å§“å</th><th>ID</th><th>å›½å®¶</th><th>ç›˜å£</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const owner = norm(r["è´Ÿè´£äºº"]);
              const onsite = norm(r["ç°åœºåŸ¹è®­"]);
              const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
              const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);
              return `
                <tr>
                  <td class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner)}</td>
                  <td class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite)}</td>
                  <td class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader)}</td>
                  <td class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer)}</td>
                  <td class="link" onclick="openTeam('${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}')">${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}</td>
                  <td>${esc(norm(r["ç»„åˆ«"]))}</td>
                  <td>${esc(norm(r["ç­æ¬¡"]))}</td>
                  <td class="link" onclick="openPos('${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}')">${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}</td>
                  <td>${esc(norm(r["å§“å"]))}</td>
                  <td>${esc(norm(r["ID"]))}</td>
                  <td>${esc(norm(r["å›½å®¶"]))}</td>
                  <td>${esc(norm(r["ç›˜å£"]))}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;

  buildShiftChart(shiftLabels, shiftCounts);
}

window.openShift = function(shift){
  const rows = FILTERED.filter(r=> norm(r["ç­æ¬¡"]) === shift);
  openModal(`ç­æ¬¡ï¼š${shift}ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `ç­æ¬¡(cá»™t I) = ${shift}`));
};

window.openNoShift = function(){
  const rows = FILTERED.filter(r=> norm(r["ç­æ¬¡"]) === "");
  openModal(`æœªå¡«å†™ç­æ¬¡ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `ç­æ¬¡(cá»™t I) ä¸ºç©º`));
};

function buildShiftChart(labels, values){
  const ctx = document.getElementById("chartShift");
  if(!ctx) return;
  if(charts.shift) charts.shift.destroy();

  charts.shift = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰", data: values }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ ticks:{ font:{ size:10, weight:"700" }, maxRotation:45, minRotation:45 } },
        y:{ ticks:{ font:{ size:10, weight:"700" } } }
      },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        openShift(labels[idx]);
      }
    }
  });
}

/* =========================================================
   LOAD â€“ STRICT BY COLUMN INDEX (Cá»˜T G LÃ€ CHUáº¨N)
   ========================================================= */
async function load(){
  try{
    els.meta.textContent = "Loading data from Google Sheetâ€¦";

    const res = await fetch(SHEET_API, { cache:"no-store" });
    if(!res.ok) throw new Error("Fetch failed: " + res.status);

    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("Sheet JSON is not array");

    RAW = data
      .map(r=>({
        // âœ… header-safe: chá»‘ng lá»‡ch cá»™t khi copy sheet / Ä‘á»•i tab / Ä‘á»•i file
        "è´Ÿè´£äºº":   normPick(r, ["è´Ÿè´£äºº","è² è²¬äºº","Owner","owner"]),
        "ç°åœºåŸ¹è®­": normPick(r, ["ç°åœºåŸ¹è®­","ç¾å ´åŸ¹è¨“","Onsite Training","ç°åœºè®­","ç¾å ´è¨“ç·´"]),
        "çº¿ä¸Šç»„é•¿": normPick(r, ["çº¿ä¸Šç»„é•¿","ç·šä¸Šçµ„é•·","Online Leader","ç»„é•¿","çµ„é•·"]),
        "çº¿ä¸ŠåŸ¹è®­": normPick(r, ["çº¿ä¸ŠåŸ¹è®­","ç·šä¸ŠåŸ¹è¨“","Online Training","çº¿ä¸Šè®­","ç·šä¸Šè¨“ç·´"]),
        "ç»„åˆ«":     normPick(r, ["ç»„åˆ«","çµ„åˆ¥","Group","group"]),
        "å›¢é˜Ÿ":     normPick(r, ["å›¢é˜Ÿ","åœ˜éšŠ","Team","team"]),

        // âœ… Cá»˜T G chuáº©n: å§“å (dÃ¹ng lÃ m Ä‘iá»u kiá»‡n giá»¯ dÃ²ng)
        "å§“å":     normPick(r, ["å§“å","å‘˜å·¥å§“å","å“¡å·¥å§“å","Name","name"]),

        "ID":       normPick(r, ["ID","Id","å‘˜å·¥ID","å“¡å·¥ID"]),

        // âœ… ç­æ¬¡ váº«n láº¥y tá»« cá»™t ç­æ¬¡, nhÆ°ng chá»‰ giá»¯ dÃ²ng khi å§“å há»£p lá»‡
        "ç­æ¬¡":     normPick(r, ["ç­æ¬¡","Shift","shift","ç­ æ¬¡","ç­æ¬¡ "]),

        // âœ… ç›˜å£/ç›˜å£ ráº¥t hay lá»‡ch tÃªn header => thÃªm alias Ä‘áº§y Ä‘á»§
        "ç›˜å£":     normPick(r, ["ç›˜å£","ç›¤å£","ID WORKFOLIO","Workfolio","workfolio","ç›˜å£ID","ç›˜å£ID"]),

        "å›½å®¶":     normPick(r, ["å›½å®¶","åœ‹å®¶","Country","country"]),
        "å²—ä½":     normPick(r, ["å²—ä½","å´—ä½","Position","position"])
      }))
      // âœ… chá»‰ giá»¯ dÃ²ng cÃ³ å§“å há»£p lá»‡ (cá»™t G)
      .filter(r => isValidName(r["å§“å"]));

    // ===== Build filter options =====
    const shifts = uniq(RAW.map(r=>r["ç­æ¬¡"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
    const teams  = uniq(RAW.map(r=>r["å›¢é˜Ÿ"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
    const groups = uniq(RAW.map(r=>r["ç»„åˆ«"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
    const poss   = uniq(RAW.map(r=>r["å²—ä½"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
    const pans = uniq(RAW.map(r=>r["ç›˜å£"]).filter(Boolean))
  .sort((a,b)=>a.localeCompare(b,"zh"));

buildSelectOptions(els.panSel, pans, "All ç›˜å£ï¼ˆç›˜å£ï¼‰");

    buildSelectOptions(els.shiftSel, shifts, "All shiftsï¼ˆç­æ¬¡ï¼‰");
    buildSelectOptions(els.teamSel, teams, "All teamsï¼ˆå›¢é˜Ÿï¼‰");
    buildSelectOptions(els.groupSel, groups, "All groupsï¼ˆç»„åˆ«ï¼‰");
    buildSelectOptions(els.posSel, poss, "All positionsï¼ˆå²—ä½ï¼‰");

    applyFilters();
  }catch(err){
    console.error(err);
    els.meta.textContent = "Load error: " + (err?.message || err);
    els.pageDashboard.innerHTML = `
      <div class="card">
        <h2>Sheet Load Error</h2>
        <div class="note">${esc(err?.message || String(err))}</div>
      </div>
    `;
  }
}
function renderPanPage(){

  const rows = FILTERED;

  const panMap = new Map();
  const totalSet = new Set();

  rows.forEach(r=>{
    const pan = norm(r["ç›˜å£"]) || "æœªå¡«å†™";
    const shift = norm(r["ç­æ¬¡"]);
    const pos = norm(r["å²—ä½"]);
    const name = norm(r["å§“å"]);

    if(!isValidName(name)) return;

    totalSet.add(name);

    if(!panMap.has(pan)){
      panMap.set(pan,{
        names: new Set(),
        day: new Set(),
        night: new Set(),
        mid: new Set(),
        posMap: new Map()
      });
    }

    const obj = panMap.get(pan);
    obj.names.add(name);

    if(shift.includes("Day")) obj.day.add(name);
    if(shift.includes("Night")) obj.night.add(name);
    if(shift.includes("ä¸­")) obj.mid.add(name);

    if(!obj.posMap.has(pos)) obj.posMap.set(pos,new Set());
    obj.posMap.get(pos).add(name);
  });

  const grandTotal = totalSet.size;

  const list = [...panMap.entries()]
    .map(([pan,data])=>{
      return {
        pan,
        total: data.names.size,
        day: data.day.size,
        night: data.night.size,
        mid: data.mid.size,
        percent: grandTotal ? ((data.names.size/grandTotal)*100).toFixed(2) : 0,
        posDetail: [...data.posMap.entries()]
          .map(([k,v])=>({pos:k,count:v.size}))
          .sort((a,b)=>b.count-a.count)
      };
    })
    .sort((a,b)=>b.total-a.total);

  els.pagePan.innerHTML = `
    <div class="card">
      <h2>ç›˜å£äººæ•°ç»Ÿè®¡</h2>
      <div class="sub">æ€»äººæ•°ï¼š${grandTotal}ï¼ˆæŒ‰å§“åå»é‡ï¼‰</div>
    </div>

    <div class="card">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>ç›˜å£</th>
              <th>æ€»äººæ•°</th>
              <th>å æ¯”</th>
              <th>ç™½ç­</th>
              <th>å¤œç­</th>
              <th>ä¸­ç­</th>
              <th>å²—ä½åˆ†å¸ƒ</th>
            </tr>
          </thead>
          <tbody>
            ${list.map((r,i)=>`
              <tr style="${i<3?'background:#f0f7ff;font-weight:700':''}">
                <td>#${i+1}</td>
                <td class="link" onclick="openPan('${esc(r.pan)}')">${esc(r.pan)}</td>
                <td>${r.total}</td>
                <td>${r.percent}%</td>
                <td>${r.day}</td>
                <td>${r.night}</td>
                <td>${r.mid}</td>
                <td>
                  ${r.posDetail.map(p=>`${esc(p.pos)}: ${p.count}`).join("<br>")}
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;
}
  
load();
</script>
</body>
</html>
