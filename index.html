<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HR System - Public Enterprise</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --nav:#0b1220;
      --chip:#f1f5f9;
      --primary:#2563eb;
      --shadow:0 10px 30px rgba(2,6,23,.08);
      --shadow2:0 2px 10px rgba(2,6,23,.06);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,.14), transparent 45%),
        radial-gradient(900px 600px at 90% 0%, rgba(16,185,129,.10), transparent 45%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.92));
      backdrop-filter: blur(10px);
      color:#fff;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .head-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;}
    .dot{width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)}
    .right-badges{display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.8);font-size:12px;}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)}

    .container{max-width:1240px;margin:18px auto;padding:0 16px 40px;}

    .topbar{display:flex;align-items:center;gap:10px;margin:14px 0 16px;}
    .tabs{
      display:flex;gap:8px;align-items:center;
      padding:8px;background:rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.55);
      border-radius:999px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .tab{
      user-select:none;
      padding:8px 14px;border-radius:999px;
      background:transparent;border:1px solid transparent;
      color:#0f172a;font-weight:800;font-size:13px;cursor:pointer;
    }
    .tab.active{
      background:linear-gradient(180deg, #0f172a, #0b1220);
      color:#fff;box-shadow:0 10px 26px rgba(2,6,23,.25);
    }

    .filters{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      margin-left:auto;
    }
    .input, .select{
      height:38px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.9);padding:0 12px;outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.02);color:var(--text);
    }
    .input{min-width:240px}
    .select{min-width:160px}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.65);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    .title{font-size:22px;font-weight:1000;margin:0 0 6px;letter-spacing:.2px;}
    .sub{color:var(--muted);font-size:13px}

    .grid-2-top{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:14px}
    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:14px;border-radius:16px;background:rgba(255,255,255,.94);
      border:1px solid rgba(255,255,255,.65);box-shadow:var(--shadow2);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .kpi:hover{transform:translateY(-2px);box-shadow:0 14px 35px rgba(2,6,23,.10)}
    .kpi.noclick{cursor:default}
    .kpi.noclick:hover{transform:none;box-shadow:var(--shadow2)}
    .kpi .label{color:var(--muted);font-size:12px;font-weight:800}
    .kpi .value{font-size:24px;font-weight:1000;margin-top:6px}
    .kpi .hint{margin-top:6px;font-size:12px;color:var(--muted);font-weight:900}

    .pos-wrap{margin-top:14px}
    .pos-grid{display:grid;grid-template-columns:repeat(8, 1fr);gap:10px;}
    @media (max-width:1200px){ .pos-grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:720px){ .pos-grid{grid-template-columns:repeat(2,1fr)} }
    .pos-card{
      cursor:pointer;padding:12px;border-radius:16px;
      background:rgba(255,255,255,.95);
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
      transition:transform .12s ease, box-shadow .12s ease;
      min-height:64px;
    }
    .pos-card:hover{transform:translateY(-2px);box-shadow:0 14px 35px rgba(2,6,23,.10)}
    .pos-name{font-weight:1000;font-size:13px;line-height:1.15}
    .pos-count{margin-top:8px;color:#0f172a;font-weight:1000}

    .team-section{margin-top:14px}
    .team-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:var(--chip);
      border:1px solid rgba(2,6,23,.06);
      color:#0f172a;font-weight:900;font-size:12px;
    }
    .team-list{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;}
    @media (max-width:1100px){ .team-list{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:720px){ .team-list{grid-template-columns:1fr} }
    .team-card{
      padding:14px;border-radius:18px;background:rgba(255,255,255,.95);
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
    }
    .team-name{font-weight:1000;font-size:14px;margin:0 0 10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:7px 10px;border-radius:12px;background:var(--chip);
      border:1px solid rgba(2,6,23,.06);
      font-size:12px;font-weight:900;color:#0f172a;
      cursor:pointer;user-select:none;
    }
    .chip:hover{border-color:rgba(37,99,235,.35)}
    .chip.primary{
      background:rgba(37,99,235,.12);
      border-color:rgba(37,99,235,.25);
      color:#1d4ed8;
    }

    .hidden{display:none !important}

    /* ===== tables ===== */
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;z-index:2;
      background:linear-gradient(180deg, #0f172a, #0b1220);
      color:#fff;text-align:left;font-size:12px;letter-spacing:.2px;
      padding:12px 12px;white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;border-bottom:1px solid rgba(2,6,23,.06);
      font-size:13px;vertical-align:top;
    }
    tbody tr:hover{background:rgba(2,6,23,.03)}
    .scroll{
      overflow:auto;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.06);
      box-shadow:var(--shadow2);
      background:#fff;
      max-height:560px;
    }
    .td-link{color:#2563eb;font-weight:1000;cursor:pointer}
    .td-link:hover{text-decoration:underline}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-weight:900}
    .pill2{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background:rgba(2,6,23,.04);
      border:1px solid rgba(2,6,23,.08);
      font-size:12px;font-weight:900;
    }

    /* modal */
    .modal{
      position:fixed;inset:0;z-index:1000;
      display:none;background:rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      align-items:center;justify-content:center;padding:18px;
    }
    .modal.show{display:flex}
    .modal-box{
      width:min(1180px, 96vw);
      max-height:min(88vh, 900px);
      background:rgba(255,255,255,.96);
      border:1px solid rgba(255,255,255,.65);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid rgba(2,6,23,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
    }
    .modal-title{font-weight:1000}
    .xbtn{cursor:pointer;border:0;width:40px;height:40px;border-radius:12px;background:rgba(2,6,23,.06);font-weight:1000}
    .modal-body{padding:14px 16px}
    .mini{font-size:12px;color:var(--muted);font-weight:900}
    .modal-filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .modal-filters .input{min-width:260px}
    .modal-scroll{margin-top:12px;max-height:62vh;overflow:auto;border-radius:16px;border:1px solid rgba(2,6,23,.08);background:#fff}
    .btn{
      cursor:pointer;height:36px;padding:0 12px;border-radius:12px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.92);
      font-weight:900;box-shadow:var(--shadow2);
    }
    .btn:hover{border-color:rgba(37,99,235,.30)}
    .modal-actions{display:flex;gap:10px;align-items:center}
  </style>
</head>

<body>
<header>
  <div class="head-row">
    <div class="brand">
      <span class="dot"></span>
      <span>HR System</span>
      <span class="badge">Public view</span>
    </div>
    <div class="right-badges">
      <span class="badge" id="dataStatus">Loading…</span>
      <span class="badge" id="lastUpdated">—</span>
    </div>
  </div>
</header>

<div class="container">

  <div class="topbar">
    <div class="tabs">
      <div class="tab active" data-page="dashboard">Dashboard</div>
      <div class="tab" data-page="employees">Employees</div>
      <div class="tab" data-page="schedule">排班表</div>
    </div>

    <div class="filters" id="globalFilters">
      <input id="qSearch" class="input" placeholder="Search name / ID / team / group / position / country / shift…"/>
      <select id="fShift" class="select"></select>
      <select id="fTeam" class="select"></select>
      <select id="fGroup" class="select"></select>
      <select id="fPos" class="select"></select>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="page-dashboard">
    <div class="card">
      <div class="title">统计总览</div>
      <div class="sub">按岗位 & 团队统计（点击岗位卡片 / 团队统计会弹窗员工名单）</div>

      <!-- ✅ KPI: Total + 4 manager columns -->
      <div class="kpis">
        <div class="kpi noclick">
          <div class="label">总人数（去重）</div>
          <div class="value" id="kTotal">—</div>
          <div class="hint">按 ID 优先去重</div>
        </div>

        <div class="kpi" id="kOwnerBox" data-mgr="owner">
          <div class="label" id="lblOwner">负责人</div>
          <div class="value" id="kOwner">—</div>
          <div class="hint">点击查看名单 → 再点人看下属</div>
        </div>

        <div class="kpi" id="kOnsiteBox" data-mgr="onsite">
          <div class="label" id="lblOnsite">现场培训</div>
          <div class="value" id="kOnsite">—</div>
          <div class="hint">点击查看名单 → 再点人看下属</div>
        </div>

        <div class="kpi" id="kLeaderBox" data-mgr="leader">
          <div class="label" id="lblLeader">线上组长</div>
          <div class="value" id="kLeader">—</div>
          <div class="hint">点击查看名单 → 再点人看下属</div>
        </div>

        <div class="kpi" id="kOnlineBox" data-mgr="online">
          <div class="label" id="lblOnline">线上培训</div>
          <div class="value" id="kOnline">—</div>
          <div class="hint">点击查看名单 → 再点人看下属</div>
        </div>
      </div>

      <div class="pos-wrap">
        <div class="sub" style="margin:4px 0 10px;font-weight:1000;">岗位（每个岗位一个卡片，点击查看员工）</div>
        <div class="pos-grid" id="posGrid"></div>
      </div>
    </div>

    <div class="grid-2-top">
      <div class="card">
        <div>
          <div style="font-weight:1000">岗位分布（点击扇区弹员工）</div>
          <div class="mini">来源：岗位 = Google Sheet「岗位」列</div>
        </div>
        <div style="height:340px;margin-top:10px">
          <canvas id="chartPos"></canvas>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">团队人数（cột F，点击柱子弹员工）</div>
            <div class="mini">来源：团队 = Google Sheet「团队」列（不是「组别」）</div>
          </div>
          <span class="pill" id="teamCountPill">团队数量：—</span>
        </div>
        <div style="height:340px;margin-top:10px">
          <canvas id="chartTeam"></canvas>
        </div>
      </div>
    </div>

    <div class="card team-section">
      <div class="team-head">
        <div>
          <div style="font-weight:1000">团队统计（cột F）</div>
          <div class="mini">每个团队：总人数 + 各岗位人数（点击任意数字弹窗员工名单）</div>
        </div>
        <span class="pill" id="teamCountPill2">团队数量：—</span>
      </div>
      <div class="team-list" id="teamCards"></div>
    </div>
  </section>

  <!-- EMPLOYEES -->
  <section id="page-employees" class="hidden">
    <div class="card">
      <div class="title" style="margin-bottom:2px">Employees</div>
      <div class="sub">点击管理者名字：弹出其下属名单（支持 负责人/现场培训/线上组长/线上培训）</div>

      <div class="mini" style="margin-top:10px" id="empCount">—</div>

      <div class="scroll" style="margin-top:10px">
        <table>
          <thead><tr id="empTheadRow"></tr></thead>
          <tbody id="empTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SCHEDULE -->
  <section id="page-schedule" class="hidden">
    <div class="card">
      <div class="title" style="margin-bottom:2px">排班表</div>
      <div class="sub">按岗位 → 班次 分区展示（点击班次/数字/管理者名可弹出名单）</div>
      <div class="mini" style="margin-top:10px" id="schTip">—</div>

      <div class="scroll" style="margin-top:14px">
        <table>
          <thead><tr id="schTheadRow"></tr></thead>
          <tbody id="schTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="modalTitle">—</div>
        <div class="mini" id="modalSub">—</div>
      </div>
      <div class="modal-actions">
        <button class="btn hidden" id="modalBack">← Back</button>
        <button class="xbtn" id="modalClose">✕</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-filters">
        <input id="modalSearch" class="input" placeholder="Search inside list…"/>
        <select id="modalShift" class="select"></select>
        <select id="modalTeam" class="select"></select>
        <select id="modalGroup" class="select"></select>
        <select id="modalPos" class="select"></select>
      </div>

      <div class="modal-scroll">
        <table>
          <thead><tr id="modalTheadRow"></tr></thead>
          <tbody id="modalTbody"></tbody>
        </table>
      </div>

      <div class="mini" id="modalCount" style="margin-top:10px">—</div>
    </div>
  </div>
</div>

<script>
/* ===========================
   DATA SOURCE
   =========================== */
const SHEET_API = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/团队填表";

/* ===========================
   COLUMN NAMES (match your sheet headers)
   =========================== */
const COL = {
  owner: "负责人",
  onsite: "现场培训",
  leader: "线上组长",
  online: "线上培训",
  group: "组别",
  team:  "团队",     // cột F ✅
  name:  "姓名",
  id:    "ID",
  shift: "班次",
  country:"国家",
  pos:   "岗位",
  desk:  "盘口"
};

let RAW = [];
let ROWS = [];
let chartPos, chartTeam;

/* ===========================
   HELPERS
   =========================== */
const $ = (id)=>document.getElementById(id);
function norm(v){ if(v===null||v===undefined) return ""; return String(v).trim(); }
function safeGet(row, key){ return norm(row?.[key]); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function sortCN(a,b){ return a.localeCompare(b, "zh-Hans-CN", {numeric:true, sensitivity:"base"}); }

function uniqKey(row){
  const id = safeGet(row, COL.id);
  if(id) return "ID:" + id;
  const c = safeGet(row, COL.onsite);
  const d = safeGet(row, COL.leader);
  const name = safeGet(row, COL.name);
  const team = safeGet(row, COL.team);
  const pos = safeGet(row, COL.pos);
  const country = safeGet(row, COL.country);
  return "FB:" + [c,d,name,team,pos,country].join("|");
}
function uniqueByKey(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, x);
  }
  return [...m.values()];
}
function isValidPerson(row){
  const hasName = !!safeGet(row, COL.name);
  const hasId = !!safeGet(row, COL.id);
  return hasId || hasName;
}

function buildOptions(selectEl, values, placeholder){
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);
  values.forEach(v=>{
    const op = document.createElement("option");
    op.value = v; op.textContent = v;
    selectEl.appendChild(op);
  });
}

function applyGlobalFilters(rows){
  const q = norm($("qSearch").value).toLowerCase();
  const fShift = $("fShift").value;
  const fTeam  = $("fTeam").value;
  const fGroup = $("fGroup").value;
  const fPos   = $("fPos").value;

  return rows.filter(r=>{
    if(fShift && safeGet(r, COL.shift) !== fShift) return false;
    if(fTeam  && safeGet(r, COL.team)  !== fTeam) return false;
    if(fGroup && safeGet(r, COL.group) !== fGroup) return false;
    if(fPos   && safeGet(r, COL.pos)   !== fPos) return false;

    if(!q) return true;

    const hay = [
      safeGet(r, COL.name),
      safeGet(r, COL.id),
      safeGet(r, COL.team),
      safeGet(r, COL.group),
      safeGet(r, COL.pos),
      safeGet(r, COL.country),
      safeGet(r, COL.shift),
      safeGet(r, COL.desk),
      safeGet(r, COL.owner),
      safeGet(r, COL.onsite),
      safeGet(r, COL.leader),
      safeGet(r, COL.online),
    ].join(" ").toLowerCase();

    return hay.includes(q);
  });
}

/* ===========================
   LOAD
   =========================== */
async function loadData(){
  $("dataStatus").textContent = "Loading…";
  try{
    const res = await fetch(SHEET_API, {cache:"no-store"});
    if(!res.ok) throw new Error("Fetch failed: " + res.status);
    RAW = await res.json();

    const tmp = RAW.map(r=>{
      const o = {};
      for(const k in r) o[norm(k)] = norm(r[k]);
      return o;
    });

    ROWS = tmp.filter(r=>{
      const any = Object.values(COL).some(colName => !!safeGet(r, colName));
      return any && isValidPerson(r);
    });

    $("dataStatus").textContent = "Loaded";
    $("lastUpdated").textContent = "Updated: " + new Date().toLocaleString();
  }catch(err){
    console.error(err);
    $("dataStatus").textContent = "Load error";
    $("lastUpdated").textContent = String(err?.message || err);
  }
}

/* ===========================
   FILTERS init
   =========================== */
function initFilters(){
  const shifts = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.shift)).filter(Boolean))).sort(sortCN);
  const teams  = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.team)).filter(Boolean))).sort(sortCN);
  const groups = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.group)).filter(Boolean))).sort(sortCN);
  const poss   = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.pos)).filter(Boolean))).sort(sortCN);

  buildOptions($("fShift"), shifts, "All shifts");
  buildOptions($("fTeam"), teams, "All teams (cột F)");
  buildOptions($("fGroup"), groups, "All groups (组别)");
  buildOptions($("fPos"), poss, "All positions");

  // modal filters (reuse same options)
  buildOptions($("modalShift"), shifts, "All shifts");
  buildOptions($("modalTeam"), teams, "All teams");
  buildOptions($("modalGroup"), groups, "All groups");
  buildOptions($("modalPos"), poss, "All positions");

  $("schTip").textContent = `班次来源：Google Sheet「${COL.shift}」。团队来源：「${COL.team}」（cột F）。`;
}

/* ===========================
   DASHBOARD STATS
   =========================== */
function buildStats(rows){
  const uniquePeople = uniqueByKey(rows, uniqKey);
  const total = uniquePeople.length;

  const byPos = new Map();
  const byTeam = new Map();
  const byTeamPos = new Map();

  for(const r of uniquePeople){
    const pos = safeGet(r, COL.pos) || "未填写岗位";
    const team = safeGet(r, COL.team) || "未填写团队";

    byPos.set(pos, (byPos.get(pos)||0)+1);
    byTeam.set(team, (byTeam.get(team)||0)+1);

    const key = team + "||" + pos;
    byTeamPos.set(key, (byTeamPos.get(key)||0)+1);
  }
  return {uniquePeople, total, byPos, byTeam, byTeamPos};
}

/* ✅ manager unique counts (per column, no duplicate inside column) */
function managerUniqueList(uniquePeople, fieldHeader){
  const set = new Set();
  uniquePeople.forEach(r=>{
    const v = safeGet(r, fieldHeader);
    if(v) set.add(v);
  });
  return [...set].sort(sortCN);
}

function renderDashboard(){
  // update KPI labels from sheet headers
  $("lblOwner").textContent = COL.owner;
  $("lblOnsite").textContent = COL.onsite;
  $("lblLeader").textContent = COL.leader;
  $("lblOnline").textContent = COL.online;

  const filtered = applyGlobalFilters(ROWS);
  const {uniquePeople, total, byPos, byTeam, byTeamPos} = buildStats(filtered);

  $("kTotal").textContent = total;

  const owners = managerUniqueList(uniquePeople, COL.owner);
  const onsites= managerUniqueList(uniquePeople, COL.onsite);
  const leaders= managerUniqueList(uniquePeople, COL.leader);
  const onlines= managerUniqueList(uniquePeople, COL.online);

  $("kOwner").textContent = owners.length;
  $("kOnsite").textContent = onsites.length;
  $("kLeader").textContent = leaders.length;
  $("kOnline").textContent = onlines.length;

  // Position cards
  const posArr = [...byPos.entries()].sort((a,b)=>b[1]-a[1]);
  $("posGrid").innerHTML = posArr.map(([pos,count])=>`
    <div class="pos-card" data-open="pos" data-value="${escapeHtml(pos)}">
      <div class="pos-name">${escapeHtml(pos)}</div>
      <div class="pos-count">${count} 人</div>
    </div>
  `).join("");

  // Charts
  const posLabels = posArr.map(x=>x[0]);
  const posData = posArr.map(x=>x[1]);
  if(chartPos) chartPos.destroy();
  chartPos = new Chart($("chartPos"),{
    type:"doughnut",
    data:{ labels:posLabels, datasets:[{data:posData}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{position:"top"} },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const label = posLabels[idx];
        openEmployeeModal({title:`${label} 员工名单`, preset:{pos:label}});
      }
    }
  });

  const teamArr = [...byTeam.entries()].sort((a,b)=>b[1]-a[1]);
  $("teamCountPill").textContent = "团队数量：" + teamArr.length;
  $("teamCountPill2").textContent = "团队数量：" + teamArr.length;

  const teamLabels = teamArr.map(x=>x[0]);
  const teamData = teamArr.map(x=>x[1]);

  if(chartTeam) chartTeam.destroy();
  chartTeam = new Chart($("chartTeam"),{
    type:"bar",
    data:{ labels:teamLabels, datasets:[{label:"人数", data:teamData}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:true}},
      scales:{ x:{ticks:{maxRotation:60,minRotation:60}} },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const team = teamLabels[idx];
        openEmployeeModal({title:`${team} 员工名单`, preset:{team}});
      }
    }
  });

  // Team cards
  const posOrder = posArr.map(x=>x[0]);
  $("teamCards").innerHTML = teamArr.map(([team, teamTotal])=>{
    const chips = [];
    chips.push(`<span class="chip primary" data-open="team" data-value="${escapeHtml(team)}">总人数 ${teamTotal}</span>`);
    for(const pos of posOrder){
      const cnt = byTeamPos.get(team+"||"+pos) || 0;
      if(cnt<=0) continue;
      chips.push(`<span class="chip" data-open="teampos" data-team="${escapeHtml(team)}" data-pos="${escapeHtml(pos)}">${escapeHtml(pos)} ${cnt}</span>`);
    }
    return `
      <div class="team-card">
        <div class="team-name">${escapeHtml(team)}</div>
        <div class="chips">${chips.join("")}</div>
      </div>
    `;
  }).join("");

  // click handlers for cards
  document.querySelectorAll("[data-open='pos']").forEach(el=>{
    el.onclick = ()=>openEmployeeModal({title:`${el.dataset.value} 员工名单`, preset:{pos:el.dataset.value}});
  });
  document.querySelectorAll("[data-open='team']").forEach(el=>{
    el.onclick = ()=>openEmployeeModal({title:`${el.dataset.value} 员工名单`, preset:{team:el.dataset.value}});
  });
  document.querySelectorAll("[data-open='teampos']").forEach(el=>{
    el.onclick = ()=>openEmployeeModal({title:`${el.dataset.team} - ${el.dataset.pos} 员工名单`, preset:{team:el.dataset.team, pos:el.dataset.pos}});
  });

  // ✅ KPI click => open manager list modal (2-level)
  $("kOwnerBox").onclick  = ()=>openManagerListModal({fieldKey:"owner"});
  $("kOnsiteBox").onclick = ()=>openManagerListModal({fieldKey:"onsite"});
  $("kLeaderBox").onclick = ()=>openManagerListModal({fieldKey:"leader"});
  $("kOnlineBox").onclick = ()=>openManagerListModal({fieldKey:"online"});
}

/* ===========================
   EMPLOYEES TABLE
   =========================== */
function empColumns(){
  return [
    {key:"owner",  label:COL.owner,   get:r=>safeGet(r, COL.owner),   manager:true, fieldKey:"owner"},
    {key:"onsite", label:COL.onsite,  get:r=>safeGet(r, COL.onsite),  manager:true, fieldKey:"onsite"},
    {key:"leader", label:COL.leader,  get:r=>safeGet(r, COL.leader),  manager:true, fieldKey:"leader"},
    {key:"online", label:COL.online,  get:r=>safeGet(r, COL.online),  manager:true, fieldKey:"online"},

    {key:"team",   label:COL.team,    get:r=>safeGet(r, COL.team)},
    {key:"group",  label:COL.group,   get:r=>safeGet(r, COL.group)},
    {key:"shift",  label:COL.shift,   get:r=>safeGet(r, COL.shift)},
    {key:"pos",    label:COL.pos,     get:r=>safeGet(r, COL.pos)},
    {key:"name",   label:COL.name,    get:r=>safeGet(r, COL.name)},
    {key:"id",     label:COL.id,      get:r=>safeGet(r, COL.id), mono:true},
    {key:"country",label:COL.country, get:r=>safeGet(r, COL.country)},
    {key:"desk",   label:COL.desk,    get:r=>safeGet(r, COL.desk)},
  ];
}

function managerLink(fieldKey, label, value){
  if(!value) return "—";
  return `<span class="td-link" data-open="mgr" data-field="${escapeHtml(fieldKey)}" data-label="${escapeHtml(label)}" data-value="${escapeHtml(value)}">${escapeHtml(value)}</span>`;
}

function renderEmployees(){
  const cols = empColumns();
  $("empTheadRow").innerHTML = cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join("");

  const filtered = applyGlobalFilters(ROWS);
  const uniq = uniqueByKey(filtered, uniqKey);
  $("empCount").textContent = `共 ${uniq.length} 人（去重后）`;

  $("empTbody").innerHTML = uniq.map(r=>{
    const tds = cols.map(c=>{
      const v = c.get(r) || "";
      if(c.mono) return `<td class="mono">${escapeHtml(v||"—")}</td>`;
      if(c.manager) return `<td>${managerLink(c.fieldKey, c.label, v)}</td>`;
      return `<td>${escapeHtml(v||"—")}</td>`;
    }).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  attachInlineOpenHandlers($("empTbody"));
}

/* ===========================
   SCHEDULE TABLE (simple high-end table)
   =========================== */
function renderSchedule(){
  const cols = empColumns(); // reuse
  $("schTheadRow").innerHTML = cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join("");

  const filtered = applyGlobalFilters(ROWS);
  const uniq = uniqueByKey(filtered, uniqKey);

  $("schTbody").innerHTML = uniq.map(r=>{
    const tds = cols.map(c=>{
      const v = c.get(r) || "";
      if(c.mono) return `<td class="mono">${escapeHtml(v||"—")}</td>`;
      if(c.manager) return `<td>${managerLink(c.fieldKey, c.label, v)}</td>`;
      return `<td>${escapeHtml(v||"—")}</td>`;
    }).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  attachInlineOpenHandlers($("schTbody"));
}

/* ===========================
   MODAL SYSTEM (2-level)
   - Level 1: manager list
   - Level 2: subordinates list
   =========================== */
let modalMode = "employees"; // "managers" | "employees"
let modalStack = [];         // for Back

let modalBasePeople = [];    // unique people base
let modalManagerFieldKey = null; // owner/onsite/leader/online

function openModalShell(title, sub){
  $("modalTitle").textContent = title || "—";
  $("modalSub").textContent = sub || "";
  $("modal").classList.add("show");
}
function closeModal(){
  $("modal").classList.remove("show");
  modalStack = [];
  $("modalBack").classList.add("hidden");
  modalMode = "employees";
}
$("modalClose").onclick = closeModal;
$("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) closeModal(); });

function showBackButton(on){
  $("modalBack").classList.toggle("hidden", !on);
}
$("modalBack").onclick = ()=>{
  const prev = modalStack.pop();
  if(!prev){ closeModal(); return; }
  // restore
  modalMode = prev.mode;
  modalManagerFieldKey = prev.fieldKey;
  // restore filters
  $("modalSearch").value = prev.search;
  $("modalShift").value = prev.shift;
  $("modalTeam").value = prev.team;
  $("modalGroup").value = prev.group;
  $("modalPos").value = prev.pos;
  openModalShell(prev.title, prev.sub);
  if(modalMode==="managers") renderManagerListTable();
  else renderEmployeeListTable(prev.preset || {}, prev.managerPreset || null);
  showBackButton(modalStack.length>0);
};

function modalSaveState(extra={}){
  return {
    mode: modalMode,
    fieldKey: modalManagerFieldKey,
    title: $("modalTitle").textContent,
    sub: $("modalSub").textContent,
    search: $("modalSearch").value,
    shift: $("modalShift").value,
    team: $("modalTeam").value,
    group: $("modalGroup").value,
    pos: $("modalPos").value,
    ...extra
  };
}

/* build modal options from current dataset */
function initModalOptions(){
  const shifts = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.shift)).filter(Boolean))).sort(sortCN);
  const teams  = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.team)).filter(Boolean))).sort(sortCN);
  const groups = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.group)).filter(Boolean))).sort(sortCN);
  const poss   = Array.from(new Set(ROWS.map(r=>safeGet(r, COL.pos)).filter(Boolean))).sort(sortCN);

  buildOptions($("modalShift"), shifts, "All shifts");
  buildOptions($("modalTeam"), teams, "All teams");
  buildOptions($("modalGroup"), groups, "All groups");
  buildOptions($("modalPos"), poss, "All positions");
}

/* ===== Level 1: manager list ===== */
function openManagerListModal({fieldKey}){
  // base: global filtered unique people
  const filtered = applyGlobalFilters(ROWS);
  const uniq = uniqueByKey(filtered, uniqKey);
  modalBasePeople = uniq;

  modalMode = "managers";
  modalManagerFieldKey = fieldKey;

  // reset filters but keep global style
  $("modalSearch").value = "";
  $("modalShift").value = "";
  $("modalTeam").value  = "";
  $("modalGroup").value = "";
  $("modalPos").value   = "";

  // header for manager list (custom table)
  $("modalTheadRow").innerHTML = `
    <th>${escapeHtml(COL[fieldKey] || fieldKey)}</th>
    <th>下属人数</th>
  `;
  openModalShell(`${COL[fieldKey]} 名单（去重）`, `点击人名 → 查看其管理范围内全部员工`);
  renderManagerListTable();
  showBackButton(modalStack.length>0);
}

/* compute subordinate count for manager name */
function subordinateCount(fieldKey, managerName){
  const header = COL[fieldKey];
  return modalBasePeople.filter(r => safeGet(r, header) === managerName).length;
}

function renderManagerListTable(){
  const header = COL[modalManagerFieldKey];
  const q = norm($("modalSearch").value).toLowerCase();

  let list = managerUniqueList(modalBasePeople, header); // unique managers
  if(q) list = list.filter(n=>n.toLowerCase().includes(q));

  $("modalTbody").innerHTML = list.map(name=>{
    const cnt = subordinateCount(modalManagerFieldKey, name);
    return `
      <tr>
        <td><span class="td-link" data-open="mgrPerson" data-value="${escapeHtml(name)}">${escapeHtml(name)}</span></td>
        <td><span class="pill2 td-link" data-open="mgrPerson" data-value="${escapeHtml(name)}">${cnt}</span></td>
      </tr>
    `;
  }).join("");

  $("modalCount").textContent = `显示 ${list.length} 人（管理者去重）`;
  attachInlineOpenHandlers($("modalTbody"));
}

/* ===== Level 2: employee list ===== */
function openEmployeeModal({title, preset, managerPreset}){
  // base from current global filtered unique
  const filtered = applyGlobalFilters(ROWS);
  modalBasePeople = uniqueByKey(filtered, uniqKey);

  modalMode = "employees";
  initModalEmployeeHeader();

  // reset manager list state
  modalManagerFieldKey = managerPreset?.fieldKey || null;

  $("modalSearch").value = "";
  $("modalShift").value = preset?.shift || "";
  $("modalTeam").value  = preset?.team  || "";
  $("modalGroup").value = preset?.group || "";
  $("modalPos").value   = preset?.pos   || "";

  const sub = managerPreset
    ? `管理者：${managerPreset.label} = ${managerPreset.value}（显示其下属）`
    : `你可以在弹窗继续筛选（不会影响主页面）`;

  openModalShell(title || "员工名单", sub);
  renderEmployeeListTable(preset||{}, managerPreset||null);
  showBackButton(modalStack.length>0);
}

function initModalEmployeeHeader(){
  const cols = empColumns();
  $("modalTheadRow").innerHTML = cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join("");
}

function renderEmployeeListTable(preset, managerPreset){
  const q = norm($("modalSearch").value).toLowerCase();
  const shift = $("modalShift").value;
  const team  = $("modalTeam").value;
  const group = $("modalGroup").value;
  const pos   = $("modalPos").value;

  let list = modalBasePeople.filter(r=>{
    if(managerPreset){
      const header = COL[managerPreset.fieldKey];
      if(safeGet(r, header) !== managerPreset.value) return false;
    }
    if(shift && safeGet(r, COL.shift) !== shift) return false;
    if(team  && safeGet(r, COL.team)  !== team) return false;
    if(group && safeGet(r, COL.group) !== group) return false;
    if(pos   && safeGet(r, COL.pos)   !== pos) return false;

    if(!q) return true;
    const hay = [
      safeGet(r, COL.name),
      safeGet(r, COL.id),
      safeGet(r, COL.team),
      safeGet(r, COL.group),
      safeGet(r, COL.pos),
      safeGet(r, COL.country),
      safeGet(r, COL.shift),
      safeGet(r, COL.desk),
      safeGet(r, COL.owner),
      safeGet(r, COL.onsite),
      safeGet(r, COL.leader),
      safeGet(r, COL.online),
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  const cols = empColumns();
  $("modalTbody").innerHTML = list.map(r=>{
    const tds = cols.map(c=>{
      const v = c.get(r) || "";
      if(c.mono) return `<td class="mono">${escapeHtml(v||"—")}</td>`;
      if(c.manager) return `<td>${managerLink(c.fieldKey, c.label, v)}</td>`;
      return `<td>${escapeHtml(v||"—")}</td>`;
    }).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  $("modalCount").textContent = `显示 ${list.length} 人（去重后）`;
  attachInlineOpenHandlers($("modalTbody"));
}

/* ===========================
   INLINE HANDLERS
   =========================== */
function attachInlineOpenHandlers(rootEl){
  if(!rootEl) return;

  rootEl.querySelectorAll("[data-open]").forEach(el=>{
    el.onclick = ()=>{
      const type = el.getAttribute("data-open");

      if(type==="pos"){
        openEmployeeModal({title:`${el.dataset.value} 员工名单`, preset:{pos:el.dataset.value}});
      }
      if(type==="team"){
        openEmployeeModal({title:`${el.dataset.value} 员工名单`, preset:{team:el.dataset.value}});
      }
      if(type==="group"){
        openEmployeeModal({title:`${el.dataset.value}（组别）员工名单`, preset:{group:el.dataset.value}});
      }
      if(type==="teampos"){
        openEmployeeModal({title:`${el.dataset.team} - ${el.dataset.pos} 员工名单`, preset:{team:el.dataset.team, pos:el.dataset.pos}});
      }
      if(type==="mgr"){
        // clicking manager name => show subordinates (Level 2)
        const fieldKey = el.dataset.field;
        const label = el.dataset.label;
        const value = el.dataset.value;

        // push current modal state to stack if inside modal
        if($("modal").classList.contains("show")){
          modalStack.push(modalSaveState({preset:{}, managerPreset:null}));
          showBackButton(true);
        }
        openEmployeeModal({
          title:`${label}：${value} 下属名单`,
          preset:{},
          managerPreset:{fieldKey, label, value}
        });
      }
      if(type==="mgrPerson"){
        // Level 1 -> click manager => Level 2 (subordinates)
        const name = el.dataset.value;
        const fk = modalManagerFieldKey;
        const label = COL[fk];

        modalStack.push(modalSaveState({})); // save manager list state
        showBackButton(true);

        openEmployeeModal({
          title:`${label}：${name} 下属名单`,
          preset:{},
          managerPreset:{fieldKey:fk, label, value:name}
        });
      }
    };
  });
}

/* ===========================
   NAV
   =========================== */
function setPage(page){
  $("page-dashboard").classList.toggle("hidden", page!=="dashboard");
  $("page-employees").classList.toggle("hidden", page!=="employees");
  $("page-schedule").classList.toggle("hidden", page!=="schedule");
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.getAttribute("data-page")===page);
  });
  rerenderAll();
}

function rerenderAll(){
  renderDashboard();
  renderEmployees();
  renderSchedule();
}

/* ===========================
   INIT
   =========================== */
function bindEvents(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>setPage(t.getAttribute("data-page")));
  });

  ["qSearch","fShift","fTeam","fGroup","fPos"].forEach(id=>{
    $(id).addEventListener("input", rerenderAll);
    $(id).addEventListener("change", rerenderAll);
  });

  ["modalSearch","modalShift","modalTeam","modalGroup","modalPos"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      if(modalMode==="managers") renderManagerListTable();
      else renderEmployeeListTable({}, modalManagerFieldKey ? null : null);
    });
    $(id).addEventListener("change", ()=>{
      if(modalMode==="managers") renderManagerListTable();
      else renderEmployeeListTable({}, modalManagerFieldKey ? null : null);
    });
  });
}

(async function init(){
  bindEvents();
  await loadData();
  initFilters();
  initModalOptions();
  rerenderAll();
})();
</script>
</body>
</html>
