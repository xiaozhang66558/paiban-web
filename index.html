<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>HR System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f9}
header{background:#111827;color:#fff;padding:14px 18px;display:flex;justify-content:space-between}
button{padding:8px 12px;border:0;border-radius:8px;cursor:pointer}
.card{background:#fff;margin:20px;padding:20px;border-radius:12px}
input{padding:8px;width:100%;margin-bottom:10px}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <div>HR System</div>
  <div>
    <span id="roleText">Not logged in</span>
    <button id="btnLogin">Login</button>
    <button id="btnLogout" class="hidden">Logout</button>
  </div>
</header>

<div class="card">
  <h3>Dashboard</h3>
  <div id="dashboardContent">Please login</div>
</div>

<!-- LOGIN MODAL -->
<div id="loginBox" class="card hidden">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="doLogin">Login</button>
  <div id="msg"></div>
</div>

<script>
const SUPABASE_URL = "https://mxeqccecqkyllwvbylej.supabase.co";
const SUPABASE_KEY = "sb_publishable_UWUWJaWHxVxZPnkm62sypQ_QU2pw2CR";

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let me = null;

/* ================= LOGIN ================= */

document.getElementById("btnLogin").onclick = ()=>{
  document.getElementById("loginBox").classList.remove("hidden");
};

document.getElementById("doLogin").onclick = async ()=>{
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  document.getElementById("msg").innerText = "Logging in...";

  const { error } = await supa.auth.signInWithPassword({
    email,
    password
  });

  if(error){
    document.getElementById("msg").innerText = error.message;
    return;
  }

  document.getElementById("loginBox").classList.add("hidden");
  await refreshUser();
};

/* ================= LOGOUT ================= */

document.getElementById("btnLogout").onclick = async ()=>{
  await supa.auth.signOut();
  me = null;
  updateUI();
};

/* ================= LOAD USER ================= */

async function refreshUser(){
  const { data:{ user } } = await supa.auth.getUser();
  if(!user){
    me = null;
    updateUI();
    return;
  }

  let { data: profile } = await supa
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .maybeSingle();

  if(!profile){
    const { data } = await supa
      .from("profiles")
      .insert({ id:user.id, role:"staff" })
      .select()
      .single();
    profile = data;
  }

  me = profile;
  updateUI();
}

/* ================= UI ================= */

function updateUI(){
  if(!me){
    document.getElementById("roleText").innerText = "Not logged in";
    document.getElementById("btnLogin").classList.remove("hidden");
    document.getElementById("btnLogout").classList.add("hidden");
    document.getElementById("dashboardContent").innerText = "Please login";
    return;
  }

  document.getElementById("roleText").innerText = "Role: " + me.role;
  document.getElementById("btnLogin").classList.add("hidden");
  document.getElementById("btnLogout").classList.remove("hidden");
  document.getElementById("dashboardContent").innerText = "Login success!";
}

/* ================= INIT ================= */

(async ()=>{
  const { data:{ session } } = await supa.auth.getSession();
  if(session){
    await refreshUser();
  }
})();
</script>

</body>
</html>
