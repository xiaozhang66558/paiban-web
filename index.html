<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>HR System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body{margin:0;font-family:Segoe UI;background:#f4f6f9}
header{background:#111827;color:#fff;padding:12px;display:flex;justify-content:space-between}
button{padding:6px 10px;border:0;border-radius:6px;cursor:pointer}
.card{background:#fff;margin:20px;padding:15px;border-radius:12px}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <div>HR System</div>
  <div>
    <span id="roleBadge">Not logged in</span>
    <button id="btnLogin">Login</button>
    <button id="btnLogout" class="hidden">Logout</button>
  </div>
</header>

<div class="card">
  <h3>Users</h3>
  <pre id="output"></pre>
</div>

<div id="loginBox" class="card hidden">
  <input id="email" placeholder="email" />
  <input id="pass" type="password" placeholder="password" />
  <button id="doLogin">Login</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://mxeqccecqkyllwvbylej.supabase.co";
const SUPABASE_KEY = "sb_publishable_UWUWJaWHxVxZPnkm62sypQ_QU2pw2CR";

const supa = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supa = supa;

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginBox = document.getElementById("loginBox");
const roleBadge = document.getElementById("roleBadge");
const output = document.getElementById("output");

let me = null;

async function ensureProfile(){
  const { data: sess } = await supa.auth.getSession();
  const user = sess?.session?.user;
  if(!user) return null;

  let { data } = await supa
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .maybeSingle();

  if(!data){
    const ins = await supa.from("profiles")
      .insert({ id: user.id, role: "staff" })
      .select("*")
      .single();
    data = ins.data;
  }
  return data;
}

async function refreshAll(){
  try{
    console.log("refreshAll start");

    me = await ensureProfile();
    console.log("profile:", me);

    if(me){
      roleBadge.textContent = "Role: " + me.role;
      btnLogin.classList.add("hidden");
      btnLogout.classList.remove("hidden");
    }

    const { data } = await supa.from("users").select("*");
    output.textContent = JSON.stringify(data, null, 2);

    console.log("refreshAll done");

  }catch(e){
    console.error(e);
  }
}

btnLogin.onclick = ()=>{
  loginBox.classList.remove("hidden");
};

btnLogout.onclick = async ()=>{
  await supa.auth.signOut();
  location.reload();
};

document.getElementById("doLogin").onclick = async ()=>{
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;

  const { error } = await supa.auth.signInWithPassword({ email, password: pass });

  if(error){
    alert(error.message);
    return;
  }

  loginBox.classList.add("hidden");
  await refreshAll();
};

supa.auth.onAuthStateChange(async (_e, session)=>{
  if(session?.user){
    await refreshAll();
  }
});

(async ()=>{
  const { data } = await supa.auth.getSession();
  if(data?.session?.user){
    await refreshAll();
  }
})();
</script>

</body>
</html>
