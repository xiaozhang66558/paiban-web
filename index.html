<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Enterprise HR Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:#f1f5f9}
header{
  background:linear-gradient(90deg,#0f172a,#1e293b);
  color:#fff;padding:18px 30px;
  font-size:20px;font-weight:700;
}
.container{max-width:1700px;margin:25px auto;padding:0 25px}

.card{
  background:#fff;border-radius:18px;padding:22px;
  box-shadow:0 4px 20px rgba(0,0,0,.06);
  margin-bottom:22px;
}

.grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}

.kpiGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:16px;margin-top:16px
}

.kpiBox{
  background:#fff;border-radius:14px;padding:18px;
  box-shadow:0 3px 12px rgba(0,0,0,.05);
  cursor:pointer;
  transition:.2s;
}
.kpiBox:hover{transform:translateY(-3px);background:#eef2ff}

.teamRow{
  background:#fff;border-radius:16px;padding:18px;
  box-shadow:0 3px 14px rgba(0,0,0,.05);
  margin-bottom:18px
}

.teamTitle{font-weight:800;margin-bottom:12px;font-size:17px}

.teamStats{display:flex;flex-wrap:wrap;gap:10px}

.statChip{
  background:#f3f4f6;padding:8px 14px;
  border-radius:12px;cursor:pointer;
  font-size:14px;
  transition:.15s;
}
.statChip:hover{background:#dbeafe}
.statChip b{font-weight:800}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  display:none;justify-content:center;align-items:center
}

.modalBox{
  background:#fff;width:97%;max-width:1650px;
  max-height:90vh;overflow:auto;
  border-radius:18px;padding:20px 24px;
}

.modalHeader{
  display:flex;align-items:center;justify-content:space-between;
}

.closeBtn{cursor:pointer;color:#ef4444;font-weight:800}

.toolbar{
  display:flex;gap:10px;margin-top:14px;flex-wrap:wrap
}

input,select{
  padding:8px 12px;border-radius:8px;
  border:1px solid #ddd;font-size:14px
}

button{
  padding:8px 14px;border:none;border-radius:8px;
  background:#2563eb;color:#fff;cursor:pointer
}

button:hover{background:#1d4ed8}

table{
  width:100%;border-collapse:collapse;margin-top:14px
}
th{
  background:#0f172a;color:#fff;padding:10px;
  position:sticky;top:0
}
td{padding:8px;border-bottom:1px solid #eee;text-align:center}

.small{font-size:12px;color:#64748b;margin-top:6px}
</style>
</head>

<body>
<header>ğŸ¢ Enterprise HR Dashboard</header>

<div class="container">

<!-- TOP CHARTS -->
<div class="grid">
<div class="card">
<h3>å²—ä½åˆ†å¸ƒ (cá»™t K)</h3>
<canvas id="chartPosition"></canvas>
<div class="small">ç‚¹å‡»æ‰‡åŒºæŸ¥çœ‹å‘˜å·¥</div>
</div>

<div class="card">
<h3>å›¢é˜Ÿäººæ•° (cá»™t F)</h3>
<canvas id="chartTeam"></canvas>
<div class="small">ç‚¹å‡»æŸ±å­æŸ¥çœ‹å›¢é˜Ÿ</div>
</div>
</div>

<!-- KPI -->
<div class="card">
<h3>æ€»äººæ•°: <span id="totalCount">0</span></h3>
<div id="positionCards" class="kpiGrid"></div>
</div>

<!-- TEAM STATS -->
<div class="card">
<h3>å›¢é˜Ÿç»Ÿè®¡ï¼ˆçœŸæ­£ä½¿ç”¨ cá»™t Fï¼‰</h3>
<div id="teamCards"></div>
</div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modalBox">

<div class="modalHeader">
<h3 id="modalTitle"></h3>
<div class="closeBtn" onclick="closeModal()">å…³é—­ âœ–</div>
</div>

<div class="toolbar">
<input id="searchInput" placeholder="æœç´¢ å§“å / ID"/>
<select id="countryFilter"></select>
<button onclick="exportCSV()">å¯¼å‡º CSV</button>
</div>

<table>
<thead>
<tr>
<th>è´Ÿè´£äºº</th>
<th>ç°åœºåŸ¹è®­</th>
<th>çº¿ä¸Šç»„é•¿</th>
<th>çº¿ä¸ŠåŸ¹è®­</th>
<th>ç»„åˆ«</th>
<th>å›¢é˜Ÿ</th>
<th>å§“å</th>
<th>ID</th>
<th>å›½å®¶</th>
<th>å²—ä½</th>
<th>ç›˜å£</th>
</tr>
</thead>
<tbody id="modalBody"></tbody>
</table>

</div>
</div>

<script>
const sheetAPI =
"https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/å›¢é˜Ÿå¡«è¡¨";

let data = [];
let filteredData = [];

function norm(v){return String(v??"").trim()}

async function load(){
const res = await fetch(sheetAPI);
const raw = await res.json();

let map = new Map();

raw.forEach(r=>{
let id = norm(r["ID"]);
if(!id) return;
if(!map.has(id)){
map.set(id,{
leader:norm(r["è´Ÿè´£äºº"]),
onsite:norm(r["ç°åœºåŸ¹è®­"]),
onlineLead:norm(r["çº¿ä¸Šç»„é•¿"]),
onlineTrain:norm(r["çº¿ä¸ŠåŸ¹è®­"]),
group:norm(r["ç»„åˆ«"]),
team:norm(r["å›¢é˜Ÿ"]), // ğŸ”¥ cá»™t F Ä‘Ãºng
name:norm(r["å§“å"]),
id:id,
country:norm(r["å›½å®¶"]),
position:norm(r["å²—ä½"]),
market:norm(r["ç›˜å£"])
});
}
});

data=[...map.values()];
render();
}

function render(){
document.getElementById("totalCount").innerText=data.length;

let posMap=groupBy(data,"position");
let teamMap=groupBy(data,"team");

renderPositionCards(posMap);
renderTeamCards(teamMap);
renderCharts(posMap,teamMap);
}

function groupBy(arr,key){
let m={};
arr.forEach(x=>{
let k=norm(x[key]);
if(!k)return;
m[k]=(m[k]||0)+1;
});
return m;
}

function renderPositionCards(map){
let div=document.getElementById("positionCards");
div.innerHTML="";
Object.entries(map).forEach(([k,v])=>{
div.innerHTML+=`
<div class="kpiBox" onclick="openModal({position:'${k}'})">
<b>${k}</b><br>${v} äºº
</div>`;
});
}

function renderTeamCards(map){
let div=document.getElementById("teamCards");
div.innerHTML="";
Object.keys(map).forEach(team=>{
let teamData=data.filter(x=>x.team===team);
let posMap=groupBy(teamData,"position");

let chips=`<div class="statChip" onclick="openModal({team:'${team}'})"><b>æ€»äººæ•°</b> ${teamData.length}</div>`;

Object.entries(posMap).forEach(([p,c])=>{
chips+=`<div class="statChip" onclick="openModal({team:'${team}',position:'${p}'})"><b>${p}</b> ${c}</div>`;
});

div.innerHTML+=`
<div class="teamRow">
<div class="teamTitle">${team}</div>
<div class="teamStats">${chips}</div>
</div>`;
});
}

function renderCharts(posMap,teamMap){
new Chart(document.getElementById("chartPosition"),{
type:"doughnut",
data:{labels:Object.keys(posMap),datasets:[{data:Object.values(posMap)}]},
options:{onClick:(e,el)=>{if(!el.length)return;openModal({position:Object.keys(posMap)[el[0].index]})}}
});

new Chart(document.getElementById("chartTeam"),{
type:"bar",
data:{labels:Object.keys(teamMap),datasets:[{label:"äººæ•°",data:Object.values(teamMap)}]},
options:{onClick:(e,el)=>{if(!el.length)return;openModal({team:Object.keys(teamMap)[el[0].index]})}}
});
}

function openModal(filter){
document.getElementById("modal").style.display="flex";

filteredData=data;
if(filter.team) filteredData=filteredData.filter(x=>x.team===filter.team);
if(filter.position) filteredData=filteredData.filter(x=>x.position===filter.position);

document.getElementById("modalTitle").innerText=
(filter.team||"")+" "+(filter.position||"");

renderModalTable(filteredData);
renderCountryFilter();
}

function renderModalTable(arr){
let tbody=document.getElementById("modalBody");
tbody.innerHTML=arr.map(r=>`
<tr>
<td>${r.leader}</td>
<td>${r.onsite}</td>
<td>${r.onlineLead}</td>
<td>${r.onlineTrain}</td>
<td>${r.group}</td>
<td>${r.team}</td>
<td>${r.name}</td>
<td>${r.id}</td>
<td>${r.country}</td>
<td>${r.position}</td>
<td>${r.market}</td>
</tr>
`).join("");
}

function renderCountryFilter(){
let sel=document.getElementById("countryFilter");
let countries=[...new Set(filteredData.map(x=>x.country).filter(Boolean))];
sel.innerHTML=`<option value="">å…¨éƒ¨å›½å®¶</option>`+
countries.map(c=>`<option>${c}</option>`).join("");
sel.onchange=()=>{
let val=sel.value;
let arr=filteredData;
if(val) arr=arr.filter(x=>x.country===val);
renderModalTable(arr);
};
}

document.getElementById("searchInput").oninput=(e)=>{
let val=e.target.value.toLowerCase();
let arr=filteredData.filter(x=>
x.name.toLowerCase().includes(val)||
x.id.toLowerCase().includes(val)
);
renderModalTable(arr);
};

function exportCSV(){
let rows=filteredData.map(x=>Object.values(x).join(",")).join("\n");
let blob=new Blob([rows],{type:"text/csv"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="å‘˜å·¥åå•.csv";
a.click();
}

function closeModal(){
document.getElementById("modal").style.display="none";
}

load();
</script>
</body>
</html>
