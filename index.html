<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HR System (Enterprise) - Fixed Column Index</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#f4f7fb;
      --bg1:#eef3fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e6edf7;
      --nav:#0b1220;
      --nav2:#0f172a;
      --accent:#2563eb;
      --accent2:#22c55e;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 6px 18px rgba(2,6,23,.08);
      --r12:12px;
      --r16:16px;
      --r20:20px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #eaf2ff 0%, transparent 55%),
                  radial-gradient(1200px 600px at 90% 10%, #edf7ff 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, var(--nav), var(--nav2));
      color:#fff;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    header .brand{
      font-weight:800;
      letter-spacing:.2px;
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      font-size:12px;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent2);display:inline-block;}

    .wrap{
      max-width: 1500px;
      margin: 0 auto;
      padding: 18px;
    }

    /* top nav tabs */
    .topTabs{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      margin: 8px 0 14px;
    }
    .tab{
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.08);
      font-weight:800;
      font-size:13px;
      color: var(--ink);
      transition:.15s;
    }
    .tab:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
    .tab.active{
      background: linear-gradient(180deg, #111827, #0b1220);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
    }

    /* filters bar */
    .filterBar{
      background: rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.08);
      box-shadow: var(--shadow2);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
    }
    .filterBar input, .filterBar select{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      outline:none;
      min-width: 180px;
    }
    .filterBar .meta{
      margin-left:auto;
      color: var(--muted);
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }

    /* cards */
    .card{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin-top: 14px;
      backdrop-filter: blur(12px);
    }
    .card h2{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      color: var(--muted);
      font-size:13px;
      font-weight:700;
      margin-top:6px;
    }

    /* kpi rows */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:12px;
      margin-top: 14px;
    }
    @media (max-width:1100px){
      .kpiRow{ grid-template-columns: repeat(2,1fr); }
    }
    .kpi{
      background: #fff;
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 8px 20px rgba(2,6,23,.06);
      cursor:pointer;
      transition:.15s;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(2,6,23,.09); }
    .kpi .t{ font-size:12px; color:var(--muted); font-weight:900; }
    .kpi .v{ font-size:28px; font-weight:1000; margin-top:6px; }
    .kpi .hint{ font-size:12px; color:#64748b; font-weight:800; margin-top:8px; }
    .kpi .spark{
      position:absolute; right:-30px; top:-30px;
      width:120px; height:120px;
      border-radius:999px;
      background: radial-gradient(circle at 40% 40%, rgba(37,99,235,.25), transparent 55%);
      filter: blur(0px);
    }

    /* role tiles */
    .tileGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width:1200px){ .tileGrid{ grid-template-columns: repeat(3,1fr);} }
    @media (max-width:700px){ .tileGrid{ grid-template-columns: repeat(2,1fr);} }

    .tile{
      background:#fff;
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      cursor:pointer;
      transition:.14s;
      min-height: 70px;
    }
    .tile:hover{ transform: translateY(-2px); box-shadow: 0 12px 24px rgba(2,6,23,.09); }
    .tile .name{ font-weight:950; font-size:13px; }
    .tile .count{ color:var(--muted); font-weight:900; margin-top:6px; }

    /* two charts row */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:1100px){ .grid2{ grid-template-columns: 1fr; } }

    .chartBox{ height: 360px; }
    .chartBox canvas{ width:100% !important; height:100% !important; }

    /* table */
    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      position:sticky; top:0;
      background: linear-gradient(180deg, #0b1220, #111827);
      color:#fff;
      padding:10px 10px;
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    tbody td{
      padding:9px 10px;
      border-bottom:1px solid #edf2f7;
      vertical-align:top;
      white-space:nowrap;
    }
    tbody tr:hover{ background: #f7fbff; }
    .link{
      color: var(--accent);
      font-weight:950;
      cursor:pointer;
    }

    /* compact table for less horizontal scroll */
    .compact table{ font-size:11px; }
    .compact tbody td{ padding:8px 8px; }

    /* cards view */
    .cardsView{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
    }
    @media(max-width:1100px){ .cardsView{ grid-template-columns: repeat(2,1fr); } }
    @media(max-width:700px){ .cardsView{ grid-template-columns: 1fr; } }

    .empCard{
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      border-radius:18px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
      padding:12px;
    }
    .empCard .row1{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start;
    }
    .empCard .nm{
      font-weight:1000;
      font-size:14px;
      line-height:1.2;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background:#f8fafc;
      color:#0f172a;
      white-space:nowrap;
    }
    .empCard .meta{
      margin-top:8px;
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 10px;
    }
    .empCard .meta div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      padding:9px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .btn.primary{
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }

    /* modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding: 18px;
    }
    .modal .box{
      width: min(1400px, 98vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      border-radius: 22px;
      padding: 16px;
      backdrop-filter: blur(14px);
    }
    .modal .head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      position:sticky; top:0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      padding: 10px 6px 12px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      z-index:2;
    }
    .modal .head h3{
      margin:0;
      font-size:16px;
      font-weight:1000;
    }
    .x{
      cursor:pointer;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:1000;
    }

    /* sections visibility */
    .page{ display:none; }
    .page.active{ display:block; }

    /* helper text */
    .note{
      margin-top:8px;
      color: var(--muted);
      font-weight:800;
      font-size:12px;
    }

    .warn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.10);
      color:#7c2d12;
      font-weight:900;
      font-size:12px;
      margin-top:10px;
      white-space:normal;
      line-height:1.4;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    HR System
    <span class="badge"><span class="dot"></span> Fixed column index</span>
  </div>
  <div class="badge">Google Sheet â†’ opensheet</div>
</header>

<div class="wrap">
  <div class="topTabs">
    <div class="tab active" data-page="dashboard">Dashboard</div>
    <div class="tab" data-page="employees">Employees</div>
    <div class="tab" data-page="schedule">æ’ç­è¡¨</div>
  </div>

  <div class="filterBar" id="filterBar">
    <input id="q" placeholder="Search name / ID / team / group / position / manager" />
    <select id="shiftSel"></select>
    <select id="teamSel"></select>
    <select id="groupSel"></select>
    <select id="posSel"></select>
    <div class="meta" id="meta">Loadingâ€¦</div>
  </div>

  <!-- Dashboard -->
  <div class="page active" id="page-dashboard"></div>

  <!-- Employees -->
  <div class="page" id="page-employees"></div>

  <!-- Schedule -->
  <div class="page" id="page-schedule"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <div class="head">
      <h3 id="modalTitle">Title</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="modalBack" style="display:none;">â† Back</button>
        <button class="x" id="modalClose">Close</button>
      </div>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const SHEET_API = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/å›¢é˜Ÿå¡«è¡¨";

/*
  âœ… FIX CORE: Read by fixed column position (A..M)
  A 0 è´Ÿè´£äºº
  B 1 ç°åœºåŸ¹è®­
  C 2 çº¿ä¸Šç»„é•¿
  D 3 çº¿ä¸ŠåŸ¹è®­
  E 4 ç»„åˆ«
  F 5 å›¢é˜Ÿ
  G 6 å§“å (KEY)
  H 7 ID
  I 8 ç­æ¬¡
  J 9 ID WORKFOLIO
  K 10 å›½å®¶
  L 11 å²—ä½
  M 12 ç›˜å£

  If your sheet has extra columns after M, it won't affect (we ignore >12).
*/

let RAW = [];
let FILTERED = [];
let charts = { pos:null, team:null, shift:null };
let empViewMode = "cards";

const els = {
  pageDashboard: document.getElementById("page-dashboard"),
  pageEmployees: document.getElementById("page-employees"),
  pageSchedule: document.getElementById("page-schedule"),

  tabs: document.querySelectorAll(".tab"),

  q: document.getElementById("q"),
  shiftSel: document.getElementById("shiftSel"),
  teamSel: document.getElementById("teamSel"),
  groupSel: document.getElementById("groupSel"),
  posSel: document.getElementById("posSel"),
  meta: document.getElementById("meta"),

  modal: document.getElementById("modal"),
  modalTitle: document.getElementById("modalTitle"),
  modalBody: document.getElementById("modalBody"),
  modalClose: document.getElementById("modalClose"),
  modalBack: document.getElementById("modalBack")
};

function esc(str){
  return (str??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* âœ… super clean normalize (fix NBSP/fullwidth space) */
function norm(v){
  return (v ?? "")
    .toString()
    .replace(/\u00A0/g, " ")
    .replace(/\u3000/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

function isValidName(name){
  const v = norm(name);
  if(!v) return false;
  const low = v.toLowerCase();
  if(low === "null" || low === "undefined") return false;
  if(v.replace(/\s/g,"") === "") return false;
  return true;
}

/* =========================================================
   NAV
========================================================= */
els.tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    els.tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const p = t.dataset.page;
    document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active"));
    document.getElementById("page-"+p).classList.add("active");
  });
});

/* =========================================================
   MODAL + STACK
========================================================= */
let modalStack = [];

function openModal(title, html){
  els.modalTitle.textContent = title;
  els.modalBody.innerHTML = html;
  els.modal.style.display="flex";
  els.modalBack.style.display = modalStack.length ? "inline-flex" : "none";
}
function pushModal(title, html){
  modalStack.push({ title: els.modalTitle.textContent, html: els.modalBody.innerHTML });
  els.modalBack.style.display = "inline-flex";
  openModal(title, html);
}
function closeModal(){
  els.modal.style.display="none";
  els.modalBody.innerHTML="";
  els.modalTitle.textContent="";
  modalStack = [];
  els.modalBack.style.display = "none";
}
els.modalClose.onclick = closeModal;
els.modal.onclick = (e)=>{ if(e.target === els.modal) closeModal(); };
els.modalBack.onclick = ()=>{
  const prev = modalStack.pop();
  if(!prev){ els.modalBack.style.display="none"; return; }
  openModal(prev.title, prev.html);
  els.modalBack.style.display = modalStack.length ? "inline-flex" : "none";
};

/* =========================================================
   FILTERS
========================================================= */
function buildSelectOptions(selectEl, items, labelAll){
  const opts = [`<option value="">${esc(labelAll)}</option>`]
    .concat(items.map(x=>`<option value="${esc(x)}">${esc(x)}</option>`));
  selectEl.innerHTML = opts.join("");
}

function applyFilters(){
  const q = norm(els.q.value).toLowerCase();
  const shift = els.shiftSel.value;
  const team  = els.teamSel.value;
  const group = els.groupSel.value;
  const pos   = els.posSel.value;

  FILTERED = RAW.filter(r=>{
    const å§“å = norm(r["å§“å"]);
    const ID = norm(r["ID"]);
    const å›¢é˜Ÿ = norm(r["å›¢é˜Ÿ"]);
    const ç»„åˆ« = norm(r["ç»„åˆ«"]);
    const å²—ä½ = norm(r["å²—ä½"]);
    const ç­æ¬¡ = norm(r["ç­æ¬¡"]);

    const è´Ÿè´£äºº = norm(r["è´Ÿè´£äºº"]);
    const ç°åœºåŸ¹è®­ = norm(r["ç°åœºåŸ¹è®­"]);
    const çº¿ä¸Šç»„é•¿ = norm(r["çº¿ä¸Šç»„é•¿"]);
    const çº¿ä¸ŠåŸ¹è®­ = norm(r["çº¿ä¸ŠåŸ¹è®­"]);

    if(shift && ç­æ¬¡ !== shift) return false;
    if(team && å›¢é˜Ÿ !== team) return false;
    if(group && ç»„åˆ« !== group) return false;
    if(pos && å²—ä½ !== pos) return false;

    if(q){
      const hay = [å§“å, ID, å›¢é˜Ÿ, ç»„åˆ«, å²—ä½, ç­æ¬¡, è´Ÿè´£äºº, ç°åœºåŸ¹è®­, çº¿ä¸Šç»„é•¿, çº¿ä¸ŠåŸ¹è®­].join(" ").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  els.meta.textContent = `Rows: ${RAW.length.toLocaleString()} â€¢ Filtered: ${FILTERED.length.toLocaleString()} â€¢ ${new Date().toLocaleString()}`;

  renderDashboard();
  renderEmployees();
  renderSchedule();
}

["input","change"].forEach(evt=>{
  els.q.addEventListener(evt, applyFilters);
  els.shiftSel.addEventListener(evt, applyFilters);
  els.teamSel.addEventListener(evt, applyFilters);
  els.groupSel.addEventListener(evt, applyFilters);
  els.posSel.addEventListener(evt, applyFilters);
});

/* =========================================================
   STATS HELPERS
========================================================= */
function getTotalPeopleSet(rows){
  const set = new Set();
  rows.forEach(r=>{
    const name = norm(r["å§“å"]);
    const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
    const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);

    if(!isValidName(name)) return;

    set.add(name);
    if(isValidName(leader)) set.add(leader);
    if(isValidName(trainer)) set.add(trainer);
  });
  return set;
}

function getUniqueSetByField(rows, field){
  const set = new Set();
  rows.forEach(r=>{
    const v = norm(r[field]);
    if(v) set.add(v);
  });
  return set;
}

function groupBy(rows, field, emptyLabel="æœªå¡«å†™"){
  const m = new Map();
  rows.forEach(r=>{
    const k = norm(r[field]) || emptyLabel;
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  });
  return m;
}

function countByUniqueName(rows){
  const set = new Set();
  rows.forEach(r=>{
    const name = norm(r["å§“å"]);
    if(isValidName(name)) set.add(name);
  });
  return set.size;
}

/* =========================================================
   FULL TABLE RENDER
========================================================= */
function renderFullTable(rows, titleHint=""){
  const cols = ["è´Ÿè´£äºº","ç°åœºåŸ¹è®­","çº¿ä¸Šç»„é•¿","çº¿ä¸ŠåŸ¹è®­","ç»„åˆ«","å›¢é˜Ÿ","ç­æ¬¡","å²—ä½","å§“å","ID","å›½å®¶","ç›˜å£"];
  return `
    <div class="note">${esc(titleHint)} Rows: <b>${rows.length.toLocaleString()}</b></div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              ${cols.map(c=>`<td>${esc(norm(r[c]))}</td>`).join("")}
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

/* =========================================================
   MANAGER â†’ SUBORDINATES
========================================================= */
function openManagerList(fieldLabel, rows){
  const set = getUniqueSetByField(rows, fieldLabel);
  const names = [...set].sort((a,b)=>a.localeCompare(b,"zh"));
  const html = `
    <div class="note">ç‚¹å‡»åå­— â†’ æŸ¥çœ‹è¯¥ ${esc(fieldLabel)} ç®¡ç†çš„å‘˜å·¥ï¼ˆæŒ‰å­—æ®µåŒååŒ¹é…ï¼‰ã€‚</div>
    <div class="tileGrid">
      ${names.map(n=>{
        const subs = rows.filter(r=>norm(r[fieldLabel])===n);
        const c = countByUniqueName(subs);
        return `
          <div class="tile" onclick="openManagerSubs('${esc(fieldLabel)}','${esc(n)}')">
            <div class="name">${esc(n)}</div>
            <div class="count">ä¸‹å±ï¼ˆæŒ‰å§“åå»é‡ï¼‰: ${c}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;
  openModal(`${fieldLabel} åå•ï¼ˆ${names.length}ï¼‰`, html);
}

window.openManagerSubs = function(fieldLabel, managerName){
  const subs = FILTERED.filter(r=>norm(r[fieldLabel])===managerName);
  pushModal(`${fieldLabel}ï¼š${managerName}ï¼ˆä¸‹å± ${countByUniqueName(subs)}ï¼‰`, renderFullTable(subs, `${fieldLabel} = ${managerName}`));
};

/* =========================================================
   DASHBOARD
========================================================= */
function renderDashboard(){
  const rows = FILTERED;

  const totalPeopleSet = getTotalPeopleSet(rows);
  const totalPeople = totalPeopleSet.size;

  const ownerSet  = getUniqueSetByField(rows,"è´Ÿè´£äºº");
  const onsiteSet = getUniqueSetByField(rows,"ç°åœºåŸ¹è®­");
  const leaderSet = getUniqueSetByField(rows,"çº¿ä¸Šç»„é•¿");
  const trainSet  = getUniqueSetByField(rows,"çº¿ä¸ŠåŸ¹è®­");

  const posMap = groupBy(rows,"å²—ä½");
  const posLabels = [...posMap.keys()];
  const posCounts = posLabels.map(k=>countByUniqueName(posMap.get(k)));

  const teamMap = groupBy(rows,"å›¢é˜Ÿ");
  const teamLabels = [...teamMap.keys()];
  const teamCounts = teamLabels.map(k=>countByUniqueName(teamMap.get(k)));

  const allPositions = uniq(rows.map(r=>norm(r["å²—ä½"])||"æœªå¡«å†™")).sort((a,b)=>a.localeCompare(b,"zh"));

  const teamRows = [...teamMap.entries()]
    .map(([team, list])=>{
      const total = countByUniqueName(list);

      const byPosSet = new Map();
      allPositions.forEach(p=>byPosSet.set(p, new Set()));

      list.forEach(r=>{
        const p = norm(r["å²—ä½"])||"æœªå¡«å†™";
        const nm = norm(r["å§“å"]);
        if(isValidName(nm)) byPosSet.get(p).add(nm);
      });

      const byPosFinal = allPositions.map(p=>byPosSet.get(p).size);
      return { team, list, total, byPosFinal };
    })
    .sort((a,b)=>b.total-a.total);

  els.pageDashboard.innerHTML = `
    <div class="card">
      <h2>ç»Ÿè®¡æ€»è§ˆ</h2>
      <div class="sub">æŒ‰å²—ä½ & å›¢é˜Ÿç»Ÿè®¡ï¼ˆç‚¹å‡»å¡ç‰‡/å›¾è¡¨å¯å¼¹çª—æŸ¥çœ‹å‘˜å·¥åå•ï¼‰</div>

      <div class="kpiRow">
        <div class="kpi" onclick="openModal('æ€»äººæ•°åå•ï¼ˆå»é‡é€»è¾‘ï¼šå§“å+çº¿ä¸Šç»„é•¿+çº¿ä¸ŠåŸ¹è®­ï¼‰', renderFullTable(FILTERED,'åå•å±•ç¤ºä¸ºç­›é€‰åçš„æ‰€æœ‰åŸå§‹è¡Œï¼›å»é‡é€»è¾‘ä»…ç”¨äºæ•°å­—ç»Ÿè®¡'))">
          <div class="spark"></div>
          <div class="t">æ€»äººæ•°ï¼ˆå»é‡ï¼‰</div>
          <div class="v">${totalPeople.toLocaleString()}</div>
          <div class="hint">å§“å + çº¿ä¸Šç»„é•¿ + çº¿ä¸ŠåŸ¹è®­ï¼ˆuniqueï¼‰</div>
        </div>

        <div class="kpi" onclick="openManagerList('è´Ÿè´£äºº', FILTERED)">
          <div class="spark"></div>
          <div class="t">è´Ÿè´£äºº</div>
          <div class="v">${ownerSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('ç°åœºåŸ¹è®­', FILTERED)">
          <div class="spark"></div>
          <div class="t">ç°åœºåŸ¹è®­</div>
          <div class="v">${onsiteSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('çº¿ä¸Šç»„é•¿', FILTERED)">
          <div class="spark"></div>
          <div class="t">çº¿ä¸Šç»„é•¿</div>
          <div class="v">${leaderSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>

        <div class="kpi" onclick="openManagerList('çº¿ä¸ŠåŸ¹è®­', FILTERED)">
          <div class="spark"></div>
          <div class="t">çº¿ä¸ŠåŸ¹è®­</div>
          <div class="v">${trainSet.size.toLocaleString()}</div>
          <div class="hint">ç‚¹å‡»æŸ¥çœ‹åå• â†’ å†ç‚¹äººçœ‹ä¸‹å±</div>
        </div>
      </div>

      <div class="warn">
        <span>âœ… å·²å¯ç”¨ <b>å›ºå®šåˆ—è¯»å–</b>ï¼ˆA..Mï¼‰é˜²æ­¢ è´Ÿè´£äºº/åŸ¹è®­/ç»„é•¿ é”™ä½ã€‚</span>
        <span class="mono">åªè¦ä½ çš„è¡¨æ ¼ A..M é¡ºåºä¸å˜ï¼Œheader æ€ä¹ˆæ”¹éƒ½ä¸å½±å“ã€‚</span>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:1000; font-size:16px;">å²—ä½åˆ†å¸ƒ</div>
            <div class="note">ç‚¹å‡»å›¾å½¢ â†’ å¼¹å‡ºè¯¥å²—ä½å‘˜å·¥åå•</div>
          </div>
          <button class="btn" onclick="openModal('å²—ä½ç»Ÿè®¡ï¼ˆæŒ‰å§“åå»é‡ï¼‰', renderTeamOrPosSummary('å²—ä½','å²—ä½'))">æŸ¥çœ‹æ±‡æ€»</button>
        </div>
        <div class="chartBox"><canvas id="chartPos"></canvas></div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:1000; font-size:16px;">å›¢é˜Ÿäººæ•°ï¼ˆcá»™t Fï¼šå›¢é˜Ÿï¼‰</div>
            <div class="note">ç‚¹å‡»æŸ±å­ â†’ å¼¹å‡ºè¯¥å›¢é˜Ÿå‘˜å·¥åå•</div>
          </div>
          <button class="btn" onclick="openModal('å›¢é˜Ÿç»Ÿè®¡ï¼ˆæŒ‰å§“åå»é‡ï¼‰', renderTeamOrPosSummary('å›¢é˜Ÿ','å›¢é˜Ÿ'))">æŸ¥çœ‹æ±‡æ€»</button>
        </div>
        <div class="chartBox"><canvas id="chartTeam"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <div style="font-weight:1000; font-size:16px;">å›¢é˜Ÿç»Ÿè®¡è¡¨ï¼ˆcá»™t Fï¼‰</div>
          <div class="note">ç‚¹å‡»æ•°å­— â†’ å¼¹çª—æŸ¥çœ‹å¯¹åº”å‘˜å·¥åå•</div>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>å›¢é˜Ÿ</th>
              <th>æ€»äººæ•°</th>
              ${allPositions.map(p=>`<th>${esc(p)}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${teamRows.map(tr=>{
              const cells = tr.byPosFinal.map((n,idx)=>{
                const pos = allPositions[idx];
                return `<td class="link" onclick="openTeamPos('${esc(tr.team)}','${esc(pos)}')">${n}</td>`;
              }).join("");
              return `
                <tr>
                  <td class="link" onclick="openTeam('${esc(tr.team)}')">${esc(tr.team)}</td>
                  <td class="link" onclick="openTeam('${esc(tr.team)}')">${tr.total}</td>
                  ${cells}
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;

  buildPosChart(posLabels, posCounts);
  buildTeamChart(teamLabels, teamCounts);
}

function renderTeamOrPosSummary(fieldLabel, fieldName){
  const m = groupBy(FILTERED, fieldName);
  const rows = [...m.entries()]
    .map(([k,list])=>({k, c: countByUniqueName(list)}))
    .sort((a,b)=>b.c-a.c);

  return `
    <div class="tableWrap">
      <table>
        <thead><tr><th>${esc(fieldLabel)}</th><th>äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰</th></tr></thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td class="link" onclick="${fieldName==='å›¢é˜Ÿ' ? `openTeam('${esc(r.k)}')` : `openPos('${esc(r.k)}')`}">${esc(r.k)}</td>
              <td>${r.c}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function buildPosChart(labels, values){
  const ctx = document.getElementById("chartPos");
  if(!ctx) return;
  if(charts.pos) charts.pos.destroy();

  charts.pos = new Chart(ctx, {
    type:"doughnut",
    data:{ labels, datasets:[{ data: values }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ position:"top", labels:{ boxWidth:18, font:{ size:11, weight:"700" } } }
      },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        openPos(labels[elements[0].index]);
      }
    }
  });
}

function buildTeamChart(labels, values){
  const ctx = document.getElementById("chartTeam");
  if(!ctx) return;
  if(charts.team) charts.team.destroy();

  charts.team = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰", data: values }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ font:{ size:10, weight:"700" }, maxRotation:60, minRotation:60 } },
        y:{ ticks:{ font:{ size:10, weight:"700" } } }
      },
      plugins:{ legend:{ display:false } },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        openTeam(labels[elements[0].index]);
      }
    }
  });
}

window.openPos = function(pos){
  const rows = FILTERED.filter(r=> (norm(r["å²—ä½"])||"æœªå¡«å†™") === pos );
  openModal(`${pos} å‘˜å·¥åå•ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å²—ä½ = ${pos}`));
};
window.openTeam = function(team){
  const rows = FILTERED.filter(r=> (norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™") === team );
  openModal(`${team} å‘˜å·¥åå•ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å›¢é˜Ÿ(cá»™t F) = ${team}`));
};
window.openTeamPos = function(team, pos){
  const rows = FILTERED.filter(r=> (norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")===team && (norm(r["å²—ä½"])||"æœªå¡«å†™")===pos );
  openModal(`${team} Â· ${pos}ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `å›¢é˜Ÿ = ${team} ä¸” å²—ä½ = ${pos}`));
};

/* =========================================================
   EMPLOYEES
========================================================= */
function renderEmployees(){
  const rows = FILTERED;

  const header = `
    <div class="card">
      <h2>Employees</h2>
      <div class="sub">æ”¯æŒç­›é€‰/æœç´¢ã€‚é»˜è®¤ Cards è§†å›¾é¿å…æ¨ªå‘æ»šåŠ¨ã€‚</div>
      <div class="btnRow">
        <button class="btn ${empViewMode==='cards'?'primary':''}" onclick="setEmpView('cards')">Cards viewï¼ˆä¸æ¨ªæ»šï¼‰</button>
        <button class="btn ${empViewMode==='table'?'primary':''}" onclick="setEmpView('table')">Table viewï¼ˆå®Œæ•´åˆ—ï¼‰</button>
        <button class="btn" onclick="openModal('Employeesï¼ˆå®Œæ•´è¡¨ï¼‰', renderFullTable(FILTERED,'ç­›é€‰åçš„å®Œæ•´å‘˜å·¥è¡¨'))">å¼¹çª—å…¨å±æŸ¥çœ‹</button>
      </div>
    </div>
  `;

  let body = "";
  if(empViewMode==="cards"){
    body = `
      <div class="card">
        <div class="cardsView">
          ${rows.map(r=>{
            const nm = norm(r["å§“å"]);
            const pos = norm(r["å²—ä½"])||"æœªå¡«å†™";
            const team = norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™";
            const grp = norm(r["ç»„åˆ«"])||"æœªå¡«å†™";
            const shift = norm(r["ç­æ¬¡"])||"";
            const id = norm(r["ID"])||"";
            const country = norm(r["å›½å®¶"])||"";
            const pan = norm(r["ç›˜å£"])||"";
            const owner = norm(r["è´Ÿè´£äºº"])||"";
            const onsite = norm(r["ç°åœºåŸ¹è®­"])||"";
            const leader = norm(r["çº¿ä¸Šç»„é•¿"])||"";
            const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"])||"";
            return `
              <div class="empCard">
                <div class="row1">
                  <div>
                    <div class="nm">${esc(nm||"(æœªå¡«å†™å§“å)")}</div>
                    <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                      <span class="pill">${esc(pos)}</span>
                      <span class="pill">å›¢é˜Ÿ: ${esc(team)}</span>
                      <span class="pill">ç»„åˆ«: ${esc(grp)}</span>
                      ${shift ? `<span class="pill">ç­æ¬¡: ${esc(shift)}</span>` : ``}
                    </div>
                  </div>
                  <div style="text-align:right;">
                    <div class="pill">${esc(id||"No ID")}</div>
                    <div style="margin-top:8px; color:var(--muted); font-weight:900; font-size:12px;">${esc(country)}</div>
                  </div>
                </div>
                <div class="meta">
                  <div>è´Ÿè´£äºº: <span class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner||"-")}</span></div>
                  <div>ç°åœºåŸ¹è®­: <span class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite||"-")}</span></div>
                  <div>çº¿ä¸Šç»„é•¿: <span class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader||"-")}</span></div>
                  <div>çº¿ä¸ŠåŸ¹è®­: <span class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer||"-")}</span></div>
                  <div style="grid-column:1 / -1;">ç›˜å£: ${esc(pan||"-")}</div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;
  }else{
    body = `
      <div class="card compact">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>å§“å</th><th>ID</th><th>å²—ä½</th><th>å›¢é˜Ÿ(cá»™t F)</th><th>ç»„åˆ«</th><th>ç­æ¬¡(cá»™t I)</th>
                <th>è´Ÿè´£äºº</th><th>ç°åœºåŸ¹è®­</th><th>çº¿ä¸Šç»„é•¿</th><th>çº¿ä¸ŠåŸ¹è®­</th><th>å›½å®¶</th><th>ç›˜å£</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>{
                const owner = norm(r["è´Ÿè´£äºº"]);
                const onsite = norm(r["ç°åœºåŸ¹è®­"]);
                const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
                const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);
                return `
                  <tr>
                    <td>${esc(norm(r["å§“å"]))}</td>
                    <td>${esc(norm(r["ID"]))}</td>
                    <td class="link" onclick="openPos('${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}')">${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}</td>
                    <td class="link" onclick="openTeam('${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}')">${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}</td>
                    <td>${esc(norm(r["ç»„åˆ«"]))}</td>
                    <td>${esc(norm(r["ç­æ¬¡"]))}</td>
                    <td class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner)}</td>
                    <td class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite)}</td>
                    <td class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader)}</td>
                    <td class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer)}</td>
                    <td>${esc(norm(r["å›½å®¶"]))}</td>
                    <td>${esc(norm(r["ç›˜å£"]))}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  els.pageEmployees.innerHTML = header + body;
}

window.setEmpView = function(mode){
  empViewMode = mode;
  renderEmployees();
};

/* =========================================================
   SCHEDULEï¼ˆæ’ç­è¡¨ï¼‰
========================================================= */
function renderSchedule(){
  const rows = FILTERED;

  const rowsWithShift = rows.filter(r=> norm(r["ç­æ¬¡"]) !== "");
  const rowsNoShift   = rows.filter(r=> norm(r["ç­æ¬¡"]) === "");

  const shiftMap = groupBy(rowsWithShift, "ç­æ¬¡", "");
  const shiftLabels = [...shiftMap.keys()].filter(k=>k!=="");
  const shiftCounts = shiftLabels.map(k=>countByUniqueName(shiftMap.get(k)));

  const shiftCards = shiftLabels
    .map((k,idx)=>({k, c: shiftCounts[idx]}))
    .sort((a,b)=>b.c-a.c)
    .map(x=>`
      <div class="kpi" style="min-height:86px" onclick="openShift('${esc(x.k)}')">
        <div class="spark"></div>
        <div class="t">ç­æ¬¡</div>
        <div class="v" style="font-size:24px">${esc(x.k)}</div>
        <div class="hint">${x.c} äººï¼ˆæŒ‰å§“åå»é‡ï¼‰</div>
      </div>
    `).join("");

  const noShiftUnique = countByUniqueName(rowsNoShift);

  els.pageSchedule.innerHTML = `
    <div class="card">
      <h2>æ’ç­è¡¨</h2>
      <div class="sub">æŒ‰ç­æ¬¡ç»Ÿè®¡ï¼ˆç­æ¬¡æ¥è‡ª cá»™t Iï¼‰ã€‚ç‚¹å‡»ç­æ¬¡å¡ç‰‡ â†’ æŸ¥çœ‹åå•ã€‚</div>
      <div class="note">âœ… Fixed column index å·²å¯ç”¨ï¼Œé¿å…é”™ä½ã€‚</div>
    </div>

    <div class="card">
      <div style="font-weight:1000; font-size:16px;">ç­æ¬¡ç»Ÿè®¡</div>
      <div class="note">åªç»Ÿè®¡æœ‰ç­æ¬¡çš„è¡Œï¼›æœªå¡«å†™ç­æ¬¡å•ç‹¬ç»Ÿè®¡ã€‚</div>

      <div class="kpiRow" style="grid-template-columns:repeat(3,1fr)">
        ${shiftCards || `<div class="note">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç­æ¬¡æ•°æ®ï¼ˆå…¨éƒ¨ä¸ºç©ºæˆ–è¢«ç­›é€‰æ‰ï¼‰</div>`}
        <div class="kpi" style="min-height:86px" onclick="openNoShift()">
          <div class="spark"></div>
          <div class="t">æœªå¡«å†™ç­æ¬¡</div>
          <div class="v" style="font-size:24px">${noShiftUnique.toLocaleString()}</div>
          <div class="hint">æŒ‰å§“åå»é‡ï¼ˆç‚¹å‡»æŸ¥çœ‹åå•ï¼‰</div>
        </div>
      </div>

      <div class="chartBox" style="margin-top:14px"><canvas id="chartShift"></canvas></div>
    </div>

    <div class="card compact">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:1000; font-size:16px;">æ’ç­æ˜ç»†ï¼ˆå…¨éƒ¨äººå‘˜ï¼Œä¸é™åˆ¶ 18ï¼‰</div>
          <div class="note">è¿™é‡Œæ˜¯ compact tableã€‚æƒ³æ›´èˆ’æœçœ‹ï¼šEmployees â†’ Cards viewã€‚</div>
        </div>
        <button class="btn" onclick="openModal('æ’ç­æ˜ç»†ï¼ˆå¼¹çª—å…¨å±ï¼‰', renderFullTable(FILTERED,'æ’ç­æ˜ç»†ï¼šç­›é€‰åçš„æ‰€æœ‰è¡Œ'))">å¼¹çª—å…¨å±æŸ¥çœ‹</button>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>è´Ÿè´£äºº</th><th>ç°åœºåŸ¹è®­</th><th>çº¿ä¸Šç»„é•¿</th><th>çº¿ä¸ŠåŸ¹è®­</th>
              <th>å›¢é˜Ÿ(cá»™t F)</th><th>ç»„åˆ«</th><th>ç­æ¬¡(cá»™t I)</th><th>å²—ä½</th><th>å§“å</th><th>ID</th><th>å›½å®¶</th><th>ç›˜å£</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const owner = norm(r["è´Ÿè´£äºº"]);
              const onsite = norm(r["ç°åœºåŸ¹è®­"]);
              const leader = norm(r["çº¿ä¸Šç»„é•¿"]);
              const trainer = norm(r["çº¿ä¸ŠåŸ¹è®­"]);
              return `
                <tr>
                  <td class="link" onclick="openManagerSubs('è´Ÿè´£äºº','${esc(owner)}')">${esc(owner)}</td>
                  <td class="link" onclick="openManagerSubs('ç°åœºåŸ¹è®­','${esc(onsite)}')">${esc(onsite)}</td>
                  <td class="link" onclick="openManagerSubs('çº¿ä¸Šç»„é•¿','${esc(leader)}')">${esc(leader)}</td>
                  <td class="link" onclick="openManagerSubs('çº¿ä¸ŠåŸ¹è®­','${esc(trainer)}')">${esc(trainer)}</td>
                  <td class="link" onclick="openTeam('${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}')">${esc(norm(r["å›¢é˜Ÿ"])||"æœªå¡«å†™")}</td>
                  <td>${esc(norm(r["ç»„åˆ«"]))}</td>
                  <td>${esc(norm(r["ç­æ¬¡"]))}</td>
                  <td class="link" onclick="openPos('${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}')">${esc(norm(r["å²—ä½"])||"æœªå¡«å†™")}</td>
                  <td>${esc(norm(r["å§“å"]))}</td>
                  <td>${esc(norm(r["ID"]))}</td>
                  <td>${esc(norm(r["å›½å®¶"]))}</td>
                  <td>${esc(norm(r["ç›˜å£"]))}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;

  buildShiftChart(shiftLabels, shiftCounts);
}

window.openShift = function(shift){
  const rows = FILTERED.filter(r=> norm(r["ç­æ¬¡"]) === shift);
  openModal(`ç­æ¬¡ï¼š${shift}ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `ç­æ¬¡(cá»™t I) = ${shift}`));
};

window.openNoShift = function(){
  const rows = FILTERED.filter(r=> norm(r["ç­æ¬¡"]) === "");
  openModal(`æœªå¡«å†™ç­æ¬¡ï¼ˆ${countByUniqueName(rows)}ï¼‰`, renderFullTable(rows, `ç­æ¬¡(cá»™t I) ä¸ºç©º/ç©ºæ ¼`));
};

function buildShiftChart(labels, values){
  const ctx = document.getElementById("chartShift");
  if(!ctx) return;
  if(charts.shift) charts.shift.destroy();

  charts.shift = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"äººæ•°ï¼ˆæŒ‰å§“åå»é‡ï¼‰", data: values }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ ticks:{ font:{ size:10, weight:"700" }, maxRotation:45, minRotation:45 } },
        y:{ ticks:{ font:{ size:10, weight:"700" } } }
      },
      onClick: (evt, elements)=>{
        if(!elements?.length) return;
        openShift(labels[elements[0].index]]);
      }
    }
  });
}

/* =========================================================
   LOAD (FIXED COLUMN INDEX)
========================================================= */
async function load(){
  els.meta.textContent = "Loading data from Google Sheetâ€¦";
  const res = await fetch(SHEET_API, { cache:"no-store" });
  const data = await res.json();

  if(!Array.isArray(data) || data.length === 0){
    els.meta.textContent = "No data";
    els.pageDashboard.innerHTML = `<div class="card"><h2>åŠ è½½å¤±è´¥</h2><div class="note">æ²¡æœ‰è¯»å–åˆ°ä»»ä½•æ•°æ®ã€‚</div></div>`;
    return;
  }

  // Get keys in insertion order = sheet columns order (A..)
  const keys = Object.keys(data[0] || {});
  // Safety: if sheet has less than 13 columns, we still try but warn
  const need = 13;
  const ok = keys.length >= need;

  // Map row by fixed index
RAW = [];

for (let i = 0; i < data.length; i++) {

  const row = data[i];
  const keys = Object.keys(row);

  const get = (index) => norm(row[keys[index]]);

  const name = get(6); // cá»™t G: å§“å

  // ğŸš€ náº¿u khÃ´ng cÃ³ tÃªn thÃ¬ bá» ngay
  if (!name) continue;

  RAW.push({
    "è´Ÿè´£äºº": get(0),
    "ç°åœºåŸ¹è®­": get(1),
    "çº¿ä¸Šç»„é•¿": get(2),
    "çº¿ä¸ŠåŸ¹è®­": get(3),
    "ç»„åˆ«": get(4),
    "å›¢é˜Ÿ": get(5),
    "å§“å": name,
    "ID": get(7),
    "ç­æ¬¡": get(8),
    "ID WORKFOLIO": get(9),
    "å›½å®¶": get(10),
    "å²—ä½": get(11),
    "ç›˜å£": get(12)
  });

}

  // Build filter options from RAW
  const shifts = uniq(RAW.map(r=>r["ç­æ¬¡"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
  const teams  = uniq(RAW.map(r=>r["å›¢é˜Ÿ"]||"æœªå¡«å†™").filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
  const groups = uniq(RAW.map(r=>r["ç»„åˆ«"]||"æœªå¡«å†™").filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));
  const poss   = uniq(RAW.map(r=>r["å²—ä½"]||"æœªå¡«å†™").filter(Boolean)).sort((a,b)=>a.localeCompare(b,"zh"));

  buildSelectOptions(els.shiftSel, shifts, "All shiftsï¼ˆç­æ¬¡ cá»™t Iï¼‰");
  buildSelectOptions(els.teamSel, teams, "All teamsï¼ˆå›¢é˜Ÿ cá»™t Fï¼‰");
  buildSelectOptions(els.groupSel, groups, "All groupsï¼ˆç»„åˆ« cá»™t Eï¼‰");
  buildSelectOptions(els.posSel, poss, "All positionsï¼ˆå²—ä½ï¼‰");

  if(!ok){
    els.pageDashboard.innerHTML = `
      <div class="card">
        <h2>âš ï¸ è¡¨æ ¼åˆ—æ•°ä¸è¶³</h2>
        <div class="note">éœ€è¦è‡³å°‘ 13 åˆ—ï¼ˆA..Mï¼‰ã€‚å½“å‰ keys=${keys.length}</div>
        <div class="note mono">${esc(JSON.stringify(keys))}</div>
      </div>
    `;
  }

  applyFilters();
}

load();
</script>
</body>
</html>
