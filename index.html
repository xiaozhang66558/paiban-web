<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR System (Public)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --nav:#0b1220;
      --nav2:#0f172a;
      --primary:#2563eb;
      --pill:#eef2ff;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --shadow2:0 2px 10px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:Segoe UI,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(180deg,var(--nav),var(--nav2));
      color:#fff;
      padding:14px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand strong{letter-spacing:.2px}
    .dot{width:9px;height:9px;border-radius:99px;background:#22c55e;display:inline-block}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;color:#e2e8f0
    }
    .container{max-width:1280px;margin:18px auto;padding:0 18px}
    .tabs{
      display:flex;gap:10px;align-items:center;
      padding:10px;background:rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.7);
      border-radius:999px;
      width:fit-content;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .tab{
      padding:8px 14px;border-radius:999px;cursor:pointer;
      background:rgba(15,23,42,.08);color:var(--text);
      font-weight:600;font-size:13px;
      user-select:none;
    }
    .tab.active{background:#0f172a;color:#fff}
    .topRow{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:14px 0}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:0;cursor:pointer;
      padding:9px 12px;border-radius:12px;font-weight:700;font-size:13px;
      background:#0f172a;color:#fff;
      box-shadow:var(--shadow2);
    }
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line)}
    .input, select{
      padding:9px 12px;border-radius:12px;border:1px solid var(--line);
      outline:none;background:#fff;min-width:220px;
      box-shadow:0 1px 0 rgba(15,23,42,.02);
    }
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      border:1px solid rgba(255,255,255,.8);
    }
    .title{font-size:22px;margin:0 0 6px 0}
    .sub{color:var(--muted);font-size:13px}

    .kpiGrid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;margin:14px 0;
    }
    .kpi{
      padding:16px;border-radius:16px;background:#fff;box-shadow:var(--shadow2);
      border:1px solid rgba(15,23,42,.06);
    }
    .kpi .label{color:var(--muted);font-size:12px;font-weight:700}
    .kpi .value{font-size:26px;font-weight:900;margin-top:6px}
    .kpi .small{color:var(--muted);font-size:12px;margin-top:4px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .chartBox{height:420px}
    canvas{max-width:100%}

    .sectionTitle{
      font-size:16px;font-weight:900;margin:0 0 12px 0;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }

    /* Position cards */
    .chipsGrid{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:10px;
    }
    .chipCard{
      background:#fff;border:1px solid rgba(15,23,42,.06);
      border-radius:16px;padding:12px;
      box-shadow:var(--shadow2);
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease;
    }
    .chipCard:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(15,23,42,.12)}
    .chipCard .name{font-weight:900;font-size:13px;line-height:1.2}
    .chipCard .cnt{font-weight:900;font-size:18px;margin-top:6px;color:var(--primary)}

    /* Team cards (horizontal stats) */
    .teamList{display:flex;flex-direction:column;gap:12px}
    .teamCard{
      background:#fff;border:1px solid rgba(15,23,42,.06);
      border-radius:18px;padding:14px;
      box-shadow:var(--shadow2);
    }
    .teamHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .teamName{font-weight:900}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:8px 10px;border-radius:14px;
      background:var(--pill);
      border:1px solid rgba(37,99,235,.18);
      font-weight:800;font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{filter:brightness(.98)}
    .pill.gray{background:#f1f5f9;border-color:rgba(15,23,42,.10)}

    /* Tables */
    .tableWrap{overflow:auto;border-radius:16px;border:1px solid rgba(15,23,42,.08)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{
      position:sticky;top:0;
      background:#0f172a;color:#fff;
      padding:10px;font-size:13px;text-align:left;
      white-space:nowrap;
    }
    tbody td{padding:10px;border-bottom:1px solid #eef2f7;font-size:13px;white-space:nowrap}
    tbody tr:hover{background:#f8fafc}

    .hidden{display:none !important}

    /* Modal */
    .modal{
      position:fixed;inset:0;z-index:999;
      background:rgba(2,6,23,.55);
      display:flex;align-items:center;justify-content:center;
      padding:18px;
    }
    .modalBox{
      width:min(1100px, 96vw);
      max-height:86vh;
      overflow:hidden;
      background:#fff;border-radius:22px;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.7);
      display:flex;flex-direction:column;
    }
    .modalTop{
      padding:14px 16px;
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      border-bottom:1px solid #eef2f7;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
    }
    .modalTitle{font-weight:1000}
    .modalClose{
      border:0;cursor:pointer;background:#0f172a;color:#fff;
      padding:8px 10px;border-radius:12px;font-weight:900;
    }
    .modalBody{padding:14px 16px;overflow:auto}
    .modalFilters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}

    /* Roster layout */
    .posBlock{
      background:#fff;border:1px solid rgba(15,23,42,.06);
      border-radius:18px;box-shadow:var(--shadow2);
      padding:14px;margin-bottom:12px;
    }
    .posHeader{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      font-weight:1000;
    }
    .posHeader .meta{color:var(--muted);font-size:12px;font-weight:800}
    .shiftGrid{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-top:10px}
    .shiftCard{
      border:1px solid rgba(15,23,42,.08);
      border-radius:16px;padding:10px;background:#fbfdff;
    }
    .shiftCard .sTitle{font-weight:1000;font-size:13px}
    .shiftCard .sCount{color:var(--primary);font-weight:1000;margin-top:4px}
    .divider{height:1px;background:#eef2f7;margin:10px 0}
    @media (max-width:1100px){
      .kpiGrid{grid-template-columns:repeat(2,1fr)}
      .grid2{grid-template-columns:1fr}
      .chipsGrid{grid-template-columns:repeat(3,1fr)}
      .shiftGrid{grid-template-columns:1fr}
      .input, select{min-width:160px}
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <strong>HR System</strong>
    <span class="badge"><span class="dot"></span> Public Dashboard</span>
  </div>
  <div class="actions">
    <button class="btn secondary" id="btnReload">Reload</button>
  </div>
</header>

<div class="container">

  <div class="topRow">
    <div class="tabs">
      <div class="tab active" data-page="dashboard">Dashboard</div>
      <div class="tab" data-page="employees">Employees</div>
      <div class="tab" data-page="roster">排版表</div>
    </div>

    <div class="actions">
      <input id="globalSearch" class="input" placeholder="Search name / ID / team / position..." />
      <select id="filterShift">
        <option value="">All shifts</option>
        <option value="白班">白班</option>
        <option value="夜班">夜班</option>
        <option value="中班">中班</option>
        <option value="Day">Day</option>
        <option value="Night">Night</option>
        <option value="12:30">12:30</option>
      </select>
      <select id="filterTeam">
        <option value="">All teams</option>
      </select>
      <select id="filterPos">
        <option value="">All positions</option>
      </select>
    </div>
  </div>

  <div class="hint">
    数据来源：Google Sheet（OpenSheet JSON）。已按你要求：团队=Google Sheet **cột F**；岗位=（图上）岗位列；ID=ID列；姓名=姓名列；国家=国家列。
  </div>

  <!-- DASHBOARD -->
  <section id="page-dashboard">
    <div class="card">
      <h2 class="title">统计总览</h2>
      <div class="sub">点击岗位卡片 / 团队统计中的数字，会弹窗显示员工名单</div>
    </div>

    <div class="kpiGrid">
      <div class="kpi">
        <div class="label">总人数（去重）</div>
        <div class="value" id="kTotal">-</div>
        <div class="small">规则：ID 不为空 +（姓名/组别等兜底）去重</div>
      </div>
      <div class="kpi">
        <div class="label">出款人数</div>
        <div class="value" id="kWD">-</div>
        <div class="small">岗位=出款</div>
      </div>
      <div class="kpi">
        <div class="label">客服人数</div>
        <div class="value" id="kCS">-</div>
        <div class="small">岗位=客服</div>
      </div>
      <div class="kpi">
        <div class="label">查单人数</div>
        <div class="value" id="kDP">-</div>
        <div class="small">岗位=查单</div>
      </div>
    </div>

    <!-- Charts ON TOP (as you requested) -->
    <div class="grid2">
      <div class="card chartBox">
        <div class="sectionTitle">岗位分布（点击扇区弹出名单）</div>
        <canvas id="chartPosition"></canvas>
      </div>
      <div class="card chartBox">
        <div class="sectionTitle">团队人数（cột F，点击柱子弹出名单）</div>
        <canvas id="chartTeam"></canvas>
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- Position cards (each position one card) -->
    <div class="card">
      <div class="sectionTitle">岗位统计（每个岗位一个卡片，点击查看员工）</div>
      <div class="chipsGrid" id="posCards"></div>
    </div>

    <div style="height:14px"></div>

    <!-- Team cards (each team one block, horizontal pills) -->
    <div class="card">
      <div class="sectionTitle">
        <span>团队统计（真正用 cột F）</span>
        <span class="sub">每个团队：总人数 + 各岗位人数（点击弹窗）</span>
      </div>
      <div class="teamList" id="teamCards"></div>
    </div>
  </section>

  <!-- EMPLOYEES -->
  <section id="page-employees" class="hidden">
    <div class="card">
      <div class="sectionTitle">员工名单（可搜索/过滤）</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>班次</th>
              <th>负责人</th>
              <th>现场培训组长</th>
              <th>线上组长</th>
              <th>线上培训</th>
              <th>团队（cột F）</th>
              <th>盘口</th>
              <th>工作内容</th>
              <th>岗位</th>
              <th>姓名</th>
              <th>国家</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody id="empTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ROSTER -->
  <section id="page-roster" class="hidden">
    <div class="card">
      <div class="sectionTitle">排版表（按岗位分组 → 再按班次 Day / Night / 中班）</div>
      <div class="sub">每个岗位下面会分 3 个班次块；点击人数可以弹窗看详细名单</div>
    </div>

    <div style="height:14px"></div>
    <div id="rosterBlocks"></div>
  </section>

</div>

<!-- MODAL (employee list) -->
<div id="modal" class="modal hidden">
  <div class="modalBox">
    <div class="modalTop">
      <div>
        <div class="modalTitle" id="modalTitle">员工名单</div>
        <div class="sub" id="modalSub"></div>
      </div>
      <button class="modalClose" id="modalClose">Close</button>
    </div>
    <div class="modalBody">
      <div class="modalFilters">
        <input id="modalSearch" class="input" placeholder="Search in modal..." style="min-width:260px" />
        <select id="modalShift">
          <option value="">All shifts</option>
          <option value="白班">白班</option>
          <option value="夜班">夜班</option>
          <option value="中班">中班</option>
          <option value="Day">Day</option>
          <option value="Night">Night</option>
          <option value="12:30">12:30</option>
        </select>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>班次</th>
              <th>负责人</th>
              <th>现场培训组长</th>
              <th>线上组长</th>
              <th>线上培训</th>
              <th>团队（cột F）</th>
              <th>岗位</th>
              <th>姓名</th>
              <th>ID</th>
              <th>国家</th>
              <th>盘口</th>
              <th>工作内容</th>
            </tr>
          </thead>
          <tbody id="modalTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  CONFIG (CHANGE ONLY THIS)
 *  =========================
 *  你给过 opensheet 链接（JSON），继续用:
 *  https://opensheet.elk.sh/<SPREADSHEET_ID>/<SHEET_TAB_NAME>
 */
const SHEET_API = "https://opensheet.elk.sh/1e38ZBHG0B0nxODaooPhgreG67A2RLxLxrpP8Sas_vZA/团队填表";
// 如果你要用“排版表”那个 sheet tab，把上面最后的 团队填表 改成 你的 sheet 名（例如：排版表）

/** =========================
 *  Column resolver (auto)
 *  ========================= */
const KEYMAP = {
  shift: ["班次","shift","Shift"],
  owner: ["负责人","負責人","owner"],
  onsiteLeader: ["现场培训组长","現场培训组长","现场培训","Onsite Leader"],
  onlineLeader: ["线上组长","线上组長","线上组长","Online Leader"],
  onlineTrainer: ["线上培训","線上培訓","Online Training"],
  // IMPORTANT: team must be cột F (你要求). 在你截图里 team/团队 是“组队/团队/团队统计/组别”之一
  team: ["团队","組隊","组队","组别","組別","团队统计","Team"],
  plate: ["盘口","盤口","plate"],
  work: ["工作内容","工作內容","work"],
  position: ["岗位","职位","職位","position","岗位种类"],
  name: ["姓名","名字","name","Name"],
  country: ["国家","國家","country","Country"],
  id: ["ID","Id","id","员工ID","员工编号","編號"]
};

function pickKey(obj, candidates){
  const keys = Object.keys(obj || {}).map(k=>k.trim());
  for(const c of candidates){
    const idx = keys.findIndex(k => k === c || k.replace(/\s+/g,"") === c.replace(/\s+/g,""));
    if(idx >= 0) return Object.keys(obj)[idx];
  }
  // fuzzy contains
  for(const c of candidates){
    const idx = keys.findIndex(k => k.includes(c) || k.replace(/\s+/g,"").includes(c.replace(/\s+/g,"")));
    if(idx >= 0) return Object.keys(obj)[idx];
  }
  return null;
}

function norm(v){
  return (v ?? "").toString().trim();
}

function normShift(v){
  const s = norm(v);
  if(!s) return "";
  // normalize to 3 buckets when possible
  if(/夜|Night/i.test(s)) return "夜班";
  if(/白|Day/i.test(s)) return "白班";
  if(/中|12:30/i.test(s)) return "中班";
  return s;
}

/** =========================
 *  State
 *  ========================= */
let RAW = [];
let ROWS = []; // normalized rows
let chartPos = null;
let chartTeam = null;

const el = (id)=>document.getElementById(id);

/** =========================
 *  Fetch + normalize
 *  ========================= */
async function loadData(){
  const r = await fetch(SHEET_API, {cache:"no-store"});
  if(!r.ok) throw new Error("Fetch failed: " + r.status);
  const data = await r.json();
  RAW = Array.isArray(data) ? data : [];
  // normalize columns by auto-matching headers
  ROWS = RAW.map(o=>{
    const kShift = pickKey(o, KEYMAP.shift);
    const kOwner = pickKey(o, KEYMAP.owner);
    const kOnsite = pickKey(o, KEYMAP.onsiteLeader);
    const kOnlineLead = pickKey(o, KEYMAP.onlineLeader);
    const kOnlineTrain = pickKey(o, KEYMAP.onlineTrainer);
    const kTeam = pickKey(o, KEYMAP.team); // IMPORTANT (team/cột F)
    const kPlate = pickKey(o, KEYMAP.plate);
    const kWork = pickKey(o, KEYMAP.work);
    const kPos = pickKey(o, KEYMAP.position);
    const kName = pickKey(o, KEYMAP.name);
    const kCountry = pickKey(o, KEYMAP.country);
    const kId = pickKey(o, KEYMAP.id);

    const row = {
      shift: normShift(o[kShift]),
      owner: norm(o[kOwner]),
      onsiteLeader: norm(o[kOnsite]),
      onlineLeader: norm(o[kOnlineLead]),
      onlineTrainer: norm(o[kOnlineTrain]),
      team: norm(o[kTeam]),
      plate: norm(o[kPlate]),
      work: norm(o[kWork]),
      position: norm(o[kPos]),
      name: norm(o[kName]),
      country: norm(o[kCountry]),
      id: norm(o[kId]),
      __raw: o
    };

    return row;
  });

  // remove empty rows (no name and no id)
  ROWS = ROWS.filter(r => r.name || r.id || r.team || r.position);

  // fill filters
  fillFilters();
}

/** =========================
 *  Dedup + metrics
 *  ========================= */
function personKey(r){
  // Prefer ID if exists; else fallback to a composite
  if(r.id) return "ID::" + r.id;
  // fallback: name + team + position (avoid duplicates)
  return "NK::" + [r.name, r.team, r.position, r.country].map(norm).join("|");
}

function dedupRows(rows){
  const map = new Map();
  for(const r of rows){
    // skip if ID empty AND name empty
    if(!r.id && !r.name) continue;
    const k = personKey(r);
    if(!map.has(k)) map.set(k, r);
  }
  return [...map.values()];
}

function countBy(rows, keyFn){
  const m = new Map();
  for(const r of rows){
    const k = keyFn(r);
    if(!k) continue;
    m.set(k, (m.get(k)||0)+1);
  }
  return m;
}

/** =========================
 *  Global filters (top)
 *  ========================= */
function applyGlobalFilters(rows){
  const q = norm(el("globalSearch").value).toLowerCase();
  const fShift = norm(el("filterShift").value);
  const fTeam = norm(el("filterTeam").value);
  const fPos = norm(el("filterPos").value);

  return rows.filter(r=>{
    if(fShift && normShift(r.shift) !== normShift(fShift)) return false;
    if(fTeam && r.team !== fTeam) return false;
    if(fPos && r.position !== fPos) return false;
    if(!q) return true;
    const hay = [r.name,r.id,r.team,r.position,r.country,r.owner,r.plate,r.work].join(" ").toLowerCase();
    return hay.includes(q);
  });
}

function fillFilters(){
  // Team
  const teams = [...new Set(ROWS.map(r=>r.team).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"zh"));
  const teamSel = el("filterTeam");
  teamSel.innerHTML = `<option value="">All teams</option>` + teams.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

  // Position
  const poss = [...new Set(ROWS.map(r=>r.position).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"zh"));
  const posSel = el("filterPos");
  posSel.innerHTML = `<option value="">All positions</option>` + poss.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
}

/** =========================
 *  Render: Dashboard
 *  ========================= */
function renderDashboard(){
  const filtered = applyGlobalFilters(ROWS);
  const uniquePeople = dedupRows(filtered);

  // KPIs
  const total = uniquePeople.length;
  el("kTotal").innerText = total.toLocaleString();

  const cs = uniquePeople.filter(r=>r.position==="客服").length;
  const wd = uniquePeople.filter(r=>r.position==="出款").length;
  const dp = uniquePeople.filter(r=>r.position==="查单").length;
  el("kCS").innerText = cs.toLocaleString();
  el("kWD").innerText = wd.toLocaleString();
  el("kDP").innerText = dp.toLocaleString();

  // Position distribution
  const posMap = countBy(uniquePeople, r=>r.position);
  const posEntries = [...posMap.entries()].sort((a,b)=>b[1]-a[1]);
  renderPosCards(posEntries, uniquePeople);
  renderPosChart(posEntries, uniquePeople);

  // Team distribution (IMPORTANT: team = cột F)
  const teamMap = countBy(uniquePeople, r=>r.team);
  const teamEntries = [...teamMap.entries()].sort((a,b)=>b[1]-a[1]);
  renderTeamChart(teamEntries, uniquePeople);

  // Team cards with per-position pills
  renderTeamCards(uniquePeople, teamEntries, posEntries.map(x=>x[0]).filter(Boolean));
}

function renderPosCards(posEntries, uniquePeople){
  const wrap = el("posCards");
  wrap.innerHTML = "";
  for(const [pos,cnt] of posEntries){
    if(!pos) continue;
    const card = document.createElement("div");
    card.className = "chipCard";
    card.innerHTML = `<div class="name">${escapeHtml(pos)}</div><div class="cnt">${cnt.toLocaleString()}</div>`;
    card.onclick = ()=> openModal({
      title:`${pos} 员工名单`,
      sub:`岗位：${pos}｜人数：${cnt}`,
      rows: uniquePeople.filter(r=>r.position===pos)
    });
    wrap.appendChild(card);
  }
}

function renderPosChart(posEntries, uniquePeople){
  const labels = posEntries.filter(x=>x[0]).map(x=>x[0]);
  const values = posEntries.filter(x=>x[0]).map(x=>x[1]);

  if(chartPos) chartPos.destroy();
  chartPos = new Chart(el("chartPosition"), {
    type:"doughnut",
    data:{
      labels,
      datasets:[{data:values}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:"top"},
        tooltip:{callbacks:{
          label:(ctx)=> `${ctx.label}: ${ctx.raw}`
        }}
      },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const pos = labels[idx];
        const rows = uniquePeople.filter(r=>r.position===pos);
        openModal({
          title:`${pos} 员工名单`,
          sub:`岗位：${pos}｜人数：${rows.length}`,
          rows
        });
      }
    }
  });
}

function renderTeamChart(teamEntries, uniquePeople){
  const labels = teamEntries.filter(x=>x[0]).map(x=>x[0]);
  const values = teamEntries.filter(x=>x[0]).map(x=>x[1]);

  if(chartTeam) chartTeam.destroy();
  chartTeam = new Chart(el("chartTeam"), {
    type:"bar",
    data:{
      labels,
      datasets:[{label:"人数", data:values}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:true}},
      scales:{
        x:{ticks:{autoSkip:true,maxRotation:60,minRotation:60}}
      },
      onClick:(evt, elements)=>{
        if(!elements?.length) return;
        const idx = elements[0].index;
        const team = labels[idx];
        const rows = uniquePeople.filter(r=>r.team===team);
        openModal({
          title:`${team} 员工名单`,
          sub:`团队（cột F）：${team}｜人数：${rows.length}`,
          rows
        });
      }
    }
  });
}

function renderTeamCards(uniquePeople, teamEntries, allPositions){
  const wrap = el("teamCards");
  wrap.innerHTML = "";

  for(const [team,total] of teamEntries){
    if(!team) continue;
    const rowsTeam = uniquePeople.filter(r=>r.team===team);

    // counts per position in this team
    const perPos = countBy(rowsTeam, r=>r.position);
    const perPosEntries = [...perPos.entries()].filter(x=>x[0]).sort((a,b)=>b[1]-a[1]);

    const card = document.createElement("div");
    card.className = "teamCard";
    card.innerHTML = `
      <div class="teamHead">
        <div class="teamName">${escapeHtml(team)}</div>
        <div class="sub">点击数字弹窗</div>
      </div>
      <div class="pillRow" id="pills-${cssSafe(team)}"></div>
    `;
    wrap.appendChild(card);

    const pillRow = card.querySelector(".pillRow");

    // Total pill
    const pTotal = document.createElement("div");
    pTotal.className = "pill gray";
    pTotal.innerText = `总人数 ${rowsTeam.length}`;
    pTotal.onclick = ()=> openModal({
      title:`${team} 员工名单`,
      sub:`团队（cột F）：${team}｜人数：${rowsTeam.length}`,
      rows: rowsTeam
    });
    pillRow.appendChild(pTotal);

    // each position pill
    for(const [pos,cnt] of perPosEntries){
      const p = document.createElement("div");
      p.className = "pill";
      p.innerText = `${pos} ${cnt}`;
      p.onclick = ()=> openModal({
        title:`${team} - ${pos} 员工名单`,
        sub:`团队：${team}｜岗位：${pos}｜人数：${cnt}`,
        rows: rowsTeam.filter(r=>r.position===pos)
      });
      pillRow.appendChild(p);
    }
  }
}

/** =========================
 *  Render: Employees tab
 *  ========================= */
function renderEmployees(){
  const filtered = applyGlobalFilters(ROWS);
  const uniquePeople = dedupRows(filtered);

  const tbody = el("empTbody");
  tbody.innerHTML = uniquePeople.map(r=>`
    <tr>
      <td>${escapeHtml(r.shift)}</td>
      <td>${escapeHtml(r.owner)}</td>
      <td>${escapeHtml(r.onsiteLeader)}</td>
      <td>${escapeHtml(r.onlineLeader)}</td>
      <td>${escapeHtml(r.onlineTrainer)}</td>
      <td><b>${escapeHtml(r.team)}</b></td>
      <td>${escapeHtml(r.plate)}</td>
      <td>${escapeHtml(r.work)}</td>
      <td>${escapeHtml(r.position)}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.country)}</td>
      <td><b>${escapeHtml(r.id)}</b></td>
    </tr>
  `).join("");
}

/** =========================
 *  Render: 排版表 (Roster)
 *  - Group by position
 *  - Show shift blocks (白班/夜班/中班)
 *  ========================= */
function renderRoster(){
  const filtered = applyGlobalFilters(ROWS);
  const uniquePeople = dedupRows(filtered);

  const posMap = new Map();
  for(const r of uniquePeople){
    const pos = r.position || "（未填写岗位）";
    if(!posMap.has(pos)) posMap.set(pos, []);
    posMap.get(pos).push(r);
  }

  const posEntries = [...posMap.entries()].sort((a,b)=> b[1].length - a[1].length);

  const root = el("rosterBlocks");
  root.innerHTML = "";

  for(const [pos, list] of posEntries){
    const day = list.filter(r=>normShift(r.shift)==="白班");
    const night = list.filter(r=>normShift(r.shift)==="夜班");
    const mid = list.filter(r=>normShift(r.shift)==="中班");

    const block = document.createElement("div");
    block.className = "posBlock";
    block.innerHTML = `
      <div class="posHeader">
        <div>${escapeHtml(pos)}</div>
        <div class="meta">总人数：${list.length}</div>
      </div>

      <div class="shiftGrid">
        <div class="shiftCard">
          <div class="sTitle">白班</div>
          <div class="sCount"><span class="pill" data-click="shift" data-pos="${escapeAttr(pos)}" data-shift="白班">人数 ${day.length}</span></div>
        </div>
        <div class="shiftCard">
          <div class="sTitle">夜班</div>
          <div class="sCount"><span class="pill" data-click="shift" data-pos="${escapeAttr(pos)}" data-shift="夜班">人数 ${night.length}</span></div>
        </div>
        <div class="shiftCard">
          <div class="sTitle">中班</div>
          <div class="sCount"><span class="pill" data-click="shift" data-pos="${escapeAttr(pos)}" data-shift="中班">人数 ${mid.length}</span></div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>班次</th><th>负责人</th><th>现场培训组长</th><th>线上组长</th><th>线上培训</th>
              <th>团队（cột F）</th><th>岗位</th><th>姓名</th><th>ID</th><th>国家</th><th>盘口</th><th>工作内容</th>
            </tr>
          </thead>
          <tbody>
            ${list
              .sort((a,b)=> (a.team||"").localeCompare(b.team||"","zh"))
              .slice(0, 18)
              .map(r=>rowHtml(r)).join("")}
            ${list.length>18 ? `<tr><td colspan="12" style="color:#64748b;font-weight:800">仅预览前 18 条，点击上面“人数”弹窗查看全部</td></tr>` : ""}
          </tbody>
        </table>
      </div>
    `;
    root.appendChild(block);
  }

  // bind shift pills
  root.querySelectorAll('[data-click="shift"]').forEach(node=>{
    node.addEventListener("click", ()=>{
      const pos = node.getAttribute("data-pos");
      const shift = node.getAttribute("data-shift");
      const rows = uniquePeople.filter(r => (r.position||"（未填写岗位）")===pos && normShift(r.shift)===shift);
      openModal({
        title:`${pos} - ${shift} 员工名单`,
        sub:`岗位：${pos}｜班次：${shift}｜人数：${rows.length}`,
        rows
      });
    });
  });
}

/** =========================
 *  Modal
 *  ========================= */
let MODAL_ROWS = [];

function openModal({title, sub, rows}){
  MODAL_ROWS = rows || [];
  el("modalTitle").innerText = title || "员工名单";
  el("modalSub").innerText = sub || "";
  el("modalSearch").value = "";
  el("modalShift").value = "";
  renderModalRows();
  el("modal").classList.remove("hidden");
}

function renderModalRows(){
  const q = norm(el("modalSearch").value).toLowerCase();
  const s = norm(el("modalShift").value);
  const rows = MODAL_ROWS.filter(r=>{
    if(s && normShift(r.shift)!==normShift(s)) return false;
    if(!q) return true;
    const hay = [r.shift,r.owner,r.onsiteLeader,r.onlineLeader,r.onlineTrainer,r.team,r.position,r.name,r.id,r.country,r.plate,r.work].join(" ").toLowerCase();
    return hay.includes(q);
  });

  el("modalTbody").innerHTML = rows.map(r=>rowHtml(r)).join("");
}

function rowHtml(r){
  return `
    <tr>
      <td>${escapeHtml(r.shift)}</td>
      <td>${escapeHtml(r.owner)}</td>
      <td>${escapeHtml(r.onsiteLeader)}</td>
      <td>${escapeHtml(r.onlineLeader)}</td>
      <td>${escapeHtml(r.onlineTrainer)}</td>
      <td><b>${escapeHtml(r.team)}</b></td>
      <td>${escapeHtml(r.position)}</td>
      <td>${escapeHtml(r.name)}</td>
      <td><b>${escapeHtml(r.id)}</b></td>
      <td>${escapeHtml(r.country)}</td>
      <td>${escapeHtml(r.plate)}</td>
      <td>${escapeHtml(r.work)}</td>
    </tr>
  `;
}

/** =========================
 *  Navigation
 *  ========================= */
function showPage(name){
  const pages = ["dashboard","employees","roster"];
  for(const p of pages){
    el(`page-${p}`).classList.toggle("hidden", p!==name);
  }
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.page===name);
  });
  // render on demand
  if(name==="dashboard") renderDashboard();
  if(name==="employees") renderEmployees();
  if(name==="roster") renderRoster();
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>showPage(t.dataset.page));
});

/** =========================
 *  Events
 *  ========================= */
el("modalClose").onclick = ()=> el("modal").classList.add("hidden");
el("modal").addEventListener("click", (e)=>{
  if(e.target === el("modal")) el("modal").classList.add("hidden");
});
el("modalSearch").addEventListener("input", renderModalRows);
el("modalShift").addEventListener("change", renderModalRows);

el("btnReload").onclick = async()=>{
  await boot();
};

["globalSearch","filterShift","filterTeam","filterPos"].forEach(id=>{
  el(id).addEventListener("input", ()=> {
    // rerender current page quickly
    const active = document.querySelector(".tab.active")?.dataset?.page || "dashboard";
    showPage(active);
  });
  el(id).addEventListener("change", ()=> {
    const active = document.querySelector(".tab.active")?.dataset?.page || "dashboard";
    showPage(active);
  });
});

/** =========================
 *  Utils
 *  ========================= */
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }
function cssSafe(s){ return (s??"").toString().replace(/[^a-zA-Z0-9_-]/g,"_"); }

/** =========================
 *  Boot
 *  ========================= */
async function boot(){
  // show skeleton values while loading
  el("kTotal").innerText = "-";
  el("kCS").innerText = "-";
  el("kWD").innerText = "-";
  el("kDP").innerText = "-";
  el("posCards").innerHTML = "";
  el("teamCards").innerHTML = "";
  el("empTbody").innerHTML = "";
  el("rosterBlocks").innerHTML = "";

  try{
    await loadData();
    showPage("dashboard");
  }catch(err){
    console.error(err);
    alert("Load failed. Please check SHEET_API and Sheet tab name.\n\n" + err.message);
  }
}

boot();
</script>

</body>
</html>
